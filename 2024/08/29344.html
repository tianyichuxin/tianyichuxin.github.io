<!DOCTYPE HTML>
<html lang="zh-CN">
<!-- 自动将http的不安全请求升级为https -->
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" />


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="node,nest">
    <meta name="description" content="专注于前端领域开发技术分享，深信任何可以用 JavaScript 来写的应用，最终都将用 JavaScript 来写">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Nestjs知识汇总 | 天弈初心</title>
    <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <link rel="stylesheet" type="text/css" href="/css/advertisement-space.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="天弈初心" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">天弈初心</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


    <div id="mobile-nav" class="side-nav sidenav">

        <div class="mobile-head bg-color">
            
                <img src="/medias/logo.png" class="logo-img circle responsive-img">
                
                    <div class="logo-name">
                        天弈初心
                    </div>
                    <div class="logo-desc">
                        
                            专注于前端领域开发技术分享，深信任何可以用 JavaScript 来写的应用，最终都将用 JavaScript 来写
                                
                    </div>
        </div>

        

            <ul class="menu-list mobile-menu-list">
                
                    <li class="m-nav-item">
                        
                            <a href="/" class="waves-effect waves-light">
                                
                                    <i class="fa-fw fas fa-home"></i>
                                    
                                            首页
                            </a>
                            
                    </li>
                    
                    <li class="m-nav-item">
                        
                            <a href="/tags" class="waves-effect waves-light">
                                
                                    <i class="fa-fw fas fa-tags"></i>
                                    
                                            标签
                            </a>
                            
                    </li>
                    
                    <li class="m-nav-item">
                        
                            <a href="/categories" class="waves-effect waves-light">
                                
                                    <i class="fa-fw fas fa-bookmark"></i>
                                    
                                            分类
                            </a>
                            
                    </li>
                    
                    <li class="m-nav-item">
                        
                            <a href="/archives" class="waves-effect waves-light">
                                
                                    <i class="fa-fw fas fa-archive"></i>
                                    
                                            归档
                            </a>
                            
                    </li>
                    
                    <li class="m-nav-item">
                        
                            <a href="/about" class="waves-effect waves-light">
                                
                                    <i class="fa-fw fas fa-user-circle"></i>
                                    
                                            关于
                            </a>
                            
                    </li>
                    
                    <li class="m-nav-item">
                        
                            <a href="/contact" class="waves-effect waves-light">
                                
                                    <i class="fa-fw fas fa-comments"></i>
                                    
                                            留言板
                            </a>
                            
                    </li>
                    
                    <li class="m-nav-item">
                        
                            <a href="/friends" class="waves-effect waves-light">
                                
                                    <i class="fa-fw fas fa-address-book"></i>
                                    
                                            友链
                            </a>
                            
                    </li>
                    
                        
                            <li>
                                <div class="divider"></div>
                            </li>
                            <li>
                                <a href="https://github.com/tianyichuxin/tianyichuxin.github.io" class="waves-effect waves-light" target="_blank">
                                    <i class="fab fa-github-square fa-fw"></i>
                                    Fork Me
                                </a>
                            </li>
                            
            </ul>
    </div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/tianyichuxin/tianyichuxin.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/11.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Nestjs知识汇总</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <!-- 内页 -->
<link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/node/">
                                <span class="chip bg-color">node</span>
                            </a>
                        
                            <a href="/tags/nest-js/">
                                <span class="chip bg-color">nest.js</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/node/" class="post-category">
                                node
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-08-13
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2025-03-12
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    28.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    131 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>Nest (NestJS) 是一个用于构建高效、可扩展的 Node.js 服务器端应用程序的开发框架。它利用 JavaScript 的渐进增强的能力，使用并完全支持 TypeScript （仍然允许开发者使用纯 JavaScript 进行开发），并结合了 OOP （面向对象编程）、FP （函数式编程）和 FRP （函数响应式编程）。</p>
</blockquote>
<ul>
<li>在底层，Nest 构建在强大的 HTTP 服务器框架上，例如 Express （默认），并且还可以通过配置从而使用 Fastify ！</li>
<li>Nest 在这些常见的 Node.js 框架 (Express/Fastify) 之上提高了一个抽象级别，但仍然向开发者直接暴露了底层框架的 API。这使得开发者可以自由地使用适用于底层平台的无数的第三方模块。</li>
</ul>
<p>本文基于nest8演示</p>
<h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><pre><code>$ npm i -g @nestjs/cli</code></pre><p><code>nest new project-name</code> 创建一个项目</p>
<pre><code>$ tree
.
├── README.md
├── nest-cli.json
├── package.json
├── src
│   ├── app.controller.spec.ts
│   ├── app.controller.ts
│   ├── app.module.ts
│   ├── app.service.ts
│   └── main.ts
├── test
│   ├── app.e2e-spec.ts
│   └── jest-e2e.json
├── tsconfig.build.json
└── tsconfig.json

2 directories, 12 files</code></pre><p><strong>以下是这些核心文件的简要概述</strong>：</p>
<ul>
<li><code>app.controller.ts</code> 带有单个路由的基本控制器示例。</li>
<li><code>app.module.ts</code> 应用程序的根模块。</li>
<li><code>main.ts</code> 应用程序入口文件。它使用 NestFactory 用来创建 Nest 应用实例。</li>
</ul>
<blockquote>
<p><code>main.ts</code> 包含一个异步函数，它负责引导我们的应用程序：</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> NestFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApplicationModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ApplicationModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li><code>NestFactory</code> 暴露了一些静态方法用于创建应用实例</li>
<li><code>create()</code> 方法返回一个实现 <code>INestApplication</code> 接口的对象, 并提供一组可用的方法</li>
</ul>
<blockquote>
<p><code>nest</code>有两个支持开箱即用的 HTTP 平台：<code>express</code> 和 <code>fastify</code>。 您可以选择最适合您需求的产品</p>
</blockquote>
<ul>
<li><code>platform-express</code> Express 是一个众所周知的 node.js 简约 Web 框架。 这是一个经过实战考验，适用于生产的库，拥有大量社区资源。 默认情况下使用 <code>@nestjs/platform-express</code> 包。 许多用户都可以使用 <code>Express</code> ，并且无需采取任何操作即可启用它。</li>
<li><code>platform-fastify</code> <code>Fastify</code> 是一个高性能，低开销的框架，专注于提供最高的效率和速度。</li>
</ul>
<h2 id="Nest控制器"><a href="#Nest控制器" class="headerlink" title="Nest控制器"></a>Nest控制器</h2><p>Nest中的控制器层负责处理传入的请求, 并返回对客户端的响应。</p>
<p><img src="//static.tianyichuxin.com/images/29344/1.png" alt=""></p>
<blockquote>
<p>控制器的目的是接收应用的特定请求。路由机制控制哪个控制器接收哪些请求。通常，每个控制器有多个路由，不同的路由可以执行不同的操作</p>
</blockquote>
<p><strong>通过NestCLi创建控制器：</strong></p>
<p><code>nest -h</code> 可以看到<code>nest</code>支持的命令</p>
<p><strong>常用命令：</strong></p>
<ul>
<li>创建控制器：<code>nest g co user module</code></li>
<li>创建服务：<code>nest g s user module</code></li>
<li>创建模块：<code>nest g mo user module</code></li>
<li>默认以src为根路径生成</li>
</ul>
<p><img src="//static.tianyichuxin.com/images/29344/2.png" alt=""></p>
<pre class=" language-bash"><code class="language-bash">nest g controller posts</code></pre>
<p>表示创建posts的控制器,这个时候会在src目录下面生成一个posts的文件夹，这个里面就是posts的控制器，代码如下</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Controller <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'posts'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PostsController</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span></code></pre>
<p>创建好控制器后，<code>nestjs</code>会自动的在 <code>app.module.ts</code> 中引入<code>PostsController</code>，代码如下</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/app.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostsController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./posts/posts.controller'</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppController<span class="token punctuation">,</span> PostsController<span class="token punctuation">]</span><span class="token punctuation">,</span>
    providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<h2 id="nest配置路由请求数据"><a href="#nest配置路由请求数据" class="headerlink" title="nest配置路由请求数据"></a>nest配置路由请求数据</h2><blockquote>
<p>Nestjs提供了其他HTTP请求方法的装饰器 <code>@Get()</code> <code>@Post()</code> <code>@Put()</code> 、 <code>@Delete()</code>、 <code>@Patch()</code>、 <code>@Options()</code>、 <code>@Head()</code>和 <code>@All()</code></p>
</blockquote>
<p>在Nestjs中获取<code>Get</code>传值或者<code>Post</code>提交的数据的话我们可以使用Nestjs中的装饰器来获取。</p>
<pre class=" language-js"><code class="language-js">@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  req
@<span class="token function">Response</span><span class="token punctuation">(</span><span class="token punctuation">)</span> res
@<span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> next
@<span class="token function">Session</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  req<span class="token punctuation">.</span>session
@<span class="token function">Param</span><span class="token punctuation">(</span>key<span class="token operator">?</span><span class="token punctuation">:</span> string<span class="token punctuation">)</span>    req<span class="token punctuation">.</span>params <span class="token operator">/</span> req<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
@<span class="token function">Body</span><span class="token punctuation">(</span>key<span class="token operator">?</span><span class="token punctuation">:</span> string<span class="token punctuation">)</span> req<span class="token punctuation">.</span>body <span class="token operator">/</span> req<span class="token punctuation">.</span>body<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
@<span class="token function">Query</span><span class="token punctuation">(</span>key<span class="token operator">?</span><span class="token punctuation">:</span> string<span class="token punctuation">)</span>    req<span class="token punctuation">.</span>query <span class="token operator">/</span> req<span class="token punctuation">.</span>query<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
@<span class="token function">Headers</span><span class="token punctuation">(</span>name<span class="token operator">?</span><span class="token punctuation">:</span> string<span class="token punctuation">)</span> req<span class="token punctuation">.</span>headers <span class="token operator">/</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span>name<span class="token punctuation">]</span></code></pre>
<p><strong>示例</strong></p>
<pre class=" language-js"><code class="language-js">@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'posts'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PostsController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly postsService<span class="token punctuation">:</span> PostsService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'create'</span><span class="token punctuation">)</span>
  <span class="token function">create</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> createPostDto<span class="token punctuation">:</span> CreatePostDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>createPostDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">)</span>
  <span class="token function">findAll</span><span class="token punctuation">(</span>@<span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  <span class="token function">findById</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Put</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  <span class="token function">update</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
    @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> updatePostDto<span class="token punctuation">:</span> UpdatePostDto<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> updatePostDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  <span class="token function">remove</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsService<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>注意</strong></p>
<ul>
<li><code>关于nest的return</code>： 当请求处理程序返回 JavaScript 对象或数组时，它将自动序列化为 JSON。但是，当它返回一个字符串时，Nest 将只发送一个字符串而不是序列化它</li>
</ul>
<h2 id="Nest服务"><a href="#Nest服务" class="headerlink" title="Nest服务"></a>Nest服务</h2><blockquote>
<p>Nestjs中的服务可以是<code>service</code> 也可以是<code>provider</code>。他们都可以<code>通过 constructor 注入依赖关系</code>。服务本质上就是通过<code>@Injectable()</code> 装饰器注解的类。在Nestjs中服务相当于<code>MVC</code>的<code>Model</code></p>
</blockquote>
<p><img src="//static.tianyichuxin.com/images/29344/3.png" alt=""></p>
<p><strong>创建服务</strong></p>
<pre class=" language-bash"><code class="language-bash">nest g <span class="token function">service</span> posts</code></pre>
<p>创建好服务后就可以在服务中定义对应的方法</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> HttpException<span class="token punctuation">,</span> HttpStatus<span class="token punctuation">,</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository<span class="token punctuation">,</span> Not<span class="token punctuation">,</span> Between<span class="token punctuation">,</span> Equal<span class="token punctuation">,</span> Like<span class="token punctuation">,</span> In <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> dayjs <span class="token keyword">from</span> <span class="token string">'dayjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreatePostDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dto/create-post.dto'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UpdatePostDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dto/update-post.dto'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostsEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/post.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostsRo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./interfaces/posts.interface'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PostsService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>PostsEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly postsRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>PostsEntity<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>post<span class="token punctuation">:</span> CreatePostDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> title <span class="token punctuation">}</span> <span class="token operator">=</span> post<span class="token punctuation">;</span>
    <span class="token keyword">const</span> doc <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> title <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'doc'</span><span class="token punctuation">,</span> doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>doc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token string">'文章标题已存在'</span><span class="token punctuation">,</span> HttpStatus<span class="token punctuation">.</span>BAD_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">:</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">,</span>
      message<span class="token punctuation">:</span> <span class="token string">'创建成功'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 分页查询列表</span>
  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span>query <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> pageSize<span class="token punctuation">,</span> pageNum<span class="token punctuation">,</span> orderBy<span class="token punctuation">,</span> sort<span class="token punctuation">,</span> <span class="token operator">...</span>params <span class="token punctuation">}</span> <span class="token operator">=</span> query<span class="token punctuation">;</span>
    orderBy <span class="token operator">=</span> query<span class="token punctuation">.</span>orderBy <span class="token operator">||</span> <span class="token string">'create_time'</span><span class="token punctuation">;</span>
    sort <span class="token operator">=</span> query<span class="token punctuation">.</span>sort <span class="token operator">||</span> <span class="token string">'DESC'</span><span class="token punctuation">;</span>
    pageSize <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>pageSize <span class="token operator">||</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pageNum <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>pageNum <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'query'</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> queryParams <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> any<span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        queryParams<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Like</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`%</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 所有字段支持模糊查询、%%之间不能有空格</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> qb <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// qb.where({ status: In([2, 3]) });</span>
    qb<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>queryParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// qb.select(['post.title', 'post.content']); // 查询部分字段返回</span>
    qb<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`post.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>orderBy<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> sort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    qb<span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>pageSize <span class="token operator">*</span> <span class="token punctuation">(</span>pageNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qb<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      list<span class="token punctuation">:</span> <span class="token keyword">await</span> qb<span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      totalNum<span class="token punctuation">:</span> <span class="token keyword">await</span> qb<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 按条件查询的数量</span>
      total<span class="token punctuation">:</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 总的数量</span>
      pageSize<span class="token punctuation">,</span>
      pageNum<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 根据ID查询详情</span>
  <span class="token keyword">async</span> <span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>PostsEntity<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 更新</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> string<span class="token punctuation">,</span> updatePostDto<span class="token punctuation">:</span> UpdatePostDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> existRecord <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>existRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`id为</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">的文章不存在`</span></span><span class="token punctuation">,</span> HttpStatus<span class="token punctuation">.</span>BAD_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// updatePostDto覆盖existRecord 合并，可以更新单个字段</span>
    <span class="token keyword">const</span> updatePost <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>existRecord<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>updatePostDto<span class="token punctuation">,</span>
      update_time<span class="token punctuation">:</span> <span class="token function">dayjs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD HH:mm:ss'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">:</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>updatePost<span class="token punctuation">)</span><span class="token punctuation">,</span>
      message<span class="token punctuation">:</span> <span class="token string">'更新成功'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 删除</span>
  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> existPost <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>existPost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`文章ID </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 不存在`</span></span><span class="token punctuation">,</span> HttpStatus<span class="token punctuation">.</span>BAD_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>existPost<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span>
      message<span class="token punctuation">:</span> <span class="token string">'删除成功'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="Nest模块"><a href="#Nest模块" class="headerlink" title="Nest模块"></a>Nest模块</h2><blockquote>
<p>模块是具有 <code>@Module()</code> 装饰器的类。 <code>@Module()</code> 装饰器提供了元数据，Nest 用它来组织应用程序结构</p>
</blockquote>
<p><img src="//static.tianyichuxin.com/images/29344/4.png" alt=""></p>
<blockquote>
<p>每个 Nest 应用程序至少有一个模块，即根模块。根模块是 Nest 开始安排应用程序树的地方。事实上，根模块可能是应用程序中唯一的模块，特别是当应用程序很小时，但是对于大型程序来说这是没有意义的。在大多数情况下，您将拥有多个模块，每个模块都有一组紧密相关的功能。</p>
</blockquote>
<p><strong>@module() 装饰器接受一个描述模块属性的对象：</strong></p>
<ul>
<li><code>providers</code> 由 Nest 注入器实例化的提供者，并且可以至少在整个模块中共享</li>
<li><code>controllers</code> 必须创建的一组控制器</li>
<li><code>imports</code> 导入模块的列表，这些模块导出了此模块中所需提供者</li>
<li><code>exports</code> 由本模块提供并应在其他模块中可用的提供者的子集</li>
</ul>
<pre class=" language-bash"><code class="language-bash">// 创建模块 posts
nest g module posts</code></pre>
<p><strong>Nestjs中的共享模块</strong></p>
<p>每个模块都是一个共享模块。一旦创建就能被任意模块重复使用。假设我们将在几个模块之间共享 PostsService 实例。 我们需要把 PostsService 放到 exports 数组中：</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// posts.modules.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostsController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./posts.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./posts.service'</span><span class="token punctuation">;</span>
@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>PostsController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>PostsService<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token punctuation">:</span> <span class="token punctuation">[</span>PostsService<span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 共享模块导出</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PostsModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<blockquote>
<p>可以使用 <code>nest g res posts</code> 一键创建以上需要的各个模块</p>
</blockquote>
<p><img src="//static.tianyichuxin.com/images/29344/5.png" alt=""></p>
<h2 id="配置静态资源"><a href="#配置静态资源" class="headerlink" title="配置静态资源"></a>配置静态资源</h2><p>NestJS中配置静态资源目录完整代码</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">npm</span> i @nestjs/platform-express -S</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> NestExpressApplication <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/platform-express'</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// main.ts</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 创建实例</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span>create<span class="token operator">&lt;</span>NestExpressApplication<span class="token operator">></span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment" spellcheck="true">//使用方式一</span>
  app<span class="token punctuation">.</span><span class="token function">useStaticAssets</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//配置静态资源目录</span>

  <span class="token comment" spellcheck="true">// 使用方式二：配置前缀目录 设置静态资源目录</span>
  app<span class="token punctuation">.</span><span class="token function">useStaticAssets</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../public'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 配置虚拟目录，比如我们想通过 http://localhost:3000/static/1.jpg 来访问public目录里面的文件</span>
    prefix<span class="token punctuation">:</span> <span class="token string">'/static/'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 设置虚拟路径</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 启动端口</span>
  <span class="token keyword">const</span> PORT <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>PORT <span class="token operator">||</span> <span class="token number">9000</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>PORT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
    Logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`服务已经启动 http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>PORT<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="配置模板引擎"><a href="#配置模板引擎" class="headerlink" title="配置模板引擎"></a>配置模板引擎</h2><pre class=" language-bash"><code class="language-bash"><span class="token function">npm</span> i ejs --save</code></pre>
<p>配置模板引擎</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// main.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NestFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">setBaseViewsDir</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'views'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 放视图的文件</span>
  app<span class="token punctuation">.</span><span class="token function">setViewEngine</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//模板渲染引擎</span>

  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>项目根目录新建<code>views</code>目录然后新建<code>根目录 -&gt; views -&gt; default -&gt; index.ejs</code></p>
<pre class=" language-ejs"><code class="language-ejs"><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="天弈初心" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>
<body>
   <h3>模板引擎</h3>
    <%=message%>
</body>
</html></code></pre>
<p><strong>渲染页面</strong></p>
<p>Nestjs中 <code>Render</code>装饰器可以渲染模板，<strong>使用路由匹配渲染引擎</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> Render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppController</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Render</span><span class="token punctuation">(</span><span class="token string">'default/index'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//使用render渲染模板引擎，参数就是文件路径：default文件夹下的index.ejs</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> any <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>message<span class="token punctuation">:</span> <span class="token string">"hello word"</span><span class="token punctuation">}</span>   <span class="token comment" spellcheck="true">//只有返回参数在模板才能获取，如果不传递参数，必须返回一个空对象</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="Cookie的使用"><a href="#Cookie的使用" class="headerlink" title="Cookie的使用"></a>Cookie的使用</h2><blockquote>
<p>cookie和session的使用<strong>依赖</strong>于当前使用的平台，如：express和fastify<br>两种的使用方式不同，这里主要记录基于<strong>express</strong>平台的用法</p>
</blockquote>
<p>cookie可以用来存储用户信息，存储购物车等信息，在实际项目中用的非常多</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">npm</span> instlal cookie-parser --save <span class="token function">npm</span> i -D @types/cookie-parser --save</code></pre>
<p>引入注册</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// main.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> AppModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NestExpressApplication <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/platform-express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> cookieParser <span class="token keyword">from</span> <span class="token string">'cookie-parser'</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span>create<span class="token operator">&lt;</span>NestExpressApplication<span class="token operator">></span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">//注册cookie</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token string">'dafgafa'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//加密密码</span>

  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>接口中设置cookie 使用response</strong></p>
<p>请求该接口，响应一个cookie</p>
<pre class=" language-js"><code class="language-js">@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">index</span><span class="token punctuation">(</span>@<span class="token function">Response</span><span class="token punctuation">(</span><span class="token punctuation">)</span> res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//设置cookie, signed:true加密</span>
    <span class="token comment" spellcheck="true">//参数：1：key, 2:value, 3:配置</span>
    res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'poetry'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>maxAge<span class="token punctuation">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> signed<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">//注意：</span>
    <span class="token comment" spellcheck="true">//使用res后，返回数据必须使用res</span>
    <span class="token comment" spellcheck="true">//如果是用了render模板渲染，还是使用return</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>xxx<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>cookie相关配置参数</strong></p>
<ul>
<li><code>domain</code> String 指定域名下有效</li>
<li><code>expires</code> Date 过期时间(秒),设置在某个时间点后会在该<code>cookoe</code>后失效</li>
<li><code>httpOnly</code> Boolean 默认为<code>false</code> 如果为<code>true</code>表示不允许客户端(通过<code>js</code>来获取<code>cookie</code>)</li>
<li><code>maxAge</code> String 最大失效时间(毫秒),设置在多少时间后失效</li>
<li><code>path</code> String 表示<code>cookie</code>影响到的路径,如:<code>path=/</code>如果路径不能匹配的时候,浏览器则不发送这个<code>cookie</code></li>
<li><code>secure</code> Boolean 当 <code>secure</code> 值为 <code>true</code> 时,<code>cookie</code> 在 HTTP 中是无效,在 <code>HTTPS</code> 中才有效</li>
<li><code>signed</code> Boolean 表示是否签名<code>cookie</code>,如果设置为<code>true</code>的时候表示对这个<code>cookie</code>签名了,这样就需要用<code>res.signedCookies()</code>获取值<code>cookie</code>不是使用<code>res.cookies()</code>了</li>
</ul>
<p><strong>获取cookie</strong></p>
<pre class=" language-js"><code class="language-js">@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">index</span><span class="token punctuation">(</span>@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>username<span class="token punctuation">)</span>

      <span class="token comment" spellcheck="true">//加密的cookie获取方式</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>signedCookies<span class="token punctuation">.</span>username<span class="token punctuation">)</span>  
      <span class="token keyword">return</span> req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>username
<span class="token punctuation">}</span></code></pre>
<p><strong>Cookie加密</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 配置中间件的时候需要传参</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token string">'123456'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 设置cookie的时候配置signed属性</span>
res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'userinfo'</span><span class="token punctuation">,</span><span class="token string">'hahaha'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>domain<span class="token punctuation">:</span><span class="token string">'.ccc.com'</span><span class="token punctuation">,</span>maxAge<span class="token punctuation">:</span><span class="token number">900000</span><span class="token punctuation">,</span>httpOnly<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>signed<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// signedCookies调用设置的cookie</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>signedCookies<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="Session的使用"><a href="#Session的使用" class="headerlink" title="Session的使用"></a>Session的使用</h2><ul>
<li><code>session</code>是另一种记录客户状态的机制，不同的是Cookie保存在客户端浏览器中，而<code>session</code>保存在服务器上</li>
<li>当浏览器访问服务器并发送第一次请求时，服务器端会创建一个session对象，生成一个类似于key,value的键值对， 然后将key(cookie)返回到浏览器(客户)端，浏览器下次再访问时，携带key(cookie)，找到对应的session(value)。 客户的信息都保存在session中</li>
</ul>
<p><strong>安装 express-session</strong></p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">npm</span> i express-session --save
<span class="token function">npm</span> i -D @types/express-session --save</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// main.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> AppModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NestExpressApplication <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/platform-express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> session <span class="token keyword">from</span> <span class="token string">'express-seesion'</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span>create<span class="token operator">&lt;</span>NestExpressApplication<span class="token operator">></span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">//配置session</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token punctuation">:</span> <span class="token string">'dmyxs'</span><span class="token punctuation">,</span>
      cookie<span class="token punctuation">:</span> <span class="token punctuation">{</span> maxAge<span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span> httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//以cookie存储到客户端</span>
      rolling<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">//每次重新请求时，重新设置cookie</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>session相关配置参数</strong></p>
<ul>
<li><code>secret</code> String 生成<code>session</code>签名的密钥</li>
<li><code>name</code> String 客户端的<code>cookie</code>的名称，默认为<code>connect.sid</code>, 可自己设置</li>
<li><code>resave</code> Boolean 强制保存 <code>session</code> 即使它并没有变化, 默认为<code>true</code>, 建议设置成<code>false</code></li>
<li><code>saveUninitalized</code> Boolean 强制将未初始化的 <code>session</code> 存储。当新建了一个 <code>session</code> 且未设定属性或值时，它就处于 未初始化状态。在设定一个 <code>cookie</code> 前，这对于登录验证，减轻服务端存储压力，权限控制是有帮助的。默认:<code>true</code>, 建议手动添加</li>
<li><code>cookie</code> Object 设置返回到前端<code>cookie</code>属性，默认值为<code>{ path: ‘/’, httpOnly: true, secure: false, maxAge: null }</code>。</li>
<li><code>rolling</code> Boolean 在每次请求时强行设置 <code>cookie</code>，这将重置 <code>cookie</code> 过期时间, 默认为<code>false</code></li>
</ul>
<p><strong>接口中设置session</strong></p>
<pre class=" language-js"><code class="language-js">@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">index</span><span class="token punctuation">(</span>@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//设置session</span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">'poetry'</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>获取session</strong></p>
<pre class=" language-js"><code class="language-js">@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/session'</span><span class="token punctuation">)</span>
  <span class="token function">session</span><span class="token punctuation">(</span>@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token punctuation">,</span> @<span class="token function">Session</span><span class="token punctuation">(</span><span class="token punctuation">)</span> session <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//获取session：两种方式</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>username<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token string">'hello session'</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="跨域，前缀路径、网站安全、请求限速"><a href="#跨域，前缀路径、网站安全、请求限速" class="headerlink" title="跨域，前缀路径、网站安全、请求限速"></a>跨域，前缀路径、网站安全、请求限速</h2><p><strong>跨域，路径前缀，网络安全</strong></p>
<pre class=" language-bash"><code class="language-bash">yarn add helmet csurf</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// main.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> NestFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Logger<span class="token punctuation">,</span> ValidationPipe <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> helmet <span class="token keyword">from</span> <span class="token string">'helmet'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> csurf <span class="token keyword">from</span> <span class="token string">'csurf'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> AppModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> PORT <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>PORT <span class="token operator">||</span> <span class="token number">8000</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 路径前缀：如：http://www.test.com/api/v1/user</span>
  app<span class="token punctuation">.</span><span class="token function">setGlobalPrefix</span><span class="token punctuation">(</span><span class="token string">'api/v1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">//cors：跨域资源共享，方式一：允许跨站访问</span>
  app<span class="token punctuation">.</span><span class="token function">enableCors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 方式二：const app = await NestFactory.create(AppModule, { cors: true });</span>

  <span class="token comment" spellcheck="true">//防止跨站脚本攻击</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">helmet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">//CSRF保护：跨站点请求伪造</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">csurf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>PORT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    Logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token string">`服务已经启动,接口请访问:localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>PORT<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>PREFIX<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>限速：限制客户端在一定时间内的请求次数</strong></p>
<pre class=" language-bash"><code class="language-bash">yarn add @nestjs/throttler</code></pre>
<blockquote>
<p>在需要使用的模块引入使用，这里是<strong>全局</strong>使用，在<code>app.module.ts</code>中引入。这里设置的是：<strong>1分钟内只能请求10次，超过则报status为429的错误</strong></p>
</blockquote>
<pre class=" language-js"><code class="language-js">app<span class="token punctuation">.</span>module<span class="token punctuation">.</span>ts

<span class="token keyword">import</span> <span class="token punctuation">{</span> APP_GUARD <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./modules/user/user.module'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//引入</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ThrottlerModule<span class="token punctuation">,</span> ThrottlerGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/throttler'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      UserModule<span class="token punctuation">,</span>
    ThrottlerModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      ttl<span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//1分钟</span>
      limit<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//请求10次</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">//全局使用</span>
    <span class="token punctuation">{</span>
      provide<span class="token punctuation">:</span> APP_GUARD<span class="token punctuation">,</span>
      useClass<span class="token punctuation">:</span> ThrottlerGuard<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></code></pre>
<h2 id="管道、守卫、拦截器、过滤器、中间件"><a href="#管道、守卫、拦截器、过滤器、中间件" class="headerlink" title="管道、守卫、拦截器、过滤器、中间件"></a>管道、守卫、拦截器、过滤器、中间件</h2><ul>
<li><strong>管道</strong>：数据处理与转换，数据验证</li>
<li><strong>守卫</strong>：验证用户登录，保护路由</li>
<li><strong>拦截器</strong>：对请求响应进行拦截，统一响应内容</li>
<li><strong>过滤器</strong>：异常捕获</li>
<li><strong>中间件</strong>：日志打印</li>
</ul>
<blockquote>
<p>执行顺序（时机）</p>
</blockquote>
<p>从客户端发送一个post请求，路径为：<code>/user/login</code>，请求参数为：<code>{userinfo: ‘xx’,password: ‘xx’}</code>，到服务器接收请求内容，触发绑定的函数并且执行相关逻辑完毕，然后返回内容给客户端的整个过程大体上要经过如下几个步骤：</p>
<p><img src="//static.tianyichuxin.com/images/29344/6.png" alt=""></p>
<blockquote>
<p>全局使用: 管道 - 守卫 - 拦截器 - 过滤器 - 中间件。统一在main.ts文件中使用，全局生效</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> NestFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ParseIntPipe <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpExceptionFilter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./common/filters/http-exception.filter'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LoggerMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./common/middleware/logger.middleware'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./common/guard/auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthInterceptor <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./common/interceptors/auth.interceptor'</span><span class="token punctuation">;</span>


<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">//全局使用管道：这里使用的是内置，也可以使用自定义管道，在下文</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalPipes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">//全局使用中间件</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>LoggerMiddleware<span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">//全局使用过滤器</span>
  <span class="token comment" spellcheck="true">//这里使用的是自定义过滤器，先别管，先学会怎么在全局使用</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalFilters</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpExceptionFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

  <span class="token comment" spellcheck="true">//全局使用守卫</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalGuards</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AuthGuard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">//全局使用拦截器</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalInterceptors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AuthInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h3><p>常用内置管道，从<code>@nestjs/common</code>导出</p>
<ul>
<li><code>ParseIntPipe</code>：将字符串数字转数字</li>
<li><code>ValidationPipe</code>：验证管道</li>
</ul>
<blockquote>
<p>局部使用管道</p>
</blockquote>
<ul>
<li>匹配整个路径，使用UsePipes</li>
<li>只匹配某个接口，使用UsePipes</li>
<li>在获取参数时匹配，一般使用内置管道</li>
</ul>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Put<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  UsePipes<span class="token punctuation">,</span>
  ParseIntPipe
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> myPipe <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../common/pipes/user.pipe'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
@<span class="token function">UsePipes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">myPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//局部方式1：匹配整个/user， get请求和put请求都会命中</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  <span class="token function">getUserById</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//局部方式3：只匹配/user的get请求，使用的是内置管道</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Put</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">UsePipes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">myPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//局部方式2：只匹配/user的put请求</span>
  <span class="token function">updateUser</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">,</span> @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      user<span class="token punctuation">,</span>
      id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p>自定义管道</p>
</blockquote>
<p>使用快捷命令生成：<code>nest g pi myPipe common/pipes</code></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  ArgumentMetadata<span class="token punctuation">,</span>
  Injectable<span class="token punctuation">,</span>
  PipeTransform<span class="token punctuation">,</span>
  BadRequestException<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//自定义管道必须实现自PipeTransform，固定写法，该接口有一个transform方法</span>
<span class="token comment" spellcheck="true">//transform参数：</span>
<span class="token comment" spellcheck="true">//value：使用myPipe时所传递的值，可以是param传递的的查询路径参数，可以是body的请求体</span>
<span class="token comment" spellcheck="true">//metadata：元数据，可以用它判断是来自param或body或query</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">myPipe</span> <span class="token keyword">implements</span> <span class="token class-name">PipeTransform</span><span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> string<span class="token punctuation">,</span> metadata<span class="token punctuation">:</span> ArgumentMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'body'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'来自请求体'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'param'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'来自查询路径'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//如果不是传递一个数字，抛出错误</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNaN</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span><span class="token string">'Validation failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="守卫"><a href="#守卫" class="headerlink" title="守卫"></a>守卫</h3><blockquote>
<p>自定义守卫</p>
</blockquote>
<p>使用快捷命令生成：<code>nest g gu myGuard common/guards</code></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> CanActivate<span class="token punctuation">,</span> ExecutionContext<span class="token punctuation">,</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Reflector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//反射器，作用与自定义装饰器桥接，获取数据</span>

<span class="token comment" spellcheck="true">//自定义守卫必须CanActivate，固定写法，该接口只有一个canActivate方法</span>
<span class="token comment" spellcheck="true">//canActivate参数：</span>
<span class="token comment" spellcheck="true">//context：请求的(Response/Request)的引用</span>
<span class="token comment" spellcheck="true">//通过守卫返回true，否则返回false，返回403状态码</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthGuard</span> <span class="token keyword">implements</span> <span class="token class-name">CanActivate</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly reflector<span class="token punctuation">:</span> Reflector<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 白名单数组</span>
  <span class="token keyword">private</span> whiteUrlList<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'/user'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 验证该次请求是否为白名单内的路由</span>
  <span class="token keyword">private</span> <span class="token function">isWhiteUrl</span><span class="token punctuation">(</span>urlList<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>urlList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">canActivate</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> ExecutionContext<span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 获取请求对象</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//console.log('request', request.headers);</span>
    <span class="token comment" spellcheck="true">//console.log('request', request.params);</span>
    <span class="token comment" spellcheck="true">//console.log('request', request.query);</span>
    <span class="token comment" spellcheck="true">//console.log('request', request.url);</span>

    <span class="token comment" spellcheck="true">// 用法一：验证是否是白名单内的路由</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isWhiteUrl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>whiteUrlList<span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 用法二：使用反射器，配合装饰器使用，获取装饰器传递过来的数据</span>
    <span class="token keyword">const</span> roles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reflector<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token operator">&lt;</span>string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token string">'roles'</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//console.log(roles); // [ 'admin' ]</span>
    <span class="token comment" spellcheck="true">//http://localhost:3000/user/9?user=admin，如果与装饰器传递过来的值匹配则通过，否则不通过</span>
    <span class="token comment" spellcheck="true">//真实开发中可能从cookie或token中获取值</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>roles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 其他用法</span>
    <span class="token comment" spellcheck="true">// 获取请求头中的token字段</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">switchToRpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>headers<span class="token punctuation">.</span>token<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// console.log('token', token);</span>

    <span class="token comment" spellcheck="true">// 获取session</span>
    <span class="token keyword">const</span> userinfo <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>session<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// console.log('session', userinfo);</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p>局部使用守卫</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Delete<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  UsePipes<span class="token punctuation">,</span>
  UseGuards<span class="token punctuation">,</span>
  ParseIntPipe<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../common/guard/auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Role <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../common/decorator/role.decorator'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//自定义装饰器</span>

@<span class="token function">UseGuards</span><span class="token punctuation">(</span>AuthGuard<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//局部使用守卫，守卫整个user路径</span>
@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  <span class="token function">getUserById</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">Role</span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//使用自定义装饰器，传入角色，必须是admin才能删除</span>
  <span class="token function">removeUser</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h3><p>自定义守卫中使用到了自定义装饰器</p>
<pre class=" language-bash"><code class="language-bash">nest g d role common/decorator</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//这是快捷生成的代码</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> SetMetadata <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//SetMetadata作用：将获取到的值，设置到元数据中，然后守卫通过反射器才能获取到值</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Roles <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>roles<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">SetMetadata</span><span class="token punctuation">(</span><span class="token string">'roles'</span><span class="token punctuation">,</span> roles<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h3><p>使用快捷命令生成：<code>nest g in auth common/intercepters</code></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  CallHandler<span class="token punctuation">,</span>
  ExecutionContext<span class="token punctuation">,</span>
  Injectable<span class="token punctuation">,</span>
  NestInterceptor<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> map <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//自定义拦截器必须实现自NestInterceptor，固定写法，该接口只有一个intercept方法</span>
<span class="token comment" spellcheck="true">//intercept参数：</span>
<span class="token comment" spellcheck="true">//context：请求上下文，可以拿到的Response和Request</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">NestInterceptor</span> <span class="token punctuation">{</span>
  <span class="token function">intercept</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> ExecutionContext<span class="token punctuation">,</span> next<span class="token punctuation">:</span> CallHandler<span class="token punctuation">)</span><span class="token punctuation">:</span> Observable<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'拦截器'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'全局响应拦截器方法返回内容后...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          status<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
          timestamp<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          path<span class="token punctuation">:</span> request<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
          message<span class="token punctuation">:</span> <span class="token string">'请求成功'</span><span class="token punctuation">,</span>
          data<span class="token punctuation">:</span> data<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><blockquote>
<p>局部使用过滤器</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  UseFilters<span class="token punctuation">,</span>
  HttpException<span class="token punctuation">,</span>
  HttpStatus<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpExceptionFilter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../common/filters/http-exception.filter'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//局部使用过滤器</span>
@<span class="token function">UseFilters</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpExceptionFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionController</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">getUserById</span><span class="token punctuation">(</span>@<span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          status<span class="token punctuation">:</span> HttpStatus<span class="token punctuation">.</span>BAD_REQUEST<span class="token punctuation">,</span>
          message<span class="token punctuation">:</span> <span class="token string">'请求参数id 必传'</span><span class="token punctuation">,</span>
          error<span class="token punctuation">:</span> <span class="token string">'id is required'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        HttpStatus<span class="token punctuation">.</span>BAD_REQUEST<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">'hello error'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>自定义过滤器</strong></p>
<p>使用快捷命令生成：<code>nest g f myFilter common/filters</code></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  ArgumentsHost<span class="token punctuation">,</span>
  Catch<span class="token punctuation">,</span>
  ExceptionFilter<span class="token punctuation">,</span>
  HttpException<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//必须实现至ExceptionFilter，固定写法，该接口只有一个catch方法</span>
<span class="token comment" spellcheck="true">//catch方法参数：</span>
<span class="token comment" spellcheck="true">//exception：当前正在处理的异常对象</span>
<span class="token comment" spellcheck="true">//host：传递给原始处理程序的参数的一个包装(Response/Request)的引用</span>
@<span class="token function">Catch</span><span class="token punctuation">(</span>HttpException<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HttpExceptionFilter</span> <span class="token keyword">implements</span> <span class="token class-name">ExceptionFilter</span><span class="token operator">&lt;</span>HttpException<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">catch</span><span class="token punctuation">(</span>exception<span class="token punctuation">:</span> HttpException<span class="token punctuation">,</span> host<span class="token punctuation">:</span> ArgumentsHost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> host<span class="token punctuation">.</span><span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> status <span class="token operator">=</span> exception<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取状态码</span>
    <span class="token keyword">const</span> exceptionRes<span class="token punctuation">:</span> any <span class="token operator">=</span> exception<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取响应对象</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> error<span class="token punctuation">,</span> message <span class="token punctuation">}</span> <span class="token operator">=</span> exceptionRes<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//自定义的异常响应内容</span>
    <span class="token keyword">const</span> msgLog <span class="token operator">=</span> <span class="token punctuation">{</span>
      status<span class="token punctuation">,</span>
      timestamp<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      path<span class="token punctuation">:</span> request<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      error<span class="token punctuation">,</span>
      message<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>msgLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3><blockquote>
<p>局部使用中间件</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Module<span class="token punctuation">,</span> MiddlewareConsumer<span class="token punctuation">,</span> RequestMethod <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LoggerMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./common/middleware/logger.middlerware'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./modules/user/user.module'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token punctuation">:</span><span class="token punctuation">[</span> UserModule <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span>
  <span class="token function">configure</span><span class="token punctuation">(</span>consumer<span class="token punctuation">:</span> MiddlewareConsumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    consumer
      <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>LoggerMiddleware<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//应用中间件</span>
      <span class="token punctuation">.</span><span class="token function">exclude</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span> method<span class="token punctuation">:</span> RequestMethod<span class="token punctuation">.</span>POST <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//排除user的post方法</span>
      <span class="token punctuation">.</span><span class="token function">forRoutes</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//监听路径  参数：路径名或*，*是匹配所以的路由</span>
      <span class="token comment" spellcheck="true">// .forRoutes({ path: 'user', method: RequestMethod.POST }, { path: 'album', method: RequestMethod.ALL }); //多个</span>
     <span class="token comment" spellcheck="true">// .apply(UserMiddleware) //支持多个中间件</span>
     <span class="token comment" spellcheck="true">// .forRoutes('user')</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>自定义中间件</strong></p>
<pre class=" language-bash"><code class="language-bash">nest g mi logger common/middleware</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> NestMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Request<span class="token punctuation">,</span> Response <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LoggerMiddleware</span> <span class="token keyword">implements</span> <span class="token class-name">NestMiddleware</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">//req：请求参数</span>
  <span class="token comment" spellcheck="true">//res：响应参数</span>
  <span class="token comment" spellcheck="true">//next：执行下一个中件间</span>
  <span class="token function">use</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> res<span class="token punctuation">:</span> Response<span class="token punctuation">,</span> next<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> method<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>函数式中间件</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 函数式中间件-应用于全局</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">logger</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// main.ts</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 创建实例</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span>create<span class="token operator">&lt;</span>NestExpressApplication<span class="token operator">></span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 设置全局日志函数中间件</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="一例看懂中间件、守卫、管道、异常过滤器、拦截器"><a href="#一例看懂中间件、守卫、管道、异常过滤器、拦截器" class="headerlink" title="一例看懂中间件、守卫、管道、异常过滤器、拦截器"></a>一例看懂中间件、守卫、管道、异常过滤器、拦截器</h2><blockquote>
<p>从客户端发送一个post请求，路径为：<code>/user/login</code>，请求参数为：<code>{userinfo: ‘xx’,password: ‘xx’}</code>，到服务器接收请求内容，触发绑定的函数并且执行相关逻辑完毕，然后返回内容给客户端的整个过程大体上要经过如下几个步骤：`</p>
</blockquote>
<p><img src="//static.tianyichuxin.com/images/29344/7.png" alt=""></p>
<p>项目需要包支持：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save rxjs xml2js class-validator class-transformer</code></pre>
<ul>
<li><code>rxjs</code> 针对JavaScript的反应式扩展,支持更多的转换运算</li>
<li><code>xml2js</code> 转换xml内容变成json格式</li>
<li><code>class-validator</code>、<code>class-transformer</code> 管道验证包和转换器</li>
</ul>
<p>建立user模块：模块内容结构：</p>
<pre><code>nest g res user</code></pre><p><img src="//static.tianyichuxin.com/images/29344/8.png" alt=""></p>
<p>user.controller.ts文件</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  Body
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserLoginDTO <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dto/user.login.dto'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly userService<span class="token punctuation">:</span> UserService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>
  <span class="token function">loginIn</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> userlogindto<span class="token punctuation">:</span> UserLoginDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> userlogindto<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>user.module.ts文件</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.service'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>UserController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>UserService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p>user.service.ts文件</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p>user.login.dto.ts文件</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// user / dto / user.login.dto.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> IsNotIn<span class="token punctuation">,</span> MinLength <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserLoginDTO</span><span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">/* 
  * 账号
  */</span>
  @<span class="token function">IsNotIn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">,</span>undefined<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">{</span>message<span class="token punctuation">:</span> <span class="token string">'账号不能为空'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* 
  * 密码
  */</span>
  @<span class="token function">MinLength</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> <span class="token string">'密码长度不能小于6位数'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>app.module.ts文件</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 子模块加载</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user/user.module'</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    UserModule
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<blockquote>
<p>新建common文件夹里面分别建立对应的文件夹以及文件：<br>中间件(middleware) — xml.middleware.ts<br>守卫(guard) — auth.guard.ts<br>管道(pipe) — validation.pipe.ts<br>异常过滤器(filters) — http-exception.filter.ts<br>拦截器(interceptor) — response.interceptor.ts</p>
</blockquote>
<p><img src="//static.tianyichuxin.com/images/29344/9.png" alt=""></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// main.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> NestFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> ValidationPipe <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./common/pipe/validation.pipe'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpExceptionFilter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./common/filters/http-exception.filter'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> XMLMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./common/middleware/xml.middleware'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./common/guard/auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ResponseInterceptor <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./common/interceptor/response.interceptor'</span><span class="token punctuation">;</span>


<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 全局注册通用验证管道ValidationPipe</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalPipes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 全局注册通用异常过滤器HttpExceptionFilter</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalFilters</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpExceptionFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 全局注册xml支持中间件(这里必须调用.use才能够注册)</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">XMLMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>use<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 全局注册权限验证守卫</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalGuards</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AuthGuard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 全局注册响应拦截器</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalInterceptors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResponseInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="中间件是请求的第一道关卡"><a href="#中间件是请求的第一道关卡" class="headerlink" title="中间件是请求的第一道关卡"></a>中间件是请求的第一道关卡</h3><ol>
<li>执行任何代码。</li>
<li>对请求和响应对象进行更改。</li>
<li>结束请求-响应周期。</li>
<li>调用堆栈中的下一个中间件函数。</li>
<li>如果当前的中间件函数没有结束请求-响应周期, 它必须调用 next() 将控制传递给下一个中间件函数。否则, 请求将被挂起</li>
</ol>
<p>本例中：使用中间件让express支持xml请求并且将xml内容转换为json数组</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// common/middleware/xml.middleware.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> NestMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Request<span class="token punctuation">,</span> Response <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> xml2js <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xml2js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">xml2js<span class="token punctuation">.</span>Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">XMLMiddleware</span> <span class="token keyword">implements</span> <span class="token class-name">NestMiddleware</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 参数是固定的Request/Response/next,</span>
  <span class="token comment" spellcheck="true">// Request/Response/next对应请求体和响应体和下一步函数</span>
  <span class="token function">use</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> res<span class="token punctuation">:</span> Response<span class="token punctuation">,</span> next<span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'进入全局xml中间件...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 获取express原生请求对象req,找到其请求头内容，如果包含application/xml，则执行转换</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'application/xml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 监听data方法获取到对应的参数数据(这里的方法是express的原生方法)</span>
      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> mreq <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 使用xml2js对xml数据进行转换</span>
        parser<span class="token punctuation">.</span><span class="token function">parseString</span><span class="token punctuation">(</span>mreq<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// 将转换后的数据放入到请求对象的req中</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parseString转换后的数据'</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment" spellcheck="true">// 这里之后可以根据需要对result做一些补充完善</span>
          req<span class="token punctuation">[</span><span class="token string">'body'</span><span class="token punctuation">]</span><span class="token operator">=</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 调用next方法进入到下一个中间件或者路由</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>注册方式</strong></p>
<ul>
<li>全局注册：在<code>main.ts</code>中导入需要的中间件模块如：XMLMiddleware然后使用 <code>app.use(new XMLMiddleware().use)</code>即可</li>
<li>模块注册：在对应的模块中注册如：<code>user.module.ts</code></li>
</ul>
<p><img src="//static.tianyichuxin.com/images/29344/10.png" alt=""></p>
<blockquote>
<p>同一路由注册多个中间件的执行顺序为，先是全局中间件执行，然后是模块中间件执行，模块中的中间件顺序按照<code>.apply</code>中注册的顺序执行</p>
</blockquote>
<h3 id="守卫是第二道关卡"><a href="#守卫是第二道关卡" class="headerlink" title="守卫是第二道关卡"></a>守卫是第二道关卡</h3><blockquote>
<p>守卫控制一些权限内容，如：一些接口需要带上token标记，才能够调用，守卫则是对这个标记进行验证操作的。<br>本例中代码如下：</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// common/guard/auth.guard.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>Injectable<span class="token punctuation">,</span>CanActivate<span class="token punctuation">,</span>HttpException<span class="token punctuation">,</span>HttpStatus<span class="token punctuation">,</span>ExecutionContext<span class="token punctuation">,</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthGuard</span> <span class="token keyword">implements</span> <span class="token class-name">CanActivate</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// context 请求的(Response/Request)的引用</span>
  <span class="token keyword">async</span> <span class="token function">canActivate</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> ExecutionContext<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>boolean<span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'进入全局权限守卫...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 获取请求对象</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 获取请求头中的token字段</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">switchToRpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>headers<span class="token punctuation">.</span>token<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 如果白名单内的路由就不拦截直接通过</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasUrl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>urlList<span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 验证token的合理性以及根据token做出相应的操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 这里可以添加验证逻辑</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span>
          <span class="token string">'没有授权访问,请先登录'</span><span class="token punctuation">,</span>
          HttpStatus<span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span>
        <span class="token string">'没有授权访问,请先登录'</span><span class="token punctuation">,</span>
        HttpStatus<span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 白名单数组</span>
  <span class="token keyword">private</span> urlList<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'/user/login'</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 验证该次请求是否为白名单内的路由</span>
  <span class="token keyword">private</span> <span class="token function">hasUrl</span><span class="token punctuation">(</span>urlList<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">let</span> flag<span class="token punctuation">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>urlList<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p><strong>注册方式</strong></p>
<ul>
<li>全局注册：在<code>main.ts</code>中导入需要的守卫模块如：<code>AuthGuard</code>。然后使用 <code>app.useGlobalGuards(new AuthGuard())</code> 即可</li>
<li>模块注册：在需要注册的<code>controller</code>控制器中导入<code>AuthGuard</code>。然后从<code>@nestjs/common</code>中导<code>UseGuards</code>装饰器。最后直接放置在对应的<code>@Controller()</code>或者<code>@Post/@Get…</code>等装饰器之下即可</li>
</ul>
<p><img src="//static.tianyichuxin.com/images/29344/11.png" alt=""></p>
<blockquote>
<p>同一路由注册多个守卫的执行顺序为，先是全局守卫执行，然后是模块中守卫执行</p>
</blockquote>
<h3 id="拦截器是第三道关卡"><a href="#拦截器是第三道关卡" class="headerlink" title="拦截器是第三道关卡"></a>拦截器是第三道关卡</h3><p>想到自定义返回内容如</p>
<pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"statusCode"</span><span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
    <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2022-05-14T08:06:45.265Z"</span><span class="token punctuation">,</span>
    <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/user/login"</span><span class="token punctuation">,</span>
    <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"请求失败"</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"isNotIn"</span><span class="token operator">:</span> <span class="token string">"账号不能为空"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>这个时候就可以使用拦截器来做一下处理了。<br><strong>拦截器作用：</strong></p>
<ol>
<li>在函数执行之前/之后绑定额外的逻辑</li>
<li>转换从函数返回的结果</li>
<li>转换从函数抛出的异常</li>
<li>扩展基本函数行为</li>
<li>根据所选条件完全重写函数 (例如, 缓存目的)</li>
</ol>
<p><strong>拦截器的执行顺序分为两个部分：</strong></p>
<ul>
<li>第一个部分在管道和自定义逻辑(next.handle()方法)之前。</li>
<li>第二个部分在管道和自定义逻辑(next.handle()方法)之后。</li>
</ul>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// common/interceptor/response.interceptor.ts</span>

<span class="token comment" spellcheck="true">/* 
 * 全局响应拦截器，统一返回体内容
 *
*/</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Injectable<span class="token punctuation">,</span>
  NestInterceptor<span class="token punctuation">,</span>
  CallHandler<span class="token punctuation">,</span>
  ExecutionContext<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> map <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 返回体结构</span>
<span class="token keyword">interface</span> <span class="token class-name">Response</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
  data<span class="token punctuation">:</span> T<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ResponseInterceptor</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">NestInterceptor</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Response<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token function">intercept</span><span class="token punctuation">(</span>
    context<span class="token punctuation">:</span> ExecutionContext<span class="token punctuation">,</span>
    next<span class="token punctuation">:</span> CallHandler<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Observable<span class="token operator">&lt;</span>Response<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 解析ExecutionContext的数据内容获取到请求体</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 实现数据的遍历与转变</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'进入全局响应拦截器...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">map</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'全局响应拦截器方法返回内容后...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          statusCode<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          timestamp<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          path<span class="token punctuation">:</span> request<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
          message<span class="token punctuation">:</span> <span class="token string">'请求成功'</span><span class="token punctuation">,</span>
          data<span class="token punctuation">:</span>data
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><img src="//static.tianyichuxin.com/images/29344/12.png" alt=""></p>
<blockquote>
<p>中间多了个全局管道以及自定义逻辑，即只有路由绑定的函数有正确的返回值之后才会有<code>next.handle()</code>之后的内容</p>
</blockquote>
<p><strong>注册方式</strong></p>
<ul>
<li>全局注册：在<code>main.ts</code>中导入需要的模块如：<code>ResponseInterceptor</code>。然后使用 <code>app.useGlobalInterceptors(new ResponseInterceptor())</code>即可</li>
<li>模块注册：在需要注册的<code>controller</code>控制器中导入<code>ResponseInterceptor</code>。然后从<code>@nestjs/common</code>中导入<code>UseInterceptors</code>装饰器。最后直接放置在对应的<code>@Controller()</code>或者<code>@Post/@Get</code>…等装饰器之下即可</li>
</ul>
<p><img src="//static.tianyichuxin.com/images/29344/13.png" alt=""></p>
<blockquote>
<p>同一路由注册多个拦截器时候，优先执行模块中绑定的拦截器，然后其拦截器转换的内容将作为全局拦截器的内容，即包裹两次返回内容如：</p>
</blockquote>
<pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span> // 全局拦截器效果
    <span class="token property">"statusCode"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2022-05-14T08:20:06.159Z"</span><span class="token punctuation">,</span>
    <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/user/login"</span><span class="token punctuation">,</span>
    <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"请求成功"</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"pagenum"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> // 模块中拦截器包裹效果
        “pageSize"<span class="token operator">:</span> <span class="token number">10</span>
        <span class="token property">"list"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="管道是第四道关卡"><a href="#管道是第四道关卡" class="headerlink" title="管道是第四道关卡"></a>管道是第四道关卡</h3><ul>
<li>管道是请求过程中的第四个内容，主要用于对请求参数的验证和转换操作。</li>
<li>项目中使用<code>class-validator</code> <code>class-transformer</code>进行配合验证相关的输入操作内容</li>
</ul>
<p><strong>认识官方的三个内置管道</strong></p>
<ol>
<li><code>ValidationPipe</code>：基于<code>class-validator</code>和<code>class-transformer</code>这两个npm包编写的一个常规的验证管道，可以从<code>class-validator</code>导入配置规则，然后直接使用验证(当前不需要了解<code>ValidationPipe</code>的原理，只需要知道从<code>class-validator</code>引规则，设定到对应字段，然后使用<code>ValidationPipe</code>即可)</li>
<li><code>ParseIntPipe</code>：转换传入的参数为数字</li>
</ol>
<p><img src="//static.tianyichuxin.com/images/29344/14.png" alt=""></p>
<p>如：传递过来的是/test?id=‘123’”这里会将字符串‘123’转换成数字123</p>
<ol>
<li><strong>ParseUUIDPipe</strong>：验证字符串是否是 UUID(通用唯一识别码)</li>
</ol>
<p><img src="//static.tianyichuxin.com/images/29344/15.png" alt=""></p>
<p>如：传递过来的是/test?id=‘xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx’”这里会验证格式是否正确，不正确则抛出错误，否则调用findOne方法</p>
<p>本例中管道使用如下：</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// common/pipe/validation.pipe.ts</span>

<span class="token comment" spellcheck="true">/* 
 * 全局dto验证管道
 *
*/</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> validate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> plainToClass <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-transformer'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PipeTransform<span class="token punctuation">,</span> Injectable<span class="token punctuation">,</span> ArgumentMetadata<span class="token punctuation">,</span> BadRequestException <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ValidationPipe</span> <span class="token keyword">implements</span> <span class="token class-name">PipeTransform</span><span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// value 是当前处理的参数，而 metatype 是属性的元类型</span>
  <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> any<span class="token punctuation">,</span> <span class="token punctuation">{</span> metatype <span class="token punctuation">}</span><span class="token punctuation">:</span> ArgumentMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'进入全局管道...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>metatype <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toValidate</span><span class="token punctuation">(</span>metatype<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// plainToClass方法将普通的javascript对象转换为特定类的实例</span>
    <span class="token keyword">const</span> object <span class="token operator">=</span> <span class="token function">plainToClass</span><span class="token punctuation">(</span>metatype<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 验证该对象返回出错的数组</span>
    <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">validate</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 将错误信息数组中的第一个内容返回给异常过滤器</span>
      <span class="token keyword">let</span> errormsg <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>constraints<span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span>errormsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// 验证属性值的元类型是否是String, Boolean, Number, Array, Object中的一种</span>
  <span class="token keyword">private</span> <span class="token function">toValidate</span><span class="token punctuation">(</span>metatype<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">const</span> types<span class="token punctuation">:</span> Function<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>String<span class="token punctuation">,</span> Boolean<span class="token punctuation">,</span> Number<span class="token punctuation">,</span> Array<span class="token punctuation">,</span> Object<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>metatype<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p><strong>注册方式</strong></p>
<ul>
<li>全局注册：在<code>main.ts</code>中导入需要的模块如：<code>ValidationPipe</code>；然后使用 <code>app.useGlobalPipes(new ValidationPipe())</code> 即可</li>
<li>模块注册：在需要注册的<code>controller</code>控制器中导入<code>ValidationPipe</code>；然后从<code>@nestjs/common</code>中导入<code>UsePipes</code>装饰器；最后直接放置在对应的<code>@Controller()</code>或者<code>@Post/@Get…</code>等装饰器之下即可，管道还允许注册在相关的参数上如：<code>@Body/@Query…</code>等</li>
</ul>
<p><img src="//static.tianyichuxin.com/images/29344/16.png" alt=""></p>
<blockquote>
<p><strong>注意：</strong>同一路由注册多个管道的时候，优先执行全局管道，然后再执行模块管道：</p>
</blockquote>
<ul>
<li>异常过滤器是所有抛出的异常的统一处理方案</li>
<li>简单来讲就是捕获系统抛出的所有异常，然后自定义修改异常内容，抛出友好的提示。</li>
</ul>
<p><strong>内置异常类</strong></p>
<blockquote>
<p>系统提供了不少内置的系统异常类，需要的时候直接使用throw new XXX(描述,状态)这样的方式即可抛出对应的异常,一旦抛出异常，当前请求将会终止。</p>
</blockquote>
<p><strong>注意每个异常抛出的状态码有所不同</strong>。如：</p>
<pre class=" language-bash"><code class="language-bash">BadRequestException — 400
UnauthorizedException — 401
ForbiddenException — 403
NotFoundException — 404
NotAcceptableException — 406
RequestTimeoutException — 408
ConflictException — 409
GoneException — 410
PayloadTooLargeException — 413
UnsupportedMediaTypeException — 415
UnprocessableEntityException — 422
InternalServerErrorException — 500
NotImplementedException — 501
BadGatewayException — 502
ServiceUnavailableException — 503
GatewayTimeoutException — 504</code></pre>
<p>本例中使用的是自定义的异常类，代码如下：</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// common/filters/http-exception.filter.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ExceptionFilter<span class="token punctuation">,</span> Catch<span class="token punctuation">,</span> ArgumentsHost<span class="token punctuation">,</span> HttpException<span class="token punctuation">,</span>Logger<span class="token punctuation">,</span>HttpStatus <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Request<span class="token punctuation">,</span> Response <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

@<span class="token function">Catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HttpExceptionFilter</span> <span class="token keyword">implements</span> <span class="token class-name">ExceptionFilter</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// exception 当前正在处理的异常对象</span>
  <span class="token comment" spellcheck="true">// host 是传递给原始处理程序的参数的一个包装(Response/Request)的引用</span>
  <span class="token keyword">catch</span><span class="token punctuation">(</span>exception<span class="token punctuation">:</span> HttpException<span class="token punctuation">,</span> host<span class="token punctuation">:</span> ArgumentsHost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'进入全局异常过滤器...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> host<span class="token punctuation">.</span><span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> ctx<span class="token punctuation">.</span>getResponse<span class="token operator">&lt;</span>Response<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> ctx<span class="token punctuation">.</span>getRequest<span class="token operator">&lt;</span>Request<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// HttpException 属于基础异常类，可自定义内容</span>
    <span class="token comment" spellcheck="true">// 如果是自定义的异常类则抛出自定义的status </span>
    <span class="token comment" spellcheck="true">// 否则就是内置HTTP异常类，然后抛出其对应的内置Status内容</span>
    <span class="token keyword">const</span> status <span class="token operator">=</span>
      exception <span class="token keyword">instanceof</span> <span class="token class-name">HttpException</span>
        <span class="token operator">?</span> exception<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> HttpStatus<span class="token punctuation">.</span>INTERNAL_SERVER_ERROR<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 抛出错误信息</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span>
      exception<span class="token punctuation">.</span>message <span class="token operator">||</span>
      exception<span class="token punctuation">.</span>message<span class="token punctuation">.</span>message <span class="token operator">||</span>
      exception<span class="token punctuation">.</span>message<span class="token punctuation">.</span>error <span class="token operator">||</span>
      <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> msgLog <span class="token operator">=</span> <span class="token punctuation">{</span>
      statusCode<span class="token punctuation">:</span> status<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 系统错误状态</span>
      timestamp<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 错误日期</span>
      path<span class="token punctuation">:</span> request<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 错误路由</span>
      message<span class="token punctuation">:</span> <span class="token string">'请求失败'</span><span class="token punctuation">,</span> 
      data<span class="token punctuation">:</span> message <span class="token comment" spellcheck="true">// 错误消息内容体(争取和拦截器中定义的响应体一样)</span>
    <span class="token punctuation">}</span>
     <span class="token comment" spellcheck="true">// 打印错误综合日志</span>
     Logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
      <span class="token string">'错误信息'</span><span class="token punctuation">,</span>
      JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>msgLog<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'HttpExceptionFilter'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    response
      <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>msgLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>注册方式</strong></p>
<ul>
<li>全局注册：在<code>main.ts</code>中导入需要的模块如：<code>HttpExceptionFilter</code> 然后使用 <code>app.useGlobalFilters(new HttpExceptionFilter())</code> 即可</li>
<li>模块注册：在需要注册的<code>controller</code>控制器中导入<code>HttpExceptionFilter</code>然后从<code>@nestjs/common</code>中导入<code>UseFilters</code>装饰器；最后直接放置在对应的<code>@Controller()</code>或者<code>@Post/@Get…</code>等装饰器之下即可</li>
</ul>
<p><img src="//static.tianyichuxin.com/images/29344/17.png" alt=""></p>
<blockquote>
<p><strong>注意：</strong> 同一路由注册多个管道的时候，只会执行一个异常过滤器，优先执行模块中绑定的异常过滤器，如果模块中无绑定异常过滤则执行全局异常过滤器</p>
</blockquote>
<h2 id="数据验证"><a href="#数据验证" class="headerlink" title="数据验证"></a>数据验证</h2><p>如何 限制 和 验证 前端传递过来的数据？</p>
<p>常用：<code>dto</code>（data transfer object数据传输对象） + <code>class-validator</code>，自定义提示内容，还能集成swagger</p>
<p><strong>class-validator的验证项装饰器</strong></p>
<p><a href="https://github.com/typestack/class-validator#usage" target="_blank" rel="noopener">https://github.com/typestack/class-validator#usage</a></p>
<pre class=" language-js"><code class="language-js">@<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//可选的</span>
@<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> ‘不能为空’ <span class="token punctuation">}</span><span class="token punctuation">)</span>
@<span class="token function">MinLength</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>message<span class="token punctuation">:</span> ‘密码长度不能小于<span class="token number">6</span>位’<span class="token punctuation">}</span><span class="token punctuation">)</span>
@<span class="token function">MaxLength</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>message<span class="token punctuation">:</span> ‘密码长度不能超过<span class="token number">20</span>位’<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<pre class=" language-js"><code class="language-js">@<span class="token function">IsEmail</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> ‘邮箱格式错误’ <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//邮箱</span>
@<span class="token function">IsMobilePhone</span><span class="token punctuation">(</span>‘zh<span class="token operator">-</span>CN’<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> ‘手机号码格式错误’ <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//手机号码</span>
@<span class="token function">IsEnum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>message<span class="token punctuation">:</span> ‘只能传入数字<span class="token number">0</span>或<span class="token number">1</span>’<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//枚举</span></code></pre>
<pre class=" language-js"><code class="language-js">@<span class="token function">ValidateIf</span><span class="token punctuation">(</span>o <span class="token operator">=</span><span class="token operator">></span> o<span class="token punctuation">.</span>username <span class="token operator">===</span> ‘admin’<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//条件判断，条件满足才验证，如：这里是传入的username是admin才验证</span></code></pre>
<pre class=" language-bash"><code class="language-bash">yarn add class-validator class-transformer</code></pre>
<p>全局使用内置管道<code>ValidationPipe</code> ，不然会报错，无法起作用</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> NestFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Logger<span class="token punctuation">,</span> ValidationPipe <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalPipes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//全局内置管道</span>
  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>编写<code>dto</code>，使用<code>class-validator</code>的校验项验证</p>
<p>创建DTO：只需要用户名，密码即可，两种都不能为空</p>
<blockquote>
<p>可以使用<code>nest g res user</code>一键创建带有dto的接口模块</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> IsNotEmpty<span class="token punctuation">,</span> MinLength<span class="token punctuation">,</span> MaxLength <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CreateUserDto</span> <span class="token punctuation">{</span>
  @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'用户名不能为空'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'密码不能为空'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">MinLength</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> <span class="token string">'密码长度不能小于6位'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">MaxLength</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> <span class="token string">'密码长度不能超过20位'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>修改DTO：用户名，密码，手机号码，邮箱，性别，状态，都是<strong>可选的</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  IsEnum<span class="token punctuation">,</span>
  MinLength<span class="token punctuation">,</span>
  MaxLength<span class="token punctuation">,</span>
  IsOptional<span class="token punctuation">,</span>
  IsEmail<span class="token punctuation">,</span>
  IsMobilePhone<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Type <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-transformer'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UpdateUserDto</span> <span class="token punctuation">{</span>
  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">MinLength</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> <span class="token string">'密码长度不能小于6位'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">MaxLength</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> <span class="token string">'密码长度不能超过20位'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">IsEmail</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'邮箱格式错误'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  email<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">IsMobilePhone</span><span class="token punctuation">(</span><span class="token string">'zh-CN'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'手机号码格式错误'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  mobile<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">IsEnum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'male'</span><span class="token punctuation">,</span> <span class="token string">'female'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> <span class="token string">'gender只能传入字符串male或female'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  gender<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">IsEnum</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 禁用<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 可用<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> <span class="token string">'status只能传入数字0或1'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Number<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//如果传递的是string类型，不报错，自动转成number类型</span>
  status<span class="token punctuation">:</span> number<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><code>controller</code>和<code>service</code>一起使用</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// user.controller.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  HttpCode<span class="token punctuation">,</span>
  HttpStatus<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreateUserDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dto/create-user.dto'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly userService<span class="token punctuation">:</span> UserService<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">HttpCode</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">:</span> CreateUserDto<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//使用创建dto</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Patch</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> string<span class="token punctuation">,</span> @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">:</span> UpdateUserDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//使用更新dto</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// user.service.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ToolsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../utils/tools.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreateUserDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dto/create-user.dto'</span><span class="token punctuation">;</span>


@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> CreateUserDto<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//使用dto</span>
    <span class="token keyword">do</span> some thing<span class="token operator">...</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><img src="//static.tianyichuxin.com/images/29344/18.png" alt=""><br><img src="//static.tianyichuxin.com/images/29344/19.png" alt=""></p>
<h1 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h1><h2 id="配置抽离"><a href="#配置抽离" class="headerlink" title="配置抽离"></a>配置抽离</h2><pre class=" language-bash"><code class="language-bash">yarn add nestjs-config</code></pre>
<pre class=" language-js"><code class="language-js">app<span class="token punctuation">.</span>module<span class="token punctuation">.</span>ts

<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> path <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//数据库</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TypeOrmModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//全局配置</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigModule<span class="token punctuation">,</span> ConfigService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'nestjs-config'</span><span class="token punctuation">;</span>


@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment" spellcheck="true">//1.配置config目录</span>
    ConfigModule<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'**/!(*.d).{ts,js}'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  

    <span class="token comment" spellcheck="true">//2.读取配置，这里读取的是数据库配置</span>
    TypeOrmModule<span class="token punctuation">.</span><span class="token function">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      useFactory<span class="token punctuation">:</span> <span class="token punctuation">(</span>config<span class="token punctuation">:</span> ConfigService<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'database'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
      inject<span class="token punctuation">:</span> <span class="token punctuation">[</span>ConfigService<span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 获取服务注入</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p><strong>配置数据库</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//src -> config -> database</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
  host<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
  port<span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
  username<span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
  password<span class="token punctuation">:</span> <span class="token string">'your password'</span><span class="token punctuation">,</span>
  database<span class="token punctuation">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
  entities<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> <span class="token string">'**/**.entity{.ts,.js}'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  synchronize<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><pre class=" language-bash"><code class="language-bash">yarn add cross-env</code></pre>
<p>cross-env的作用是兼容window系统和mac系统来设置环境变量</p>
<p><strong>在package.json中配置</strong></p>
<pre class=" language-json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"start:dev"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=development nest start --watch"</span><span class="token punctuation">,</span>
    <span class="token property">"start:debug"</span><span class="token operator">:</span> <span class="token string">"nest start --debug --watch"</span><span class="token punctuation">,</span>
    <span class="token property">"start:prod"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=production node dist/main"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre>
<p><strong>dotenv的使用</strong></p>
<pre class=" language-bash"><code class="language-bash">yarn add dotenv</code></pre>
<p><strong>根目录创建 env.parse.ts</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> path <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> dotenv <span class="token keyword">from</span> <span class="token string">'dotenv'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> localEnv <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'.env.local'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> prodEnv <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'.env.prod'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> filePath <span class="token operator">=</span> isProd <span class="token operator">&amp;&amp;</span> fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>prodEnv<span class="token punctuation">)</span> <span class="token operator">?</span> prodEnv <span class="token punctuation">:</span> localEnv<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 配置 通过process.env.xx读取变量</span>
dotenv<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token punctuation">:</span> filePath <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>导入环境</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// main.ts</span>
<span class="token keyword">import</span> <span class="token string">'../env.parse'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 导入环境变量</span></code></pre>
<p><code>.env.local</code></p>
<pre class=" language-bash"><code class="language-bash">PORT<span class="token operator">=</span>9000
MYSQL_HOST<span class="token operator">=</span>127.0.0.1
MYSQL_PORT<span class="token operator">=</span>3306
MYSQL_USER<span class="token operator">=</span>root
MYSQL_PASSWORD<span class="token operator">=</span>123
MYSQL_DATABASE<span class="token operator">=</span>test</code></pre>
<p><code>.env.prod</code></p>
<pre class=" language-bash"><code class="language-bash">PORT<span class="token operator">=</span>9000
MYSQL_HOST<span class="token operator">=</span>127.0.0.1
MYSQL_PORT<span class="token operator">=</span>3306
MYSQL_USER<span class="token operator">=</span>root
MYSQL_PASSWORD<span class="token operator">=</span>1234
MYSQL_DATABASE<span class="token operator">=</span>test</code></pre>
<p>读取环境变量 <code>process.env.MYSQL_HOST</code>形式</p>
<h2 id="文件上传与下载"><a href="#文件上传与下载" class="headerlink" title="文件上传与下载"></a>文件上传与下载</h2><pre class=" language-bash"><code class="language-bash">yarn add @nestjs/platform-express compressing

compressing 文件下载依赖，提供流的方式</code></pre>
<p>配置文件的目录地址，以及文件的名字格式</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/config/file.ts 上传文件配置</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> diskStorage <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'multer'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 上传文件配置
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  root<span class="token punctuation">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../assets/uploads'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  storage<span class="token punctuation">:</span> <span class="token function">diskStorage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    destination<span class="token punctuation">:</span> <span class="token function">join</span><span class="token punctuation">(</span>
      __dirname<span class="token punctuation">,</span>
      <span class="token template-string"><span class="token string">`../../assets/uploads/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token punctuation">:</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> file<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token punctuation">.</span>mimetype<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// app.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigModule<span class="token punctuation">,</span> ConfigService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'nestjs-config'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment" spellcheck="true">// 加载配置文件目录 src/config</span>
    ConfigModule<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'**/!(*.d).{ts,js}'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token keyword">implements</span> <span class="token class-name">NestModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// upload.controller.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  UseInterceptors<span class="token punctuation">,</span>
  UploadedFile<span class="token punctuation">,</span>
  UploadedFiles<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  Res<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FileInterceptor<span class="token punctuation">,</span> FilesInterceptor <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/platform-express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FileUploadDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dto/upload-file.dto'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UploadService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./upload.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Response <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'common'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UploadController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly uploadService<span class="token punctuation">:</span> UploadService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'upload'</span><span class="token punctuation">)</span>
  @<span class="token function">UseInterceptors</span><span class="token punctuation">(</span><span class="token function">FileInterceptor</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">uploadFile</span><span class="token punctuation">(</span>@<span class="token function">UploadedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uploadService<span class="token punctuation">.</span><span class="token function">uploadSingleFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 多文件上传</span>
  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'uploads'</span><span class="token punctuation">)</span>
  @<span class="token function">UseInterceptors</span><span class="token punctuation">(</span><span class="token function">FilesInterceptor</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">uploadMuliFile</span><span class="token punctuation">(</span>@<span class="token function">UploadedFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> files<span class="token punctuation">,</span> @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uploadService<span class="token punctuation">.</span><span class="token function">UploadMuliFile</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'export'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">downloadAll</span><span class="token punctuation">(</span>@<span class="token function">Res</span><span class="token punctuation">(</span><span class="token punctuation">)</span> res<span class="token punctuation">:</span> Response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> filename<span class="token punctuation">,</span> tarStream <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadService<span class="token punctuation">.</span><span class="token function">downloadAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/octet-stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Disposition'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`attachment; filename=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tarStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// upload.service.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> HttpException<span class="token punctuation">,</span> HttpStatus <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createWriteStream <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> tar <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'compressing'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'nestjs-config'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UploadService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly configService<span class="token punctuation">:</span> ConfigService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">uploadSingleFile</span><span class="token punctuation">(</span>file<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">UploadMuliFile</span><span class="token punctuation">(</span>files<span class="token punctuation">:</span> any<span class="token punctuation">,</span> body<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">,</span> files<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">downloadAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> uploadDir <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configService<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>root<span class="token punctuation">;</span>
    <span class="token keyword">const</span> tarStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">tar<span class="token punctuation">.</span>Stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> tarStream<span class="token punctuation">.</span><span class="token function">addEntry</span><span class="token punctuation">(</span>uploadDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> filename<span class="token punctuation">:</span> <span class="token string">'download.tar'</span><span class="token punctuation">,</span> tarStream <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// upload.module.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MulterModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/platform-express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'nestjs-config'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UploadService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./upload.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UploadController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./upload.controller'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    MulterModule<span class="token punctuation">.</span><span class="token function">registerAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      useFactory<span class="token punctuation">:</span> <span class="token punctuation">(</span>config<span class="token punctuation">:</span> ConfigService<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      inject<span class="token punctuation">:</span> <span class="token punctuation">[</span>ConfigService<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>UploadController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>UploadService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UploadModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<h2 id="实现图片随机验证码"><a href="#实现图片随机验证码" class="headerlink" title="实现图片随机验证码"></a>实现图片随机验证码</h2><p>nest如何实现图片随机验证码？</p>
<p><img src="//static.tianyichuxin.com/images/29344/20.png" alt=""></p>
<p>这里使用的是<strong>svg-captcha</strong>这个库，你也可以使用其他的库</p>
<pre class=" language-bash"><code class="language-bash">yarn add svg-captcha</code></pre>
<p><strong>封装，以便多次调用</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//src -> utils -> tools.service.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> svgCaptcha <span class="token keyword">from</span> <span class="token string">'svg-captcha'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ToolsService</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">captche</span><span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> captcha <span class="token operator">=</span> svgCaptcha<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//可配置返回的图片信息</span>
      size<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//生成几个验证码</span>
      fontSize<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//文字大小</span>
      width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//宽度</span>
      height<span class="token punctuation">:</span> <span class="token number">34</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//高度</span>
      background<span class="token punctuation">:</span> <span class="token string">'#cc9966'</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//背景颜色</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> captcha<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>在使用的module中引入</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ToolsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../utils/tools.service'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>UserController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>UserService<span class="token punctuation">,</span> ToolsService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></code></pre>
<p><strong>使用</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> Post，Body <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EmailService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./email.service'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly toolsService<span class="token punctuation">:</span> ToolsService<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">//注入服务</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'authcode'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//当请求该接口时，返回一张随机图片验证码</span>
  <span class="token keyword">async</span> <span class="token function">getCode</span><span class="token punctuation">(</span>@<span class="token function">Req</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token punctuation">,</span> @<span class="token function">Res</span><span class="token punctuation">(</span><span class="token punctuation">)</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> svgCaptcha <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>toolsService<span class="token punctuation">.</span><span class="token function">captche</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//创建验证码</span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>code <span class="token operator">=</span> svgCaptcha<span class="token punctuation">.</span>text<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//使用session保存验证，用于登录时验证</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'image/svg+xml'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//指定返回的类型</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>svgCaptcha<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//给页面返回一张图片</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
  <span class="token function">login</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> body<span class="token punctuation">,</span> @<span class="token function">Session</span><span class="token punctuation">(</span><span class="token punctuation">)</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//验证验证码，由前端传递过来</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> body<span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>code<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> session<span class="token punctuation">.</span>code<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>‘验证码通过’<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">'hello authcode'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>前端简单代码</strong></p>
<pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>IE<span class="token punctuation">=</span>edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width, initial-scale<span class="token punctuation">=</span>1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style language-css">
        <span class="token selector">form </span><span class="token punctuation">{</span>
            <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token selector"><span class="token class">.input</span> </span><span class="token punctuation">{</span>
            <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">80</span>px<span class="token punctuation">;</span>
            <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">32</span>px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token selector"><span class="token class">.verify_img</span> </span><span class="token punctuation">{</span>
            <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span>px <span class="token number">5</span>px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>随机验证码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/user/login<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>application/x-www-form-urlencoded<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>code<span class="token punctuation">'</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>input<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>verify_img<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/user/code<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>看不清？点击刷新<span class="token punctuation">"</span></span>
            <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:this.src<span class="token punctuation">=</span><span class="token punctuation">'</span>/user/code?t<span class="token punctuation">=</span><span class="token punctuation">'</span>+Math.random()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> //点击再次生成新的验证码
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>提交<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<h2 id="邮件服务"><a href="#邮件服务" class="headerlink" title="邮件服务"></a>邮件服务</h2><blockquote>
<p>邮件服务使用文档 <a href="https://nest-modules.github.io/mailer/docs/mailer" target="_blank" rel="noopener">https://nest-modules.github.io/mailer/docs/mailer</a></p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 邮件服务配置</span>
<span class="token comment" spellcheck="true">// app.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MailerModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs-modules/mailer'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> resolve<span class="token punctuation">,</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigModule<span class="token punctuation">,</span> ConfigService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'nestjs-config'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment" spellcheck="true">// 加载配置文件目录 src/config</span>
    ConfigModule<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'**/!(*.d).{ts,js}'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 邮件服务配置</span>
    MailerModule<span class="token punctuation">.</span><span class="token function">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      useFactory<span class="token punctuation">:</span> <span class="token punctuation">(</span>config<span class="token punctuation">:</span> ConfigService<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      inject<span class="token punctuation">:</span> <span class="token punctuation">[</span>ConfigService<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token keyword">implements</span> <span class="token class-name">NestModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// src/config/email.ts 邮件服务配置</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// npm i ejs -S</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EjsAdapter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs-modules/mailer/dist/adapters/ejs.adapter'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  transport<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    host<span class="token punctuation">:</span> <span class="token string">'smtp.qq.com'</span><span class="token punctuation">,</span>
    secureConnection<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// use SSL</span>
    secure<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> <span class="token number">465</span><span class="token punctuation">,</span>
    ignoreTLS<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    auth<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      user<span class="token punctuation">:</span> <span class="token string">'123@test.com'</span><span class="token punctuation">,</span>
      pass<span class="token punctuation">:</span> <span class="token string">'dfafew1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  defaults<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token string">'"nestjs" &lt;123@test.com>'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment" spellcheck="true">// preview: true, // 发送邮件前预览</span>
  template<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    dir<span class="token punctuation">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../templates/email'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 邮件模板</span>
    adapter<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">EjsAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      strict<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p><strong>邮件服务使用</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// email.services.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MailerService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs-modules/mailer'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EmailService</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 邮件服务注入</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> mailerService<span class="token punctuation">:</span> MailerService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发送邮件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mailerService<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      to<span class="token punctuation">:</span> <span class="token string">'test@qq.com'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 收件人</span>
      <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token string">'123@test.com'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 发件人</span>
      <span class="token comment" spellcheck="true">// subject: '副标题',</span>
      text<span class="token punctuation">:</span> <span class="token string">'welcome'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// plaintext body</span>
      html<span class="token punctuation">:</span> <span class="token string">'&lt;h1>hello&lt;/h1>'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// HTML body content</span>
      <span class="token comment" spellcheck="true">// template: 'email', // 邮件模板</span>
      <span class="token comment" spellcheck="true">// context: { // 传入邮件模板的data</span>
      <span class="token comment" spellcheck="true">//   email: 'test@qq.com',</span>
      <span class="token comment" spellcheck="true">// },</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">'发送成功'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="nest基于possport-jwt做登录验证"><a href="#nest基于possport-jwt做登录验证" class="headerlink" title="nest基于possport + jwt做登录验证"></a>nest基于possport + jwt做登录验证</h2><p><strong>方式与逻辑</strong></p>
<ul>
<li>基于possport的本地策略和jwt策略</li>
<li><strong>本地策略</strong>主要是验证账号和密码是否存在，如果存在就登录，返回<strong>token</strong></li>
<li><strong>jwt策略</strong>则是验证用户<strong>登录时附带的token</strong>是否匹配和有效，如果不匹配和无效则返回<strong>401状态码</strong></li>
</ul>
<pre class=" language-bash"><code class="language-bash">yarn add @nestjs/jwt @nestjs/passport passport-jwt passport-local passportyarn add -D @types/passport @types/passport-jwt @types/passport-local</code></pre>
<p><strong>jwt策略 jwt.strategy.ts</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/modules/auth/jwt.strategy.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Strategy<span class="token punctuation">,</span> ExtractJwt<span class="token punctuation">,</span> StrategyOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'passport-jwt'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> jwtConstants <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JwtStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      jwtFromRequest<span class="token punctuation">:</span> ExtractJwt<span class="token punctuation">.</span><span class="token function">fromHeader</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      ignoreExpiration<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      secretOrKey<span class="token punctuation">:</span> jwtConstants<span class="token punctuation">.</span>secret<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 使用密钥解析</span>
    <span class="token punctuation">}</span> <span class="token keyword">as</span> StrategyOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">//token验证, payload是super中已经解析好的token信息</span>
  <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>payload<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> userId<span class="token punctuation">:</span> payload<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> username<span class="token punctuation">:</span> payload<span class="token punctuation">.</span>username <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>本地策略 local.strategy.ts</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/modules/auth/local.strategy.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Strategy<span class="token punctuation">,</span> IStrategyOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'passport-local'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> HttpException<span class="token punctuation">,</span> HttpStatus <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//本地策略</span>
<span class="token comment" spellcheck="true">//PassportStrategy接受两个参数：</span>
<span class="token comment" spellcheck="true">//第一个：Strategy，你要用的策略，这里是passport-local，本地策略</span>
<span class="token comment" spellcheck="true">//第二个：别名，可选，默认是passport-local的local，用于接口时传递的字符串</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LocalStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> authService<span class="token punctuation">:</span> AuthService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      usernameField<span class="token punctuation">:</span> <span class="token string">'username'</span><span class="token punctuation">,</span>
      passwordField<span class="token punctuation">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token keyword">as</span> IStrategyOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// validate是LocalStrategy的内置方法</span>
  <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>username<span class="token punctuation">:</span> string<span class="token punctuation">,</span> password<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//查询数据库，验证账号密码，并最终返回用户</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">validateUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>constants.ts</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/modules/auth/constants.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> jwtConstants <span class="token operator">=</span> <span class="token punctuation">{</span>
  secret<span class="token punctuation">:</span> <span class="token string">'secretKey'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p><strong>使用守卫 auth.controller.ts</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/modules/auth/auth.controller.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Request<span class="token punctuation">,</span> UseGuards <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'auth'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly authService<span class="token punctuation">:</span> AuthService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 登录测试 无需token</span>
  @<span class="token function">UseGuards</span><span class="token punctuation">(</span><span class="token function">AuthGuard</span><span class="token punctuation">(</span><span class="token string">'local'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//本地策略，传递local，执行local里面的validate方法</span>
  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span>@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//通过req可以获取到validate方法返回的user，传递给login，登录</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// 在需要的地方使用守卫，需要带token才可访问</span>
  @<span class="token function">UseGuards</span><span class="token punctuation">(</span><span class="token function">AuthGuard</span><span class="token punctuation">(</span><span class="token string">'jwt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//jwt策略，身份鉴权</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'userInfo'</span><span class="token punctuation">)</span>
  <span class="token function">getUserInfo</span><span class="token punctuation">(</span>@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//通过req获取到被验证后的user，也可以使用装饰器</span>
    <span class="token keyword">return</span> req<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>在module引入jwt配置和数据库查询的实体 auth.module.ts</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/modules/auth/auth.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LocalStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./local.strategy'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> jwtConstants <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./jwt.strategy'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../user/entities/user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TypeOrmModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    TypeOrmModule<span class="token punctuation">.</span><span class="token function">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span>UsersEntity<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    PassportModule<span class="token punctuation">,</span>
    JwtModule<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token punctuation">:</span> jwtConstants<span class="token punctuation">.</span>secret<span class="token punctuation">,</span>
      signOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> expiresIn<span class="token punctuation">:</span> <span class="token string">'10d'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AuthController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">,</span> LocalStrategy<span class="token punctuation">,</span> JwtStrategy<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token punctuation">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p><strong>auth.service.ts</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/modules/auth/auth.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> compareSync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'bcryptjs'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
      @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span><span class="token punctuation">,</span>
      <span class="token keyword">private</span> jwtService<span class="token punctuation">:</span> JwtService
    <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">validateUser</span><span class="token punctuation">(</span>username<span class="token punctuation">:</span> string<span class="token punctuation">,</span> password<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token punctuation">:</span> <span class="token punctuation">{</span> username <span class="token punctuation">}</span><span class="token punctuation">,</span>
      select<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户名或密码不正确'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//使用bcryptjs验证密码</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户名或密码不正确'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">login</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span> username<span class="token punctuation">:</span> user<span class="token punctuation">.</span>username <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 把信息存在token</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      token<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtService<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>最后在app.module.ts中导入即可测试</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// app.modules.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./modules/auth/auth.module'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token operator">...</span>
    AuthModule<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 导入模块</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token keyword">implements</span> <span class="token class-name">NestModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p><strong>使用postman测试</strong></p>
<p><img src="//static.tianyichuxin.com/images/29344/21.png" alt=""></p>
<h2 id="对数据库的密码加密：md5和bcryptjs"><a href="#对数据库的密码加密：md5和bcryptjs" class="headerlink" title="对数据库的密码加密：md5和bcryptjs"></a>对数据库的密码加密：md5和bcryptjs</h2><p><strong>密码加密</strong></p>
<blockquote>
<p>一般开发中，是不会有人直接将密码明文直接放到数据库当中的。因为这种做法是非常不安全的，需要对密码进行加密处理。<br>好处：</p>
<ul>
<li>预防内部网站运营人员知道用户的密码</li>
<li>预防外部的攻击，尽可能保护用户的隐私</li>
</ul>
</blockquote>
<p><strong>加密方式</strong></p>
<ul>
<li>使用<code>md5</code>：每次生成的值是一样的，一些网站可以破解，因为每次存储的都是一样的值</li>
<li>使用<code>bcryptjs</code>：每次生成的值是不一样的</li>
</ul>
<pre class=" language-bash"><code class="language-bash">yarn add md5</code></pre>
<p>加密</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> md5 <span class="token keyword">from</span> <span class="token string">'md5'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> passwrod <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> transP <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span>passwrod<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 固定值：e10adc3949ba59abbe56e057f20f883e</span></code></pre>
<p>给密码加点”盐”：目的是混淆密码，其实还是得到固定的值</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> passwrod <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> salt <span class="token operator">=</span> <span class="token string">'dmxys'</span>
<span class="token keyword">const</span> transP <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span>passwrod <span class="token operator">+</span> salt<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 固定值：4e6a2881e83262a72f6c70f48f3e8022</span></code></pre>
<p>验证密码：先加密，再验证</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> passwrod <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> databasePassword <span class="token operator">=</span> <span class="token string">'e10adc3949ba59abbe56e057f20f883e'</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span>passwrod<span class="token punctuation">)</span> <span class="token operator">===</span> databasePassword <span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'密码通过'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>使用bcryptjs</strong></p>
<pre class=" language-bash"><code class="language-bash">yarn add bcryptjs
yarn add -D @types/bcryptjs</code></pre>
<p>同一密码，每次生成不一样的值</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> compareSync<span class="token punctuation">,</span> hashSync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'bcryptjs'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> passwrod <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> transformPass <span class="token operator">=</span> <span class="token function">hashSync</span><span class="token punctuation">(</span>passwrod<span class="token punctuation">)</span><span class="token punctuation">;</span>  $2a$<span class="token number">10</span>$HgTA1GX8uxbocSQlbQ42<span class="token operator">/</span><span class="token punctuation">.</span>Y2XnIL7FyfKzn6IC69IXveD6F9LiULS
<span class="token keyword">const</span> transformPass2 <span class="token operator">=</span> <span class="token function">hashSync</span><span class="token punctuation">(</span>passwrod<span class="token punctuation">)</span><span class="token punctuation">;</span> $2a$<span class="token number">10</span>$mynd130vI1vkz4OQ3C<span class="token punctuation">.</span>6FeYXGEq24KLUt1CsKN2WZqVsv0tPrtOcW
<span class="token keyword">const</span> transformPass3 <span class="token operator">=</span> <span class="token function">hashSync</span><span class="token punctuation">(</span>passwrod<span class="token punctuation">)</span><span class="token punctuation">;</span> $2a$<span class="token number">10</span>$bOHdFQ4TKBrtcNgmduzD8esds04BoXc0JcrLme68rTeik7U96KBvu</code></pre>
<p>验证密码：使用不同的值 匹配 密码123456，都能通过</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> password <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> databasePassword1 <span class="token operator">=</span> <span class="token string">'$2a$10$HgTA1GX8uxbocSQlbQ42/.Y2XnIL7FyfKzn6IC69IXveD6F9LiULS'</span>
<span class="token keyword">const</span> databasePassword2 <span class="token operator">=</span> <span class="token string">'$2a$10$mynd130vI1vkz4OQ3C.6FeYXGEq24KLUt1CsKN2WZqVsv0tPrtOcW'</span>
<span class="token keyword">const</span> databasePassword3 <span class="token operator">=</span> <span class="token string">'$2a$10$bOHdFQ4TKBrtcNgmduzD8esds04BoXc0JcrLme68rTeik7U96KBvu'</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> databasePassword3<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'密码通过'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>推荐使用<code>bcryptjs</code>，算法要比<code>md5</code>高级</p>
<h2 id="角色权限"><a href="#角色权限" class="headerlink" title="角色权限"></a>角色权限</h2><h3 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h3><ul>
<li><blockquote>
<ul>
<li>RBAC是基于角色的权限访问控制（Role-Based Access Control）一种数据库设计思想，根据设计数据库设计方案，完成项目的权限管理</li>
<li>在RBAC中，有3个基础组成部分，分别是：<code>用户</code>、<code>角色</code>和<code>权限</code>，权限与角色相关联，用户通过成为适当角色而得到这些角色的权限</li>
</ul>
</blockquote>
</li>
<li><p>权限：具备操作某个事务的能力</p>
</li>
<li><p>角色：一系列权限的集合</p>
</li>
</ul>
<blockquote>
<p>如：一般的管理系统中：<br>销售人员：仅仅可以查看商品信息<br>运营人员：可以查看，修改商品信息<br>管理人员：可以查看，修改，删除，以及修改员工权限等等<br>管理人员只要为每个员工账号分配对应的角色，登录操作时就只能执行对应的权限或看到对应的页面</p>
</blockquote>
<p><strong>权限类型</strong></p>
<ul>
<li>展示（菜单），如：显示用户列表，显示删除按钮等等…</li>
<li>操作（功能），如：增删改查，上传下载，发布公告，发起活动等等…</li>
</ul>
<p><strong>数据库设计</strong></p>
<blockquote>
<p>数据库设计：可简单，可复杂，几个人使用的系统和几千人使用的系统是不一样的<br>小型项目：用户表，权限表<br>中型项目：用户表，角色表，权限表<br>大型项目：用户表，用户分组表，角色表，权限表，菜单表…</p>
</blockquote>
<p><strong>没有角色的设计</strong></p>
<p>只有用户表，菜单表，两者是多对多关系，有一个关联表</p>
<p><strong>缺点：</strong></p>
<ul>
<li>新建一个用户时，在用户表中添加一条数据</li>
<li>新建一个用户时，在关联表中添加N条数据</li>
<li>每次新建一个用户需要添加1+N(关联几个)条数据</li>
<li>如果有100个用户，每个用户100个权限，那需要添加10000条数据</li>
</ul>
<h3 id="基于RBAC的设计"><a href="#基于RBAC的设计" class="headerlink" title="基于RBAC的设计"></a>基于RBAC的设计</h3><p>用户表和角色表的关系设计：</p>
<blockquote>
<p>如果你希望一个用户可以有多个角色，如：一个人即是销售总监，也是人事管理，就设计多对多关系<br>如果你希望一个用户只能有一个角色，就设计一对多，多对一关系</p>
</blockquote>
<p>角色表和权限表的关系设计：</p>
<blockquote>
<p>一个角色可以拥有多个权限，一个权限被多个角色使用，设计多对多关系</p>
</blockquote>
<p><strong>多对多关系设计</strong></p>
<p>用户表与角色表是多对多关系，角色表与菜单表是多对多关系</p>
<p><img src="//static.tianyichuxin.com/images/29344/22.png" alt=""></p>
<p><strong>更加复杂的设计</strong></p>
<p><img src="//static.tianyichuxin.com/images/29344/23.png" alt=""></p>
<p><strong>实现流程</strong></p>
<ol>
<li>数据表设计</li>
<li>实现角色的增删改查</li>
<li>实现用户的增删改查，增加和修改用户的时候需要选择角色</li>
<li>实现权限的增删改查</li>
<li>实现角色与授权的关联</li>
<li>判断当前登录的用户是否有访问菜单的权限</li>
<li>根据当前登录账户的角色信息动态显示左侧菜单（前端）</li>
</ol>
<p><strong>代码实现</strong></p>
<blockquote>
<p>这里将实现一个用户，部门，角色，权限的例子：<br>用户通过成为部门的一员，则拥有部门普通角色的权限，还可以单独给用户设置角色，通过角色，获取权限。<br>权限模块包括，模块，菜单，操作，通过type区分类型，这里就不再拆分。</p>
</blockquote>
<p><strong>关系总览：</strong></p>
<ul>
<li>用户 - 部门：一对多关系，这里设计用户只能加入一个部门，如果设计可以加入多个部门，设计为多对多关系</li>
<li>用户 - 角色：多对多关系，可以给用户设置多个角色</li>
<li>角色 - 部门：多对多关系，一个部门多个角色</li>
<li>角色 - 权限：多对多关系，一个角色拥有多个权限，一个权限被多个角色使用</li>
</ul>
<h3 id="数据库实体设计"><a href="#数据库实体设计" class="headerlink" title="数据库实体设计"></a>数据库实体设计</h3><p><strong>用户</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  ManyToMany<span class="token punctuation">,</span>
  ManyToOne<span class="token punctuation">,</span>
  JoinColumn<span class="token punctuation">,</span>
  JoinTable<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RoleEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../role/entities/role.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DepartmentEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../department/entities/department.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'user'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersEntity</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span>
    length<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    unique<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span>
    length<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    select<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'密码'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">ManyToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> RoleEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>role<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> role<span class="token punctuation">.</span>users<span class="token punctuation">)</span>
  @<span class="token function">JoinTable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'user_role'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  roles<span class="token punctuation">:</span> RoleEntity<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  @<span class="token function">ManyToOne</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> DepartmentEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>department<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> department<span class="token punctuation">.</span>users<span class="token punctuation">)</span>
  @<span class="token function">JoinColumn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'department_id'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  department<span class="token punctuation">:</span> DepartmentEntity<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>角色</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Entity<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
  Column<span class="token punctuation">,</span>
  ManyToMany<span class="token punctuation">,</span>
  JoinTable<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../user/entities/user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DepartmentEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../department/entities/department.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AccessEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../access/entities/access.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'role'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">RoleEntity</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span> length<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  rolename<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">ManyToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> UsersEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> user<span class="token punctuation">.</span>roles<span class="token punctuation">)</span>
  users<span class="token punctuation">:</span> UsersEntity<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  @<span class="token function">ManyToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> DepartmentEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>department<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> department<span class="token punctuation">.</span>roles<span class="token punctuation">)</span>
  department<span class="token punctuation">:</span> DepartmentEntity<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  @<span class="token function">ManyToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> AccessEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>access<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> access<span class="token punctuation">.</span>roles<span class="token punctuation">)</span>
  @<span class="token function">JoinTable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'role_access'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  access<span class="token punctuation">:</span> AccessEntity<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>部门</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Entity<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
  Column<span class="token punctuation">,</span>
  ManyToMany<span class="token punctuation">,</span>
  OneToMany<span class="token punctuation">,</span>
  JoinTable<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../user/entities/user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RoleEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../role/entities/role.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'department'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DepartmentEntity</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span> length<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  departmentname<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">OneToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> UsersEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> user<span class="token punctuation">.</span>department<span class="token punctuation">)</span>
  users<span class="token punctuation">:</span> UsersEntity<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  @<span class="token function">ManyToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> RoleEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>role<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> role<span class="token punctuation">.</span>department<span class="token punctuation">)</span>
  @<span class="token function">JoinTable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'department_role'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  roles<span class="token punctuation">:</span> RoleEntity<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>权限</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Entity<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
  Column<span class="token punctuation">,</span>
  Tree<span class="token punctuation">,</span>
  TreeChildren<span class="token punctuation">,</span>
  TreeParent<span class="token punctuation">,</span>
  ManyToMany<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RoleEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../role/entities/role.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'access'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
@<span class="token function">Tree</span><span class="token punctuation">(</span><span class="token string">'closure-table'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AccessEntity</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span> length<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> comment<span class="token punctuation">:</span> <span class="token string">'模块'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  module_name<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span> length<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> nullable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> comment<span class="token punctuation">:</span> <span class="token string">'操作'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  action_name<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'tinyint'</span><span class="token punctuation">,</span> comment<span class="token punctuation">:</span> <span class="token string">'类型：1:模块，2：菜单，3：操作'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  type<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span> nullable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> comment<span class="token punctuation">:</span> <span class="token string">'操作地址'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  url<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">TreeParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  parentCategory<span class="token punctuation">:</span> AccessEntity<span class="token punctuation">;</span>

  @<span class="token function">TreeChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  childCategorys<span class="token punctuation">:</span> AccessEntity<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  @<span class="token function">ManyToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> RoleEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>role<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> role<span class="token punctuation">.</span>access<span class="token punctuation">)</span>
  roles<span class="token punctuation">:</span> RoleEntity<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="接口实现"><a href="#接口实现" class="headerlink" title="接口实现"></a>接口实现</h3><p>由于要实现很多接口，这里只说明一部分，其实都是数据库的操作，所有接口如下：</p>
<p><img src="//static.tianyichuxin.com/images/29344/24.png" alt=""></p>
<p><strong>根据用户的id获取信息</strong>：id，用户名，部门名，角色，这些信息在做用户登录时传递到token中。</p>
<blockquote>
<p>这里设计的是：创建用户时，添加部门，就会成为部门的普通角色，也可单独设置角色，但不是每个用户都有单独的角色。</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token function">getUserinfoByUid</span><span class="token punctuation">(</span>uid<span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    获取用户
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span> id<span class="token punctuation">:</span> uid <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> relations<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'roles'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户ID不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
    select 
    user.id as user_id, user.username, user.department_id, department.departmentname, role.id as role_id, rolename
    from
    user, department, role, department_role as dr
    where 
    user.department_id = department.id
    and department.id = dr.departmentId
    and role.id = dr.roleId
    and user.id = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> userinfo <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> userObj <span class="token operator">=</span> <span class="token punctuation">{</span>
      user_id<span class="token punctuation">:</span> userinfo<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
      username<span class="token punctuation">:</span> userinfo<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
      department_id<span class="token punctuation">:</span> userinfo<span class="token punctuation">.</span>department_id<span class="token punctuation">,</span>
      departmentname<span class="token punctuation">:</span> userinfo<span class="token punctuation">.</span>departmentname<span class="token punctuation">,</span>
      roles<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> userinfo<span class="token punctuation">.</span>role_id<span class="token punctuation">,</span> rolename<span class="token punctuation">:</span> userinfo<span class="token punctuation">.</span>rolename <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 如果用户的角色roles有值，证明单独设置了角色，所以需要拼接起来</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>roles<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> _user <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      userObj<span class="token punctuation">.</span>roles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>userObj<span class="token punctuation">.</span>roles<span class="token punctuation">,</span> <span class="token operator">...</span>_user<span class="token punctuation">.</span>roles<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> userObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 接口请求结果：</span>
<span class="token punctuation">{</span>
    <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"请求成功"</span><span class="token punctuation">,</span>
    <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
        <span class="token string">"department_id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"departmentname"</span><span class="token punctuation">:</span> <span class="token string">"销售部"</span><span class="token punctuation">,</span>
        <span class="token string">"roles"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string">"rolename"</span><span class="token punctuation">:</span> <span class="token string">"销售部员工"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
                <span class="token string">"rolename"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>结合possport + jwt 做用户登录授权验证</strong></p>
<blockquote>
<p>在验证账户密码通过后，possport 返回用户，然后根据用户id获取用户信息，存储token，用于路由守卫，还可以使用redis存储，以作他用。</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token keyword">const</span> userResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">getUserinfoByUid</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> access_token <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtService<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>userResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisService<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`user-token-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> access_token<span class="token punctuation">,</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> access_token <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">{</span>
    <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"请求成功"</span><span class="token punctuation">,</span>
    <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"access_token"</span><span class="token punctuation">:</span> <span class="token string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6ImFkbWluIiwiZGVwYXJ0bWVudF9pZCI6MSwiZGVwYXJ0bWVudG5hbWUiOiLplIDllK7pg6giLCJyb2xlcyI6W3siaWQiOjEsInJvbGVuYW1lIjoi6ZSA5ZSu6YOo5ZGY5belIn0seyJpZCI6NSwicm9sZW5hbWUiOiJhZG1pbiJ9XSwiaWF0IjoxNjIxNjA1Nzg5LCJleHAiOjE2MjE2OTIxODl9.VIp0MdzSPM13eq1Bn8bB9Iu_SLKy4yoMU2N4uwgWDls"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="后端的权限访问"><a href="#后端的权限访问" class="headerlink" title="后端的权限访问"></a><strong>后端的权限访问</strong></h3><blockquote>
<p>使用守卫，装饰器，结合token，验证访问权限</p>
</blockquote>
<p><strong>逻辑：</strong></p>
<ul>
<li>第一步：在<code>controller</code>使用自定义守卫装饰接口路径，在请求该接口路径时，全部进入守卫逻辑</li>
<li>第二步：使用自定义装饰器装饰特定接口，传递角色，自定义守卫会使用反射器获取该值，以判断该用户是否有权限</li>
</ul>
<p>如下：<code>findOne</code>接口使用了自定义装饰器装饰接口，意思是只能<code>admin</code>来访问</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  Patch<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  Delete<span class="token punctuation">,</span>
  UseGuards<span class="token punctuation">,</span>
  ParseIntPipe<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreateUserDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dto/create-user.dto'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UpdateUserDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dto/update-user.dto'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../common/guard/auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Roles <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../common/decorator/role.decorator'</span><span class="token punctuation">;</span>

@<span class="token function">UseGuards</span><span class="token punctuation">(</span>AuthGuard<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// 自定义守卫</span>
@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly userService<span class="token punctuation">:</span> UserService<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>data<span class="token punctuation">,</span> count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">Roles</span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 自定义装饰器</span>
  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>装饰器</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> SetMetadata <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// SetMetadata作用：将获取到的值，设置到元数据中，然后守卫通过反射器才能获取到值</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Roles <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">SetMetadata</span><span class="token punctuation">(</span><span class="token string">'roles'</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>自定义守卫</strong></p>
<blockquote>
<p>返回<code>true</code>则有访问权限，返回<code>false</code>则直接报<code>403</code></p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> CanActivate<span class="token punctuation">,</span> ExecutionContext<span class="token punctuation">,</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Reflector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 反射器，作用与自定义装饰器桥接</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ToolsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../utils/tools.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthGuard</span> <span class="token keyword">implements</span> <span class="token class-name">CanActivate</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> readonly reflector<span class="token punctuation">:</span> Reflector<span class="token punctuation">,</span>
    <span class="token keyword">private</span> readonly jwtService<span class="token punctuation">:</span> JwtService<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 白名单数组</span>
  <span class="token keyword">private</span> whiteUrlList<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 验证该次请求是否为白名单内的路由</span>
  <span class="token keyword">private</span> <span class="token function">isWhiteUrl</span><span class="token punctuation">(</span>urlList<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>urlList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">canActivate</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> ExecutionContext<span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 获取请求对象</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 验证是否是白名单内的路由</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isWhiteUrl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>whiteUrlList<span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 获取请求头中的token字段，解析获取存储在token的用户信息</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">switchToRpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>headers<span class="token punctuation">.</span>token<span class="token punctuation">;</span>
    <span class="token keyword">const</span> user<span class="token punctuation">:</span> any <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtService<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'token获取失败，请传递token或书写正确'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 使用反射器，配合装饰器使用，获取装饰器传递过来的数据</span>
    <span class="token keyword">const</span> authRoles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reflector<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token operator">&lt;</span>string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">(</span>
      <span class="token string">'roles'</span><span class="token punctuation">,</span>
      context<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 如果没有使用roles装饰，就获取不到值，就不鉴权，等于白名单</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>authRoles<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 如果用户的所属角色与装饰器传递过来的值匹配则通过，否则不通过</span>
    <span class="token keyword">const</span> userRoles <span class="token operator">=</span> user<span class="token punctuation">.</span>roles<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> userRoles<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>authRoles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>userRoles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>rolename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  </code></pre>
<p><strong>简单测试</strong></p>
<blockquote>
<p>两个用户，分别对应不同的角色，分别请求user的findOne接口<br>用户1：销售部员工和admin<br>用户2：人事部员工</p>
</blockquote>
<pre class=" language-json"><code class="language-json">//用户<span class="token number">1</span>：销售部员工和admin
<span class="token punctuation">{</span>
    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"请求成功"</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"user_id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
        <span class="token property">"department_id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">"departmentname"</span><span class="token operator">:</span> <span class="token string">"销售部"</span><span class="token punctuation">,</span>
        <span class="token property">"roles"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">"rolename"</span><span class="token operator">:</span> <span class="token string">"销售部员工"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
                <span class="token property">"rolename"</span><span class="token operator">:</span> <span class="token string">"admin"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

//用户<span class="token number">2</span>：人事部员工
<span class="token punctuation">{</span>
    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"请求成功"</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"user_id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"admin2"</span><span class="token punctuation">,</span>
        <span class="token property">"department_id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">"departmentname"</span><span class="token operator">:</span> <span class="token string">"人事部"</span><span class="token punctuation">,</span>
        <span class="token property">"roles"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token property">"rolename"</span><span class="token operator">:</span> <span class="token string">"人事部员工"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


//不出意外的话：<span class="token number">2</span>号用户的请求结果
<span class="token punctuation">{</span>
    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token number">403</span><span class="token punctuation">,</span>
    <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Forbidden resource"</span><span class="token punctuation">,</span>
    <span class="token property">"error"</span><span class="token operator">:</span> <span class="token string">"Forbidden"</span><span class="token punctuation">,</span>
    <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/user/1"</span><span class="token punctuation">,</span>
    <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2021-05-21T14:44:04.954Z"</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p>前端的权限访问则是通过权限表url和type来处理</p>
</blockquote>
<h2 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h2><p>nest如何开启定时任务？</p>
<p><strong>定时任务场景</strong></p>
<blockquote>
<p>每天定时更新，定时发送邮件</p>
</blockquote>
<p>没有controller，因为定时任务是自动完成的</p>
<pre class=" language-bash"><code class="language-bash">yarn add @nestjs/schedule</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/tasks/task.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TasksService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./tasks.service'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>TasksService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TasksModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p>在这里编写你的定时任务</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/tasks/task.service.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> Logger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Cron<span class="token punctuation">,</span> Interval<span class="token punctuation">,</span> Timeout <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/schedule'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TasksService</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> readonly logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Logger</span><span class="token punctuation">(</span>TasksService<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

  @<span class="token function">Cron</span><span class="token punctuation">(</span><span class="token string">'45 * * * * *'</span><span class="token punctuation">)</span>  每隔<span class="token number">45</span>秒执行一次
  <span class="token function">handleCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Called when the second is 45'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Interval</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>  每隔<span class="token number">10</span>秒执行一次
  <span class="token function">handleInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Called every 10 seconds'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Timeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>  <span class="token number">5</span>秒只执行一次
  <span class="token function">handleTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Called once after 5 seconds'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>自定义定时时间</p>
<pre class=" language-bash"><code class="language-bash">* * * * * * 分别对应的意思：
第1个星：秒
第2个星：分钟
第3个星：小时
第4个星：一个月中的第几天
第5个星：月
第6个星：一个星期中的第几天

如：
45 * * * * *：每隔45秒执行一次</code></pre>
<p><strong>挂载-使用</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// app.module.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> TasksModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./tasks/task.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ScheduleModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/schedule'</span><span class="token punctuation">;</span>

imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    ConfigModule<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'**/!(*.d).{ts,js}'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    ScheduleModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    TasksModule<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span></code></pre>
<h2 id="接入Swagger接口文档"><a href="#接入Swagger接口文档" class="headerlink" title="接入Swagger接口文档"></a>接入Swagger接口文档</h2><ul>
<li>优点：不用写接口文档，在线生成，自动生成，可操作数据库，完美配合<code>dto</code></li>
<li>缺点：多一些代码，显得有点乱，习惯就好</li>
</ul>
<pre class=" language-bash"><code class="language-bash">yarn add @nestjs/swagger swagger-ui-express -D</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// main.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SwaggerModule<span class="token punctuation">,</span> DocumentBuilder <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/swagger'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 创建实例</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span>create<span class="token operator">&lt;</span>NestExpressApplication<span class="token operator">></span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 创建接口文档服务</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DocumentBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addBearerAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// token认证，输入token才可以访问文档</span>
    <span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">'接口文档'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token string">'接口文档介绍'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 文档介绍</span>
    <span class="token punctuation">.</span><span class="token function">addServer</span><span class="token punctuation">(</span><span class="token string">'http://localhost:9000'</span><span class="token punctuation">,</span> <span class="token string">'开发环境'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addServer</span><span class="token punctuation">(</span><span class="token string">'https://test.com/release'</span><span class="token punctuation">,</span> <span class="token string">'正式环境'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">'1.0.0'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 文档版本</span>
    <span class="token punctuation">.</span><span class="token function">setContact</span><span class="token punctuation">(</span><span class="token string">'poetry'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'test@qq.com'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 为了创建完整的文档（具有定义的HTTP路由），我们使用类的createDocument()方法SwaggerModule。此方法带有两个参数，分别是应用程序实例和基本Swagger选项。</span>
  <span class="token keyword">const</span> document <span class="token operator">=</span> SwaggerModule<span class="token punctuation">.</span><span class="token function">createDocument</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    extraModels<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 这里导入模型</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 启动swagger</span>
  SwaggerModule<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token string">'api-docs'</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> document<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 访问路径 http://localhost:9000/api-docs</span>

  <span class="token comment" spellcheck="true">// 启动端口</span>
  <span class="token keyword">const</span> PORT <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>PORT <span class="token operator">||</span> <span class="token number">9000</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>PORT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
    Logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`服务已经启动 http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>PORT<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>swagger装饰器</strong></p>
<p><a href="https://swagger.io/" target="_blank" rel="noopener">https://swagger.io/</a></p>
<pre class=" language-js"><code class="language-js">@<span class="token function">ApiTags</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// 设置模块接口的分类，不设置默认分配到default</span>
@<span class="token function">ApiOperation</span><span class="token punctuation">(</span><span class="token punctuation">{</span> summary<span class="token punctuation">:</span> <span class="token string">'标题'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'详细描述'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 单个接口描述</span>

<span class="token comment" spellcheck="true">// 传参</span>
@<span class="token function">ApiQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'limit'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// query参数</span>
@<span class="token function">ApiQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'role'</span><span class="token punctuation">,</span> <span class="token keyword">enum</span><span class="token punctuation">:</span> UserRole <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// query参数</span>
@<span class="token function">ApiParam</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'id'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// parma参数</span>
@<span class="token function">ApiBody</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> UserCreateDTO<span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'输入用户名和密码'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// 请求体</span>

<span class="token comment" spellcheck="true">// 响应</span>
@<span class="token function">ApiResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    status<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">'成功返回200，失败返回400'</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> UserCreateDTO<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 验证</span>
@<span class="token function">ApiProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> example<span class="token punctuation">:</span> <span class="token string">'Kitty'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'The name of the Cat'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
name<span class="token punctuation">:</span> string<span class="token punctuation">;</span></code></pre>
<p>在<code>controller</code>引入<code>@nestjs/swagger</code>， 并配置<code>@ApiBody()</code>和 <code>@ApiParam()</code>不写也是可以的</p>
<pre class=" language-js"><code class="language-js">user<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>ts

<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  Patch<span class="token punctuation">,</span>
  Query<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  Delete<span class="token punctuation">,</span>
  HttpCode<span class="token punctuation">,</span>
  HttpStatus<span class="token punctuation">,</span>
  ParseIntPipe<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  ApiOperation<span class="token punctuation">,</span>
  ApiTags<span class="token punctuation">,</span>
  ApiQuery<span class="token punctuation">,</span>
  ApiBody<span class="token punctuation">,</span>
  ApiResponse<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/swagger'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreateUserDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dto/create-user.dto'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UpdateUserDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dto/update-user.dto'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
@<span class="token function">ApiTags</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 设置分类</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly userService<span class="token punctuation">:</span> UserService<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">ApiOperation</span><span class="token punctuation">(</span><span class="token punctuation">{</span> summary<span class="token punctuation">:</span> <span class="token string">'创建用户'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'创建用户'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 该接口</span>
  @<span class="token function">HttpCode</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">:</span> CreateUserDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">ApiOperation</span><span class="token punctuation">(</span><span class="token punctuation">{</span> summary<span class="token punctuation">:</span> <span class="token string">'查找全部用户'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'创建用户'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">ApiQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'limit'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  请求参数
  @<span class="token function">ApiQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'offset'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> 请求参数
  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span>@<span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>data<span class="token punctuation">,</span> count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">ApiOperation</span><span class="token punctuation">(</span><span class="token punctuation">{</span> summary<span class="token punctuation">:</span> <span class="token string">'根据ID查找用户'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Patch</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">ApiOperation</span><span class="token punctuation">(</span><span class="token punctuation">{</span> summary<span class="token punctuation">:</span> <span class="token string">'更新用户'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">ApiBody</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> UpdateUserDto<span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'参数可选'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  请求体
  @<span class="token function">ApiResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>   响应示例
    status<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">'成功返回200，失败返回400'</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> UpdateUserDto<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
    @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">:</span> UpdateUserDto<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">ApiOperation</span><span class="token punctuation">(</span><span class="token punctuation">{</span> summary<span class="token punctuation">:</span> <span class="token string">'删除用户'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>编写dto，引入@nestjs/swagger</strong></p>
<p>创建</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> IsNotEmpty<span class="token punctuation">,</span> MinLength<span class="token punctuation">,</span> MaxLength <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApiProperty <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/swagger'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CreateUserDto</span> <span class="token punctuation">{</span>
  @<span class="token function">ApiProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> example<span class="token punctuation">:</span> <span class="token string">'kitty'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'用户名'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  添加这里即可
  @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'用户名不能为空'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">ApiProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> example<span class="token punctuation">:</span> <span class="token string">'12345678'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'密码'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'密码不能为空'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">MinLength</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> <span class="token string">'密码长度不能小于6位'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">MaxLength</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> <span class="token string">'密码长度不能超过20位'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>更新</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  IsEnum<span class="token punctuation">,</span>
  MinLength<span class="token punctuation">,</span>
  MaxLength<span class="token punctuation">,</span>
  IsOptional<span class="token punctuation">,</span>
  ValidateIf<span class="token punctuation">,</span>
  IsEmail<span class="token punctuation">,</span>
  IsMobilePhone<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApiProperty <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/swagger'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Type <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-transformer'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UpdateUserDto</span> <span class="token punctuation">{</span>
  @<span class="token function">ApiProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token punctuation">:</span> <span class="token string">'用户名'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'kitty'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  不是必选的
  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">ApiProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token punctuation">:</span> <span class="token string">'密码'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'12345678'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">MinLength</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> <span class="token string">'密码长度不能小于6位'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">MaxLength</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> <span class="token string">'密码长度不能超过20位'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">ApiProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    description<span class="token punctuation">:</span> <span class="token string">'邮箱'</span><span class="token punctuation">,</span>
    example<span class="token punctuation">:</span> <span class="token string">'llovenest@163.com'</span><span class="token punctuation">,</span>
    required<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">IsEmail</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'邮箱格式错误'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">ValidateIf</span><span class="token punctuation">(</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> o<span class="token punctuation">.</span>username <span class="token operator">===</span> <span class="token string">'admin'</span><span class="token punctuation">)</span>
  email<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">ApiProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    description<span class="token punctuation">:</span> <span class="token string">'手机号码'</span><span class="token punctuation">,</span>
    example<span class="token punctuation">:</span> <span class="token string">'13866668888'</span><span class="token punctuation">,</span>
    required<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">IsMobilePhone</span><span class="token punctuation">(</span><span class="token string">'zh-CN'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'手机号码格式错误'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  mobile<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">ApiProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    description<span class="token punctuation">:</span> <span class="token string">'性别'</span><span class="token punctuation">,</span>
    example<span class="token punctuation">:</span> <span class="token string">'female'</span><span class="token punctuation">,</span>
    required<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token keyword">enum</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'male'</span><span class="token punctuation">,</span> <span class="token string">'female'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">IsEnum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'male'</span><span class="token punctuation">,</span> <span class="token string">'female'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> <span class="token string">'gender只能传入字符串male或female'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  gender<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">ApiProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    description<span class="token punctuation">:</span> <span class="token string">'状态'</span><span class="token punctuation">,</span>
    example<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    required<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token keyword">enum</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">IsEnum</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> 禁用<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 可用<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token string">'status只能传入数字0或1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>
  @<span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Number<span class="token punctuation">)</span>
  status<span class="token punctuation">:</span> number<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>打开：localhost:3000/api-docs，开始测试接口</p>
<p><img src="//static.tianyichuxin.com/images/29344/25.png" alt=""></p>
<p><img src="//static.tianyichuxin.com/images/29344/26.png" alt=""></p>
<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><h2 id="nest连接Mongodb"><a href="#nest连接Mongodb" class="headerlink" title="nest连接Mongodb"></a>nest连接Mongodb</h2><p>mac中，直接使用<code>brew install mongodb-community</code>安装MongoDB，然后启动服务<code>brew services start mongodb-community</code> 查看服务已经启动<code>ps aux | grep mongo</code></p>
<blockquote>
<p>Nestjs中操作Mongodb数据库可以使用Nodejs封装的DB库，也可以使用Mongoose。</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash">// https://docs.nestjs.com/techniques/mongodb

<span class="token function">npm</span> <span class="token function">install</span> --save @nestjs/mongoose mongoose
<span class="token function">npm</span> <span class="token function">install</span> --save-dev @types/mongoose</code></pre>
<p><strong>在app.module.ts中配置数据库连接</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// app.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigModule<span class="token punctuation">,</span> ConfigService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'nestjs-config'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MongooseModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MongodbModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../examples/mongodb/mongodb.module'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment" spellcheck="true">// 加载配置文件目录</span>
    ConfigModule<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'**/!(*.d).{ts,js}'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// mongodb</span>
    MongooseModule<span class="token punctuation">.</span><span class="token function">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      useFactory<span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>configService<span class="token punctuation">:</span> ConfigService<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
        configService<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'mongodb'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      inject<span class="token punctuation">:</span> <span class="token punctuation">[</span>ConfigService<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    MongodbModule<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token keyword">implements</span> <span class="token class-name">NestModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// mongodb配置</span>
<span class="token comment" spellcheck="true">// src/config/mongodb.ts</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  uri<span class="token punctuation">:</span> <span class="token string">'mongodb://localhost:27017/nest'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 指定nest数据库</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>配置Schema**</p>
<pre class=" language-bash"><code class="language-bash">// article.schema
<span class="token function">import</span> * as mongoose from <span class="token string">'mongoose'</span><span class="token punctuation">;</span>
<span class="token function">export</span> const ArticleSchema <span class="token operator">=</span> new mongoose.Schema<span class="token punctuation">(</span><span class="token punctuation">{</span>
  title: String,
  content:String,
  author: String,
  status: Number,
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>在控制器对应的Module中配置Model</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// mongodb.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MongodbService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./mongodb.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MongodbController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./mongodb.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ArticleSchema <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./schemas/article.schema'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MongooseModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    MongooseModule<span class="token punctuation">.</span><span class="token function">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token punctuation">:</span> <span class="token string">'Article'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// schema名称对应</span>
        schema<span class="token punctuation">:</span> ArticleSchema<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 引入的schema</span>
        collection<span class="token punctuation">:</span> <span class="token string">'article'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 数据库名称</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>MongodbController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>MongodbService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MongodbModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p><strong>在服务里面使用@InjectModel 获取数据库Model实现操作数据库</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// mongodb.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectModel <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MongodbService</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 注入模型</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>@<span class="token function">InjectModel</span><span class="token punctuation">(</span><span class="token string">'Article'</span><span class="token punctuation">)</span> <span class="token keyword">private</span> readonly articleModel<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>articleModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>articleModel<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>articleModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> <span class="token operator">...</span>params <span class="token punctuation">}</span> <span class="token operator">=</span> body<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>articleModel<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token keyword">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>articleModel<span class="token punctuation">.</span><span class="token function">findByIdAndDelete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>浏览器测试 <a href="http://localhost:9000/api/mongodb/list" target="_blank" rel="noopener">http://localhost:9000/api/mongodb/list</a></p>
<p><img src="//static.tianyichuxin.com/images/29344/27.png" alt=""></p>
<h2 id="typeORM操作Mysql数据库"><a href="#typeORM操作Mysql数据库" class="headerlink" title="typeORM操作Mysql数据库"></a>typeORM操作Mysql数据库</h2><p>mac中，直接使用<code>brew install mysql</code>安装mysql，然后启动服务<code>brew services start mysql</code> 查看服务已经启动<code>ps aux | grep mysql</code></p>
<p>Nest 操作Mysql官方文档：<a href="https://docs.nestjs.com/techniques/database" target="_blank" rel="noopener">https://docs.nestjs.com/techniques/database</a></p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save @nestjs/typeorm typeorm mysql</code></pre>
<p><strong>配置数据库连接地址</strong></p>
<pre class=" language-bash"><code class="language-bash">// src/config/typeorm.ts

const <span class="token punctuation">{</span> MYSQL_HOST, MYSQL_PORT, MYSQL_USER, MYSQL_PASSWORD, MYSQL_DATABASE <span class="token punctuation">}</span> <span class="token operator">=</span>
  process.env<span class="token punctuation">;</span>

const config <span class="token operator">=</span> <span class="token punctuation">{</span>
  type: <span class="token string">'mysql'</span>,
  host: MYSQL_HOST,
  port: MYSQL_PORT,
  username: MYSQL_USER,
  password: MYSQL_PASSWORD,
  database: MYSQL_DATABASE,
  synchronize: process.env.NODE_ENV <span class="token operator">!=</span><span class="token operator">=</span> <span class="token string">'production'</span>, // 生产环境不要开启
  autoLoadEntities: true, // 如果为true,将自动加载实体<span class="token punctuation">(</span>默认：false<span class="token punctuation">)</span>
  keepConnectionAlive: true, // 如果为true，在应用程序关闭后连接不会关闭（默认：false<span class="token punctuation">)</span>
  retryDelay: 3000, // 两次重试连接的间隔<span class="token punctuation">(</span>ms<span class="token punctuation">)</span>（默认：3000）
  retryAttempts: 10, // 重试连接数据库的次数（默认：10）
  dateStrings: <span class="token string">'DATETIME'</span>, // 转化为时间
  timezone: <span class="token string">'+0800'</span>, // +HHMM -HHMM
  // 自动需要导入模型
  entities: <span class="token punctuation">[</span><span class="token string">'dist/**/*.entity{.ts,.js}'</span><span class="token punctuation">]</span>,
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">export</span> default config<span class="token punctuation">;</span></code></pre>
<pre class=" language-bash"><code class="language-bash">// app.module.ts中配置
<span class="token function">import</span> <span class="token punctuation">{</span> resolve, <span class="token function">join</span> <span class="token punctuation">}</span> from <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token function">import</span> <span class="token punctuation">{</span> ConfigModule, ConfigService <span class="token punctuation">}</span> from <span class="token string">'nestjs-config'</span><span class="token punctuation">;</span>
<span class="token function">import</span> <span class="token punctuation">{</span> TypeOrmModule <span class="token punctuation">}</span> from <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>

@Module<span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports: <span class="token punctuation">[</span>
    // 加载配置文件目录
    ConfigModule.load<span class="token punctuation">(</span>resolve<span class="token punctuation">(</span>__dirname, <span class="token string">'config'</span>, <span class="token string">'**/!(*.d).{ts,js}'</span><span class="token punctuation">))</span>,

    // 连接mysql数据库
    TypeOrmModule.forRootAsync<span class="token punctuation">(</span><span class="token punctuation">{</span>
      useFactory: <span class="token punctuation">(</span>config: ConfigService<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> config.get<span class="token punctuation">(</span><span class="token string">'typeorm'</span><span class="token punctuation">)</span>,
      inject: <span class="token punctuation">[</span>ConfigService<span class="token punctuation">]</span>,
    <span class="token punctuation">}</span><span class="token punctuation">)</span>,
  <span class="token punctuation">]</span>,
  controllers: <span class="token punctuation">[</span><span class="token punctuation">]</span>,
  providers: <span class="token punctuation">[</span><span class="token punctuation">]</span>,
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">export</span> class AppModule implements NestModule <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<p><strong>配置实体entity</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// photo.entity.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  ManyToMany<span class="token punctuation">,</span>
  OneToMany<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostsEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./post.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token string">'photo'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PhotoEntity</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// @PrimaryGeneratedColumn()</span>
  <span class="token comment" spellcheck="true">// id: number; // 标记为主列，值自动生成</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> string<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 该值将使用uuid自动生成</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  url<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 多对一关系，多个图片对应一篇文章</span>
  @<span class="token function">ManyToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> PostsEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>post<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> post<span class="token punctuation">.</span>photos<span class="token punctuation">)</span>
  posts<span class="token punctuation">:</span> PostsEntity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Column<span class="token punctuation">,</span> Entity<span class="token punctuation">,</span> OneToMany<span class="token punctuation">,</span> PrimaryGeneratedColumn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PhotoEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./photo.entity'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> type UserRoleType <span class="token operator">=</span> <span class="token string">'admin'</span> <span class="token operator">|</span> <span class="token string">'editor'</span> <span class="token operator">|</span> <span class="token string">'ghost'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> type postStatus <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// mysql的列类型: type</span>
<span class="token comment" spellcheck="true">/**
 * int, tinyint, smallint, mediumint, bigint, float, double, dec, decimal,
 * numeric, date, datetime, timestamp, time, year, char, varchar, nvarchar,
 * text, tinytext, mediumtext, blob, longtext, tinyblob, mediumblob, longblob, enum,
 * json, binary, geometry, point, linestring, polygon, multipoint, multilinestring,
 * multipolygon, geometrycollection
 */</span>
<span class="token comment" spellcheck="true">/**
 * ColumnOptions中可用选项列表：
 * length: number - 列类型的长度。 例如，如果要创建varchar（150）类型，请指定列类型和长度选项。
  width: number - 列类型的显示范围。 仅用于MySQL integer types(opens new window)
  onUpdate: string - ON UPDATE触发器。 仅用于 MySQL (opens new window).
  nullable: boolean - 在数据库中使列NULL或NOT NULL。 默认情况下，列是nullable：false。
  update: boolean - 指示"save"操作是否更新列值。如果为false，则只能在第一次插入对象时编写该值。 默认值为"true"。
  select: boolean - 定义在进行查询时是否默认隐藏此列。 设置为false时，列数据不会显示标准查询。 默认情况下，列是select：true
  default: string - 添加数据库级列的DEFAULT值。
  primary: boolean - 将列标记为主要列。 使用方式和@ PrimaryColumn相同。
  unique: boolean - 将列标记为唯一列（创建唯一约束）。
  comment: string - 数据库列备注，并非所有数据库类型都支持。
  precision: number - 十进制（精确数字）列的精度（仅适用于十进制列），这是为值存储的最大位数。仅用于某些列类型。
  scale: number - 十进制（精确数字）列的比例（仅适用于十进制列），表示小数点右侧的位数，且不得大于精度。 仅用于某些列类型。
  zerofill: boolean - 将ZEROFILL属性设置为数字列。 仅在 MySQL 中使用。 如果是true，MySQL 会自动将UNSIGNED属性添加到此列。
  unsigned: boolean - 将UNSIGNED属性设置为数字列。 仅在 MySQL 中使用。
  charset: string - 定义列字符集。 并非所有数据库类型都支持。
  collation: string - 定义列排序规则。
  enum: string[]|AnyEnum - 在enum列类型中使用，以指定允许的枚举值列表。 你也可以指定数组或指定枚举类。
  asExpression: string - 生成的列表达式。 仅在MySQL (opens new window)中使用。
  generatedType: "VIRTUAL"|"STORED" - 生成的列类型。 仅在MySQL (opens new window)中使用。
  hstoreType: "object"|"string" -返回HSTORE列类型。 以字符串或对象的形式返回值。 仅在Postgres中使用。
  array: boolean - 用于可以是数组的 postgres 列类型（例如 int []）
  transformer: { from(value: DatabaseType): EntityType, to(value: EntityType): DatabaseType } - 用于将任意类型EntityType的属性编组为数据库支持的类型DatabaseType。
  注意：大多数列选项都是特定于 RDBMS 的，并且在MongoDB中不可用
 */</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token string">'posts'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PostsEntity</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// @PrimaryGeneratedColumn()</span>
  <span class="token comment" spellcheck="true">// id: number; // 标记为主列，值自动生成</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> string<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 该值将使用uuid自动生成</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  title<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token punctuation">:</span> <span class="token number">18</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  author<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'longtext'</span><span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  content<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  cover_url<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  type<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  remark<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'enum'</span><span class="token punctuation">,</span>
    <span class="token keyword">enum</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  status<span class="token punctuation">:</span> postStatus<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'CURRENT_TIMESTAMP'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  create_time<span class="token punctuation">:</span> Date<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'CURRENT_TIMESTAMP'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  update_time<span class="token punctuation">:</span> Date<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'enum'</span><span class="token punctuation">,</span>
    <span class="token keyword">enum</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'editor'</span><span class="token punctuation">,</span> <span class="token string">'ghost'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">'ghost'</span><span class="token punctuation">,</span>
    select<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 定义在进行查询时是否默认隐藏此列</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  role<span class="token punctuation">:</span> UserRoleType<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 一对多关系，一篇文章对应多个图片</span>
  <span class="token comment" spellcheck="true">// 在service中查询使用 .find({relations: ['photos]}) 查询文章对应的图片</span>
  @<span class="token function">OneToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> PhotoEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>photo<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> photo<span class="token punctuation">.</span>posts<span class="token punctuation">)</span>
  photos<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>参数校验</strong></p>
<p>Nest 与 <a href="https://github.com/pleerock/class-validator" target="_blank" rel="noopener">class-validator</a> 配合得很好。这个优秀的库允许您使用基于装饰器的验证。装饰器的功能非常强大，尤其是与 Nest 的 Pipe 功能相结合使用时，因为我们可以通过访问 <code>metatype</code> 信息做很多事情，在开始之前需要安装一些依赖。</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">npm</span> i --save class-validator class-transformer</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// posts.dto.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApiProperty<span class="token punctuation">,</span> ApiPropertyOptional <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/swagger'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IsNotEmpty<span class="token punctuation">,</span> IsNumber<span class="token punctuation">,</span> IsString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CreatePostDto</span> <span class="token punctuation">{</span>
  @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'文章标题必填'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  readonly title<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'缺少作者信息'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  readonly author<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  readonly content<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  readonly cover_url<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'缺少文章类型'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  readonly type<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  readonly remark<span class="token punctuation">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>在控制器对应的Module中配置Model</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TypeOrmModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./posts.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostsController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./posts.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostsEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/post.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>TypeOrmModule<span class="token punctuation">.</span><span class="token function">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span>PostsEntity<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>PostsController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>PostsService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PostsModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p><strong>在服务里面使用@InjectRepository获取数据库Model实现操作数据库</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// posts.services.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpException<span class="token punctuation">,</span> HttpStatus<span class="token punctuation">,</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository<span class="token punctuation">,</span> Not<span class="token punctuation">,</span> Between<span class="token punctuation">,</span> Equal<span class="token punctuation">,</span> Like<span class="token punctuation">,</span> In <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> dayjs <span class="token keyword">from</span> <span class="token string">'dayjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreatePostDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dto/create-post.dto'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UpdatePostDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dto/update-post.dto'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostsEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/post.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PostsRo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./interfaces/posts.interface'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PostsService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>PostsEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly postsRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>PostsEntity<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>post<span class="token punctuation">:</span> CreatePostDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> title <span class="token punctuation">}</span> <span class="token operator">=</span> post<span class="token punctuation">;</span>
    <span class="token keyword">const</span> doc <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> title <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'doc'</span><span class="token punctuation">,</span> doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>doc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token string">'文章标题已存在'</span><span class="token punctuation">,</span> HttpStatus<span class="token punctuation">.</span>BAD_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">:</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">,</span>
      message<span class="token punctuation">:</span> <span class="token string">'创建成功'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 分页查询列表</span>
  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span>query <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// eslint-disable-next-line prefer-const</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> pageSize<span class="token punctuation">,</span> pageNum<span class="token punctuation">,</span> orderBy<span class="token punctuation">,</span> sort<span class="token punctuation">,</span> <span class="token operator">...</span>params <span class="token punctuation">}</span> <span class="token operator">=</span> query<span class="token punctuation">;</span>
    orderBy <span class="token operator">=</span> query<span class="token punctuation">.</span>orderBy <span class="token operator">||</span> <span class="token string">'create_time'</span><span class="token punctuation">;</span>
    sort <span class="token operator">=</span> query<span class="token punctuation">.</span>sort <span class="token operator">||</span> <span class="token string">'DESC'</span><span class="token punctuation">;</span>
    pageSize <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>pageSize <span class="token operator">||</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pageNum <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>pageNum <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'query'</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> queryParams <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> any<span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        queryParams<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Like</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`%</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 所有字段支持模糊查询、%%之间不能有空格</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> qb <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// qb.where({ status: In([2, 3]) });</span>
    qb<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>queryParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// qb.select(['post.title', 'post.content']); // 查询部分字段返回</span>
    qb<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`post.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>orderBy<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> sort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    qb<span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>pageSize <span class="token operator">*</span> <span class="token punctuation">(</span>pageNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qb<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      list<span class="token punctuation">:</span> <span class="token keyword">await</span> qb<span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      totalNum<span class="token punctuation">:</span> <span class="token keyword">await</span> qb<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 按条件查询的数量</span>
      total<span class="token punctuation">:</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 总的数量</span>
      pageSize<span class="token punctuation">,</span>
      pageNum<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 根据ID查询详情</span>
  <span class="token keyword">async</span> <span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>PostsEntity<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 更新</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> string<span class="token punctuation">,</span> updatePostDto<span class="token punctuation">:</span> UpdatePostDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> existRecord <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>existRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`id为</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">的文章不存在`</span></span><span class="token punctuation">,</span> HttpStatus<span class="token punctuation">.</span>BAD_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// updatePostDto覆盖existRecord 合并，可以更新单个字段</span>
    <span class="token keyword">const</span> updatePost <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>existRecord<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>updatePostDto<span class="token punctuation">,</span>
      update_time<span class="token punctuation">:</span> <span class="token function">dayjs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD HH:mm:ss'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">:</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>updatePost<span class="token punctuation">)</span><span class="token punctuation">,</span>
      message<span class="token punctuation">:</span> <span class="token string">'更新成功'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 删除</span>
  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> existPost <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>existPost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`文章ID </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 不存在`</span></span><span class="token punctuation">,</span> HttpStatus<span class="token punctuation">.</span>BAD_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postsRepository<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>existPost<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span>
      message<span class="token punctuation">:</span> <span class="token string">'删除成功'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="nest统一处理数据库操作的查询结果"><a href="#nest统一处理数据库操作的查询结果" class="headerlink" title="nest统一处理数据库操作的查询结果"></a>nest统一处理数据库操作的查询结果</h2><blockquote>
<p>操作数据库时，如何做异常处异常？ 比如id不存在，用户名已经存在？如何统一处理请求失败和请求成功？</p>
</blockquote>
<p><strong>处理方式</strong>：</p>
<ul>
<li>在nest中，一般是在<strong>service</strong>中处理异常，如果有异常，直接抛出错误，由<strong>过滤器</strong>捕获，统一格式返回，如果成功，service把结果返回，controller直接return结果即可，由<strong>拦截器</strong>捕获，统一格式返回</li>
<li>失败：过滤器统一处理</li>
<li>成功：拦截器统一处理</li>
<li>当然你也可以在<code>controller</code>处理</li>
</ul>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// user.controller.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  HttpCode<span class="token punctuation">,</span>
  HttpStatus<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.service'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly userService<span class="token punctuation">:</span> UserService<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">HttpCode</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//创建成功返回的是201状态码，这里重置为200，需要用到的可以使用HttpCode设置</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// user.service.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> HttpException<span class="token punctuation">,</span> HttpStatus <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> username <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//如果用户名已经存在，抛出错误</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'请求失败'</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> <span class="token string">'用户名已存在'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        HttpStatus<span class="token punctuation">.</span>BAD_REQUEST<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//如果用户id不存在，抛出错误</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'请求失败'</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> <span class="token string">'用户id不存在'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        HttpStatus<span class="token punctuation">.</span>BAD_REQUEST<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p>可以将<code>HttpException</code>再简单封装一下，或者使用继承，这样代码更简洁一些</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> HttpException<span class="token punctuation">,</span> HttpStatus <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ToolsService</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">fail</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> status <span class="token operator">=</span> HttpStatus<span class="token punctuation">.</span>BAD_REQUEST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        message<span class="token punctuation">:</span> <span class="token string">'请求失败'</span><span class="token punctuation">,</span>
        error<span class="token punctuation">:</span> error<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      status<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>简洁代码</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// user.service.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> HttpException<span class="token punctuation">,</span> HttpStatus <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ToolsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../utils/tools.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> username <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户名已存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>全局使用filter过滤器</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/common/filters/http-execption.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  ArgumentsHost<span class="token punctuation">,</span>
  Catch<span class="token punctuation">,</span>
  ExceptionFilter<span class="token punctuation">,</span>
  HttpException<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HttpExceptionFilter</span> <span class="token keyword">implements</span> <span class="token class-name">ExceptionFilter</span> <span class="token punctuation">{</span>
  <span class="token keyword">catch</span><span class="token punctuation">(</span>exception<span class="token punctuation">:</span> HttpException<span class="token punctuation">,</span> host<span class="token punctuation">:</span> ArgumentsHost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> host<span class="token punctuation">.</span><span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> status <span class="token operator">=</span> exception<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> exceptionRes<span class="token punctuation">:</span> any <span class="token operator">=</span> exception<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> error<span class="token punctuation">,</span> message <span class="token punctuation">}</span> <span class="token operator">=</span> exceptionRes<span class="token punctuation">;</span>

    <span class="token keyword">const</span> msgLog <span class="token operator">=</span> <span class="token punctuation">{</span>
      status<span class="token punctuation">,</span>
      message<span class="token punctuation">,</span>
      error<span class="token punctuation">,</span>
      path<span class="token punctuation">:</span> request<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      timestamp<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>msgLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>全局使用interceptor拦截器</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/common/inteptors/transform.interceptor.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  CallHandler<span class="token punctuation">,</span>
  ExecutionContext<span class="token punctuation">,</span>
  Injectable<span class="token punctuation">,</span>
  NestInterceptor<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> map <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">NestInterceptor</span> <span class="token punctuation">{</span>
  <span class="token function">intercept</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> ExecutionContext<span class="token punctuation">,</span> next<span class="token punctuation">:</span> CallHandler<span class="token punctuation">)</span><span class="token punctuation">:</span> Observable<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          status<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
          message<span class="token punctuation">:</span> <span class="token string">'请求成功'</span><span class="token punctuation">,</span>
          data<span class="token punctuation">:</span> data<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// main.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpExceptionFilter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./common/filters/http-exception.filter'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TransformInterceptor <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./common/interceptors/transform.interceptor'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 创建实例</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span>create<span class="token operator">&lt;</span>NestExpressApplication<span class="token operator">></span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 全局过滤器</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalFilters</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpExceptionFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 全局拦截器</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalInterceptors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransformInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 启动端口</span>
  <span class="token keyword">const</span> PORT <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>PORT <span class="token operator">||</span> <span class="token number">9000</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>PORT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
    Logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`服务已经启动 http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>PORT<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>失败</p>
<p><img src="//static.tianyichuxin.com/images/29344/28.png" alt=""></p>
<p>成功</p>
<p><img src="//static.tianyichuxin.com/images/29344/29.png" alt=""></p>
<h2 id="数据库实体设计与操作"><a href="#数据库实体设计与操作" class="headerlink" title="数据库实体设计与操作"></a>数据库实体设计与操作</h2><blockquote>
<p>typeorm的数据库实体如何编写？<br>数据库实体的监听装饰器如何使用？</p>
</blockquote>
<h3 id="实体设计"><a href="#实体设计" class="headerlink" title="实体设计"></a>实体设计</h3><p>简单例子：下面讲解</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Entity<span class="token punctuation">,</span> PrimaryGeneratedColumn<span class="token punctuation">,</span> Column<span class="token punctuation">,</span> CreateDateColumn<span class="token punctuation">,</span> UpdateDateColumn<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'users'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 默认是int(11)类型</span>

    @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    username<span class="token punctuation">:</span> string<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 默认是varchar(255)类型</span>

    @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

    @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    status<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>

    @<span class="token function">CreateDateColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    created_at<span class="token punctuation">:</span>date<span class="token punctuation">;</span>

    @<span class="token function">UpdateDateColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    updated_at<span class="token punctuation">:</span>date<span class="token punctuation">;</span>

    @<span class="token function">DeleteDateColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    deleted_at<span class="token punctuation">:</span>date<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>装饰器说明</strong></p>
<ul>
<li><code>Entity</code> 实体声明，程序运行时，自动创建的数据库表，<code>@Entity({ name: 'users' })</code>， <code>name</code>则是给该表命名，否则自动命名</li>
<li><code>PrimaryColumn</code> 设置主键，没有自增</li>
<li><code>PrimaryGeneratedColumn</code> 设置主键和自增，一般是<code>id</code></li>
<li><code>Column</code> 设置数据库列字段，在下面说明</li>
<li><code>CreateDateColumn</code> 创建时间，自动填写</li>
<li><code>UpdateDateColumn</code> 更新时间，自动填写</li>
<li><code>DeleteDateColumn</code> 删除时间，自动填写</li>
</ul>
<p><strong>列字段参数</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 写法：</span>
@<span class="token function">Column</span><span class="token punctuation">(</span><span class="token string">"int"</span><span class="token punctuation">)</span>
@<span class="token function">Column</span><span class="token punctuation">(</span><span class="token string">"varchar"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> length<span class="token punctuation">:</span> <span class="token number">200</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
@<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">"int"</span><span class="token punctuation">,</span> length<span class="token punctuation">:</span> <span class="token number">200</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 一般采用这种</span>


<span class="token comment" spellcheck="true">// 常用选项参数：</span>
@<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//  列的数据类型，参考mysql</span>
    name<span class="token punctuation">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// 数据库表中的列名，string，如果和装饰的字段是一样的可以不指定</span>
    length<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 列类型的长度，number</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 是否允许为空，boolean，默认值是false</span>
    select：<span class="token boolean">false</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// 查询数据库时是否显示该字段，boolean，默认值是true，密码一般使用false</span>
    comment<span class="token punctuation">:</span> <span class="token string">'密码'</span>     <span class="token comment" spellcheck="true">// 数据库注释，stirng</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
password<span class="token punctuation">:</span>string<span class="token punctuation">;</span>

@<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span><span class="token string">'varchar'</span><span class="token punctuation">,</span>  
    unique<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// 将列标记为唯一列，唯一约束，比如账号不能有相同的</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
username<span class="token punctuation">:</span>string<span class="token punctuation">;</span>

@<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span><span class="token string">'tinyint'</span><span class="token punctuation">,</span>  
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 默认值，创建时自动填写的值</span>
    comment<span class="token punctuation">:</span> <span class="token string">'0：禁用，1：可用'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
status<span class="token punctuation">:</span>number<span class="token punctuation">;</span>

@<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'enum'</span><span class="token punctuation">,</span>
    <span class="token keyword">enum</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'male'</span><span class="token punctuation">,</span> <span class="token string">'female'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// 枚举类型，只能是数组中的值</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">'male'</span>   默认值          
<span class="token punctuation">}</span><span class="token punctuation">)</span>
gender<span class="token punctuation">:</span>string<span class="token punctuation">;</span></code></pre>
<p><strong>完整例子</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
  CreateDateColumn<span class="token punctuation">,</span>
  UpdateDateColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'users'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersEntity</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span>
    length<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    unique<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span> 
    length<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> 
    select<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'密码'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span>
    length<span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
    select<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'手机号码'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  mobile<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span>
    length<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
    select<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'邮箱'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  email<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'enum'</span><span class="token punctuation">,</span>
    <span class="token keyword">enum</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'male'</span><span class="token punctuation">,</span> <span class="token string">'female'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">'male'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  gender<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'tinyint'</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'0：禁用，1：可用'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  status<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">CreateDateColumn</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'created_at'</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  createdAt<span class="token punctuation">:</span> Date<span class="token punctuation">;</span>

  @<span class="token function">UpdateDateColumn</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'updated_at'</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'更新时间'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  updatedAt<span class="token punctuation">:</span> Date<span class="token punctuation">;</span>

  @<span class="token function">DeleteDateColumn</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'deleted_at'</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'删除时间'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  deletedAt<span class="token punctuation">:</span> Date<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="//static.tianyichuxin.com/images/29344/30.png" alt=""></p>
<h3 id="抽离部分重复的字段：使用继承"><a href="#抽离部分重复的字段：使用继承" class="headerlink" title="抽离部分重复的字段：使用继承"></a><strong>抽离部分重复的字段：使用继承</strong></h3><blockquote>
<pre><code>baseEntity`：将id，创建时间，更新时间，删除时间抽离成`BaseEntity</code></pre></blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Entity<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
  CreateDateColumn<span class="token punctuation">,</span>
  UpdateDateColumn<span class="token punctuation">,</span>
  DeleteDateColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">CreateDateColumn</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'created_at'</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  createdAt<span class="token punctuation">:</span> Date<span class="token punctuation">;</span>

  @<span class="token function">UpdateDateColumn</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'updated_at'</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'更新时间'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  updatedAt<span class="token punctuation">:</span> Date<span class="token punctuation">;</span>

  @<span class="token function">DeleteDateColumn</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'deleted_at'</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'删除时间'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  deletedAt<span class="token punctuation">:</span> Date<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><code>users</code>表继承自<code>baseEntity</code>，就不需要写创建时间，修改时间，自增<code>ID</code>等重复字段了。其他的表也可以继承自<code>baseEntity</code>，减少重复代码</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Column<span class="token punctuation">,</span>Entity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.baseEntity'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'users'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersEntity</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 继承</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span>
    length<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    unique<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span> 
    length<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> 
    select<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'密码'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span>
    length<span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
    select<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'手机号码'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  mobile<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span>
    length<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
    select<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    nullable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'邮箱'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  email<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'enum'</span><span class="token punctuation">,</span>
    <span class="token keyword">enum</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'male'</span><span class="token punctuation">,</span> <span class="token string">'female'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">'male'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  gender<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'tinyint'</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">,</span>
    comment<span class="token punctuation">:</span> <span class="token string">'0：禁用，1：可用'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  status<span class="token punctuation">:</span> number<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="实体监听装饰器"><a href="#实体监听装饰器" class="headerlink" title="实体监听装饰器"></a><strong>实体监听装饰器</strong></h3><ul>
<li>其实是typeorm在操作数据库时的生命周期，可以更方便的操作数据</li>
<li>查找后：<code>@AfterLoad</code></li>
<li>插入前：<code>@BeforeInsert</code></li>
<li>插入后：<code>@AfterInsert</code></li>
<li>更新前：<code>@BeforeUpdate</code></li>
<li>更新后：<code>@AfterUpdate</code></li>
<li>删除前：<code>@BeforeRemove</code></li>
</ul>
<blockquote>
<p><code>AfterLoad</code>例子：其他的装饰器是一样的用法</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  AfterLoad<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>


@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'users'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersEntity</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{</span>

  <span class="token comment" spellcheck="true">// 查找后，如果age小于20，让age = 20</span>
  @<span class="token function">AfterLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 装饰器固定写</span>
  <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 函数名字随你定义</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'tinyint'</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">18</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  age<span class="token punctuation">:</span> number<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">// 使用生命周期前是18，查找后就变成了20</span>
<span class="token punctuation">{</span>
    <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"请求成功"</span><span class="token punctuation">,</span>
    <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
        <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="typeorm增删改查操作"><a href="#typeorm增删改查操作" class="headerlink" title="typeorm增删改查操作"></a>typeorm增删改查操作</h2><blockquote>
<p>访问数据库的方式有哪些？<br>typeorm增删改查操作的方式有哪些？</p>
</blockquote>
<h3 id="多种访问数据库的方式"><a href="#多种访问数据库的方式" class="headerlink" title="多种访问数据库的方式"></a><strong>多种访问数据库的方式</strong></h3><p>第一种：<code>Connection</code></p>
<pre class=" language-js"><code class="language-js">mport <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Connection <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> readonly connection<span class="token punctuation">:</span> Connection<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 使用封装好方法：</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connection
      <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 使用createQueryBuilder：</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connection
      <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'user.id = :id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>第二种：<code>Repository</code>，需要<code>@nestjs/typeorm</code>的<code>InjectRepository</code>来注入实体</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
      @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>  注入实体
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 使用封装好方法：</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 使用createQueryBuilder：</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository
      <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id = :id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>第三种：<code>getConnection()</code>：语法糖，是<code>Connection</code>类型</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getConnection <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 使用封装好方法：</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 使用createQueryBuilder：</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'user.id = :id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>第四种：<code>getRepository</code>：语法糖</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 使用封装好方法：</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 使用createQueryBuilder：</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'user.id = :id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>第五种：<code>getManager</code></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getManager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 使用封装好方法：</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 使用createQueryBuilder：</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'user.id = :id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>简单总结</strong></p>
<p>使用的方式太多，建议使用：<code>2，4</code>，比较方便</p>
<p><strong>Connection核心类：</strong></p>
<ul>
<li><code>connection</code> 等于<code>getConnection</code></li>
<li><code>connection.manager</code> 等于<code>getManager</code>， 等于<code>getConnection.manager</code></li>
<li><code>connection.getRepository</code> 等于<code>getRepository</code>， 等于<code>getManager.getRepository</code></li>
<li><code>connection.createQueryBuilder</code> 使用<code>QueryBuilder</code></li>
<li><code>connection.createQueryRunner</code> 开启事务</li>
</ul>
<ol>
<li><code>EntityManager</code> 和 <code>Repository</code>都封装了操作数据的方法，注意：两者的使用方式是不一样的，（实在不明白搞这么多方法做什么，学得头大）<br><code>getManager</code>是<code>EntityManager</code>的类型，<code>getRepository</code>是<code>Repository</code>的类型</li>
<li>都可以使用<code>createQueryBuilder</code>，但使用的方式略有不同</li>
</ol>
<h3 id="增删改查的三种方式"><a href="#增删改查的三种方式" class="headerlink" title="增删改查的三种方式"></a><strong>增删改查的三种方式</strong></h3><ul>
<li>第一种：使用sql语句，适用于sql语句熟练的同学</li>
<li>第二种：<code>typeorm</code>封装好的方法，增删改 + 简单查询</li>
<li>第三种：<code>QueryBuilder</code>查询生成器，适用于关系查询，多表查询，复杂查询</li>
<li>其实底层最终都会生成<code>sql</code>语句，只是封装了几种方式而已，方便人们使用。</li>
</ul>
<p><strong>第一种：sql语句</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'select * from users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 在query中填写sql语句</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>第二种：typeorm封装好的api方法</strong></p>
<p>这里使用第二种访问数据库的方式</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findAndCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 封装好的方法</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>api方法</strong></p>
<pre class=" language-bash"><code class="language-bash">增
save<span class="token punctuation">(</span>user<span class="token punctuation">)</span>            创建：返回该数据的所有字段
insert<span class="token punctuation">(</span>user<span class="token punctuation">)</span>          快速插入一条数据，插入成功：返回插入实体，与save方法不同的是，它不执行级联、关系和其他操作。
删
remove<span class="token punctuation">(</span>user<span class="token punctuation">)</span>          删除：返回该数据的可见字段
softRemove<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>     拉黑：返回该数据的可见字段，该删除实体必须拥有@DeleteDateColumn<span class="token punctuation">(</span><span class="token punctuation">)</span>字段，被拉黑的用户还存在数据库中，但无法被find查找到，会在@DeleteDateColumn<span class="token punctuation">(</span><span class="token punctuation">)</span>字段中添加删除时间，可使用recover恢复
改
update<span class="token punctuation">(</span>id, user<span class="token punctuation">)</span>      更新：返回更新实体，不是该数据的字段
恢复
recover<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function">id</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>       恢复：返回id，将被softRemove删除（拉黑）的用户恢复，恢复成功后可以被find查找到


查找全部
find<span class="token punctuation">(</span><span class="token punctuation">)</span>
find<span class="token punctuation">(</span><span class="token punctuation">{</span>id:9<span class="token punctuation">}</span><span class="token punctuation">)</span>                   条件查找，写法一，找不到返回空对象
find<span class="token punctuation">(</span><span class="token punctuation">{</span>where:<span class="token punctuation">{</span>id:10<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>          条件查找，写法二，找不到返回空对象
findAndCount<span class="token punctuation">(</span><span class="token punctuation">)</span>                 返回数据和总的条数

查找一个
findOne<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>                       根据ID查找，找不到返回undefined
findOne<span class="token punctuation">(</span><span class="token punctuation">{</span> where: <span class="token punctuation">{</span> username <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  条件查找，找不到返回undefined

根据ID查找一个或多个
findByIds<span class="token punctuation">(</span><span class="token punctuation">[</span>1,2,3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            查找n个，全部查找不到返回空数组，找到就返回找到的

其他
hasId<span class="token punctuation">(</span>new UsersEntity<span class="token punctuation">(</span><span class="token punctuation">))</span>       检测实体是否有合成ID，返回布尔值
getId<span class="token punctuation">(</span>new UsersEntity<span class="token punctuation">(</span><span class="token punctuation">))</span>       获取实体的合成ID，获取不到返回undefined
create<span class="token punctuation">(</span><span class="token punctuation">{</span>username: <span class="token string">'admin12345'</span>, password: <span class="token string">'123456'</span>,<span class="token punctuation">}</span><span class="token punctuation">)</span>  创建一个实体，需要调用save保存
count<span class="token punctuation">(</span><span class="token punctuation">{</span> status: 1 <span class="token punctuation">}</span><span class="token punctuation">)</span>           计数，返回数量，无返回0
increment<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function">id</span> <span class="token punctuation">}</span>, <span class="token string">'age'</span>, 2<span class="token punctuation">)</span><span class="token punctuation">;</span>   增加，给条件为id的数据的age字段增加2，成功返回改变实体
decrement<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function">id</span> <span class="token punctuation">}</span>, <span class="token string">'age'</span>, 2<span class="token punctuation">)</span>    减少，给条件为id的数据的age字段增加2，成功返回改变实体

谨用
findOneOrFail<span class="token punctuation">(</span>id<span class="token punctuation">)</span>              找不到直接报500错误，无法使用过滤器拦截错误，不要使用
clear<span class="token punctuation">(</span><span class="token punctuation">)</span>                        清空该数据表，谨用！！！</code></pre>
<p><strong>find更多参数</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>userRepository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    select<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"firstName"</span><span class="token punctuation">,</span> <span class="token string">"lastName"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             要的字段
    relations<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"photos"</span><span class="token punctuation">,</span> <span class="token string">"videos"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>               关系查询
    where<span class="token punctuation">:</span> <span class="token punctuation">{</span>                                       条件查询
        firstName<span class="token punctuation">:</span> <span class="token string">"Timber"</span><span class="token punctuation">,</span>
        lastName<span class="token punctuation">:</span> <span class="token string">"Saw"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    where<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> username<span class="token punctuation">:</span> <span class="token string">"li"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> username<span class="token punctuation">:</span> <span class="token string">"joy"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   多个条件or<span class="token punctuation">,</span> 等于：where username <span class="token operator">=</span> <span class="token string">'li'</span> or username <span class="token operator">=</span> <span class="token string">'joy'</span>
    order<span class="token punctuation">:</span> <span class="token punctuation">{</span>                                       排序
        name<span class="token punctuation">:</span> <span class="token string">"ASC"</span><span class="token punctuation">,</span>
        id<span class="token punctuation">:</span> <span class="token string">"DESC"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    skip<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>                                       偏移量
    take<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>                                      每页条数
    cache<span class="token punctuation">:</span> <span class="token number">60000</span>                                   启用缓存：<span class="token number">1</span>分钟
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>find进阶选项</strong></p>
<p>TypeORM 提供了许多内置运算符，可用于创建更复杂的查询</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Not<span class="token punctuation">,</span> Between<span class="token punctuation">,</span> In <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token function">Not</span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
将执行以下查询：
SELECT <span class="token operator">*</span> FROM <span class="token string">"users"</span> WHERE <span class="token string">"username"</span> <span class="token operator">!=</span> <span class="token string">'admin'</span>


<span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    likes<span class="token punctuation">:</span> <span class="token function">Between</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SELECT <span class="token operator">*</span> FROM <span class="token string">"users"</span> WHERE <span class="token string">"likes"</span> BETWEEN <span class="token number">1</span> AND <span class="token number">10</span>


<span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token function">In</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'admin2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SELECT <span class="token operator">*</span> FROM <span class="token string">"users"</span> WHERE <span class="token string">"title"</span> IN <span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'admin2'</span><span class="token punctuation">)</span>
</code></pre>
<p><a href="https://typeorm.biunav.com/zh/find-options.html#进阶选项" target="_blank" rel="noopener">更多查看官网</a></p>
<p><strong>第三种</strong>：<code>QueryBuilder</code>查询生成器</p>
<p>使用链式操作</p>
<p><strong>QueryBuilder增，删，改</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 增加</span>
<span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                       声明插入操作
  <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>              插入的实体
  <span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">[</span>                       插入的值，可插入多个
    <span class="token punctuation">{</span> username<span class="token punctuation">:</span> <span class="token string">'Timber'</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token string">'123456'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> username<span class="token punctuation">:</span> <span class="token string">'Timber2'</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token string">'123456'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     执行


<span class="token comment" spellcheck="true">// 修改</span>
<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">:</span> <span class="token string">'admin22'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id = :id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment" spellcheck="true">// 删除</span>
<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id = :id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment" spellcheck="true">// 处理异常：请求成功会返回一个对象， 如果raw.affectedRows != 0 就是成功</span>
<span class="token string">"raw"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"fieldCount"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string">"affectedRows"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token string">"insertId"</span><span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span>
      <span class="token string">"serverStatus"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token string">"warningCount"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"&amp;Records: 2  Duplicates: 0  Warnings: 0"</span><span class="token punctuation">,</span>
      <span class="token string">"protocol41"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string">"changedRows"</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>查询</strong></p>
<p>简单例子</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository
    <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>                      创建生成器，参数：别名
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'user.id = :id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span>              条件
    <span class="token punctuation">.</span><span class="token function">innerJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">'user.avatar'</span><span class="token punctuation">,</span> <span class="token string">'avatar'</span><span class="token punctuation">)</span>     关系查询
    <span class="token punctuation">.</span><span class="token function">addSelect</span><span class="token punctuation">(</span><span class="token string">'user.password'</span><span class="token punctuation">)</span>                      添加显示字段
    <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       获取一条数据
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>QueryBuilder查询生成器说明</strong></p>
<p>查询单表</p>
<pre class=" language-js"><code class="language-js">访问数据库的方式不同：

方式一：没有指定实体，需要使用<span class="token keyword">from</span>指定实体
<span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'user.username'</span><span class="token punctuation">)</span>             ‘user’：全部字段，‘user<span class="token punctuation">.</span>username’：只获取username
      <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">)</span>           参<span class="token number">1</span>：连接的实体， 参<span class="token number">2</span>：别名
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'user.id = :id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

方式二：指定实体：默认获取全部字段
<span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">)</span>   指定实体
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'user.id = :id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

方式三： 已经在访问时指定了实体：默认获取全部字段
<span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository
      <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>          别名
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'user.id = :id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>获取结果</p>
<pre class=" language-js"><code class="language-js"><span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          获取实际执行的sql语句，用于开发时检查问题
<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          获取一条数据（经过typeorm的字段处理）
<span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         获取多条数据
<span class="token punctuation">.</span><span class="token function">getRawOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       获取一条原数据（没有经过typeorm的字段处理）
<span class="token punctuation">.</span><span class="token function">getRawMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      获取多条原数据
<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          返回流数据

如：经过typeorm的字段处理，获取到的就是实体设计时的字段
<span class="token punctuation">{</span>
    <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"请求成功"</span><span class="token punctuation">,</span>
    <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
        <span class="token string">"gender"</span><span class="token punctuation">:</span> <span class="token string">"male"</span><span class="token punctuation">,</span>
        <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
        <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"createdAt"</span><span class="token punctuation">:</span> <span class="token string">"2021-04-26T09:58:54.469Z"</span><span class="token punctuation">,</span>
        <span class="token string">"updatedAt"</span><span class="token punctuation">:</span> <span class="token string">"2021-04-28T14:47:36.000Z"</span><span class="token punctuation">,</span>
        <span class="token string">"deletedAt"</span><span class="token punctuation">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

如：没有经过typeorm的字段处理，将数据库的字段原生不动的显示出来
<span class="token punctuation">{</span>
    <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"请求成功"</span><span class="token punctuation">,</span>
    <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"user_username"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
        <span class="token string">"user_gender"</span><span class="token punctuation">:</span> <span class="token string">"male"</span><span class="token punctuation">,</span>
        <span class="token string">"user_age"</span><span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
        <span class="token string">"user_status"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"user_created_at"</span><span class="token punctuation">:</span> <span class="token string">"2021-04-26T09:58:54.469Z"</span><span class="token punctuation">,</span>
        <span class="token string">"user_updated_at"</span><span class="token punctuation">:</span> <span class="token string">"2021-04-28T14:47:36.000Z"</span><span class="token punctuation">,</span>
        <span class="token string">"user_deleted_at"</span><span class="token punctuation">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>查询部分字段</p>
<pre class=" language-js"><code class="language-js"><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"user.id"</span><span class="token punctuation">,</span> <span class="token string">"user.name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
实际执行的sql语句：SELECT user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user<span class="token punctuation">.</span>name FROM users user；

添加隐藏字段：实体中设置select为<span class="token boolean">false</span>时，是不显示字段，使用addSelect会将字段显示出来
<span class="token punctuation">.</span><span class="token function">addSelect</span><span class="token punctuation">(</span><span class="token string">'user.password'</span><span class="token punctuation">)</span></code></pre>
<p><code>where</code>条件</p>
<pre class=" language-js"><code class="language-js"><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"user.name = :name"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"joy"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
等于
<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"user.name = :name"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"Timber"</span><span class="token punctuation">)</span>
实际执行的sql语句：SELECT <span class="token operator">*</span> FROM users user WHERE user<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'joy'</span>

多个条件
<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"user.firstName = :firstName"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">"Timber"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token string">"user.lastName = :lastName"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> lastName<span class="token punctuation">:</span> <span class="token string">"Saw"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
实际执行的sql语句：SELECT <span class="token operator">*</span> FROM users user WHERE user<span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Timber'</span> AND user<span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">'Saw'</span>

<span class="token keyword">in</span>
<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"user.name IN (:...names)"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> names<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"Timber"</span><span class="token punctuation">,</span> <span class="token string">"Cristal"</span><span class="token punctuation">,</span> <span class="token string">"Lina"</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
实际执行的sql语句：SELECT <span class="token operator">*</span> FROM users user WHERE user<span class="token punctuation">.</span>name IN <span class="token punctuation">(</span><span class="token string">'Timber'</span><span class="token punctuation">,</span> <span class="token string">'Cristal'</span><span class="token punctuation">,</span> <span class="token string">'Lina'</span><span class="token punctuation">)</span>

or
<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"user.firstName = :firstName"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">"Timber"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token string">"user.lastName = :lastName"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> lastName<span class="token punctuation">:</span> <span class="token string">"Saw"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
实际执行的sql语句：SELECT <span class="token operator">*</span> FROM users user WHERE user<span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Timber'</span> OR user<span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">'Saw'</span>

子句
<span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> connection
  <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>Post<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">"post"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>qb <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> subQuery <span class="token operator">=</span> qb
      <span class="token punctuation">.</span><span class="token function">subQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"user.name"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"user.registered = :registered"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"post.title IN "</span> <span class="token operator">+</span> subQuery<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token string">"registered"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
实际执行的sql语句：select <span class="token operator">*</span> <span class="token keyword">from</span> post where post<span class="token punctuation">.</span>title <span class="token keyword">in</span> <span class="token punctuation">(</span>select name <span class="token keyword">from</span> user where registered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></code></pre>
<p><code>having</code>筛选</p>
<pre class=" language-js"><code class="language-js"><span class="token punctuation">.</span><span class="token function">having</span><span class="token punctuation">(</span><span class="token string">"user.firstName = :firstName"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">"Timber"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">andHaving</span><span class="token punctuation">(</span><span class="token string">"user.lastName = :lastName"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> lastName<span class="token punctuation">:</span> <span class="token string">"Saw"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
实际执行的sql语句：SELECT <span class="token operator">...</span> FROM users user HAVING user<span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Timber'</span> AND user<span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">'Saw'</span></code></pre>
<p><code>orderBy</code>排序</p>
<pre class=" language-js"><code class="language-js"><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"user.name"</span><span class="token punctuation">,</span> <span class="token string">"DESC"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">addOrderBy</span><span class="token punctuation">(</span><span class="token string">"user.id"</span><span class="token punctuation">,</span> <span class="token string">"asc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
等于
<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">"user.name"</span><span class="token punctuation">:</span> <span class="token string">"ASC"</span><span class="token punctuation">,</span>
  <span class="token string">"user.id"</span><span class="token punctuation">:</span> <span class="token string">"DESC"</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

实际执行的sql语句：SELECT <span class="token operator">*</span> FROM users user order by user<span class="token punctuation">.</span>name asc<span class="token punctuation">,</span> user<span class="token punctuation">.</span>id desc<span class="token punctuation">;</span></code></pre>
<p><code>group</code>分组</p>
<pre class=" language-js"><code class="language-js"><span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">"user.name"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">addGroupBy</span><span class="token punctuation">(</span><span class="token string">"user.id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>关系查询（多表）</p>
<pre class=" language-js"><code class="language-js"><span class="token number">1</span>参：你要加载的关系，<span class="token number">2</span>参：可选，你为此表分配的别名，<span class="token number">3</span>参：可选，查询条件

左关联查询
<span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">"user.profile"</span><span class="token punctuation">,</span> <span class="token string">"profile"</span><span class="token punctuation">)</span>     

右关联查询
<span class="token punctuation">.</span><span class="token function">rightJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">"user.profile"</span><span class="token punctuation">,</span> <span class="token string">"profile"</span><span class="token punctuation">)</span>    

内联查询
<span class="token punctuation">.</span><span class="token function">innerJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">"user.photos"</span><span class="token punctuation">,</span> <span class="token string">"photo"</span><span class="token punctuation">,</span> <span class="token string">"photo.isRemoved = :isRemoved"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> isRemoved<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>         


例子：
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository
    <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">"user.photos"</span><span class="token punctuation">,</span> <span class="token string">"photo"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"user.name = :name"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"joy"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token string">"photo.isRemoved = :isRemoved"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> isRemoved<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

实际执行的sql语句：
SELECT user<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> photo<span class="token punctuation">.</span><span class="token operator">*</span> 
FROM users user
LEFT JOIN photos photo ON photo<span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">.</span>id
WHERE user<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'joy'</span> AND photo<span class="token punctuation">.</span>isRemoved <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>


<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository
    <span class="token punctuation">.</span><span class="token function">innerJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">"user.photos"</span><span class="token punctuation">,</span> <span class="token string">"photo"</span><span class="token punctuation">,</span> <span class="token string">"photo.isRemoved = :isRemoved"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> isRemoved<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"user.name = :name"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"Timber"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

实际执行的sql语句：
SELECT user<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> photo<span class="token punctuation">.</span><span class="token operator">*</span> FROM users user
INNER JOIN photos photo ON photo<span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">.</span>id AND photo<span class="token punctuation">.</span>isRemoved <span class="token operator">=</span> FALSE
WHERE user<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Timber'</span>；


多个关联
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">"user.profile"</span><span class="token punctuation">,</span> <span class="token string">"profile"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">"user.photos"</span><span class="token punctuation">,</span> <span class="token string">"photo"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">"user.videos"</span><span class="token punctuation">,</span> <span class="token string">"video"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="typeorm使用事务的3种方式"><a href="#typeorm使用事务的3种方式" class="headerlink" title="typeorm使用事务的3种方式"></a>typeorm使用事务的3种方式</h2><p><code>typeorm</code>使用事务的方式有哪些？如何使用？</p>
<p><strong>事务</strong></p>
<blockquote>
<ul>
<li>在操作多个表时，或者多个操作时，如果有一个操作失败，所有的操作都失败，要么全部成功，要么全部失</li>
<li><strong>解决问题</strong>：在多表操作时，因为各种异常导致一个成功，一个失败的数据错误。</li>
</ul>
</blockquote>
<blockquote>
<p>例子：银行转账<br>如果用户1向用户2转了100元，但因为各种原因，用户2没有收到，如果没有事务处理，用户1扣除的100元就凭空消失了<br>如果有事务处理，只有用户2收到100元，用户1才会扣除100元，如果没有收到，则不会扣除。</p>
</blockquote>
<p><strong>应用场景</strong></p>
<blockquote>
<p>多表的增，删，改操作</p>
</blockquote>
<p><strong>nest-typrorm事务的使用方式</strong></p>
<ol>
<li>使用装饰器，在<code>controller</code>中编写，传递给<code>service</code>使用</li>
<li>使用<code>getManager</code> 或 <code>getConnection</code>，在<code>service</code>中编写与使用</li>
<li>使用<code>connection</code> 或 <code>getConnection</code>，开启<code>queryRunner</code>，在<code>service</code>中编写与使用</li>
</ol>
<p><strong>方式一：使用装饰器</strong></p>
<p>controller</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  ParseIntPipe<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Transaction<span class="token punctuation">,</span> TransactionManager<span class="token punctuation">,</span> EntityManager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>  开启事务第一步：引入
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.service-oto'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly userService<span class="token punctuation">:</span> UserService<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 开启事务第二步：装饰接口
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
    @<span class="token function">TransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> maneger<span class="token punctuation">:</span> EntityManager<span class="token punctuation">,</span>  开启事务第三步：获取事务管理器
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> maneger<span class="token punctuation">)</span><span class="token punctuation">;</span>  开启事务第四步：传递给service，使用数据库时调用
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>service</p>
<ul>
<li>这里处理的是1对1关系：保存头像地址到<code>avatar</code>表，同时关联保存用户的<code>id</code></li>
<li>如果你不会1对1关系，请先去学习对应的知识</li>
</ul>
<p><img src="//static.tianyichuxin.com/images/29344/31.png" alt=""></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository<span class="token punctuation">,</span> EntityManager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AvatarEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/avatar.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ToolsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../utils/tools.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span><span class="token punctuation">,</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>AvatarEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly avatarRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>AvatarEntity<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> number<span class="token punctuation">,</span> manager<span class="token punctuation">:</span> EntityManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> urlObj <span class="token operator">=</span> <span class="token punctuation">{</span>
      url<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`http://www.dmyxs.com/images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 先查找用户，因为要保存用户的id
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              找不到用户抛出异常

    <span class="token keyword">const</span> avatarEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>avatarRepository<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">:</span> urlObj<span class="token punctuation">.</span>url <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  创建头像地址的实体
    <span class="token keyword">const</span> avatarUrl <span class="token operator">=</span> <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>avatarEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>                      使用事务保存副表
    user<span class="token punctuation">.</span>avatar <span class="token operator">=</span> avatarUrl<span class="token punctuation">;</span>                                                 主表和副表建立关系
    <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>                                                使用事务保存主表
    <span class="token keyword">return</span> <span class="token string">'新增成功'</span><span class="token punctuation">;</span>                                                        如果过程出错，不会保存
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>方式二：使用getManager 或 getConnection</strong></p>
<p>service</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Connection<span class="token punctuation">,</span> Repository<span class="token punctuation">,</span> getManager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AvatarEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/avatar.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ToolsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../utils/tools.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> readonly connection<span class="token punctuation">:</span> Connection<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">test</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> urlObj <span class="token operator">=</span> <span class="token punctuation">{</span>
      url<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`http://www.dmyxs.com/images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>                        先查找用户
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 找不到用户抛出异常

    <span class="token comment" spellcheck="true">//getConnection的方式：await getConnection().transaction(manager=> {});</span>
    <span class="token comment" spellcheck="true">//getManager的方式：</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>manager<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> avatarEntity <span class="token operator">=</span> manager<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AvatarEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span> url<span class="token punctuation">:</span> urlObj<span class="token punctuation">.</span>url <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   创建头像地址的实体
      <span class="token keyword">const</span> avatarUrl <span class="token operator">=</span> <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>AvatarEntity<span class="token punctuation">,</span> avatarEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>         使用事务保存副表
      user<span class="token punctuation">.</span>avatar <span class="token operator">=</span> avatarUrl<span class="token punctuation">;</span>                                                  创建关联
      <span class="token keyword">return</span> <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>                             使用事务保存主表，并返回结果
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">{</span>
    <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"请求成功"</span><span class="token punctuation">,</span>
    <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"createdAt"</span><span class="token punctuation">:</span> <span class="token string">"2021-04-26T09:58:54.469Z"</span><span class="token punctuation">,</span>
        <span class="token string">"updatedAt"</span><span class="token punctuation">:</span> <span class="token string">"2021-04-28T14:47:36.000Z"</span><span class="token punctuation">,</span>
        <span class="token string">"deletedAt"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
        <span class="token string">"gender"</span><span class="token punctuation">:</span> <span class="token string">"male"</span><span class="token punctuation">,</span>
        <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
        <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"avatar"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"http://www.dmyxs.com/images/1.png"</span><span class="token punctuation">,</span>
            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">52</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>方式三：使用 connection 或 getConnection</strong></p>
<p>service</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Connection<span class="token punctuation">,</span> Repository<span class="token punctuation">,</span> getManager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AvatarEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/avatar.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> readonly connection<span class="token punctuation">:</span> Connection<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">test</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> urlObj <span class="token operator">=</span> <span class="token punctuation">{</span>
      url<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`http://www.test.com/images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>         先查找用户
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 找不到用户抛出异常

    <span class="token keyword">const</span> queryRunner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">createQueryRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     获取连接并创建新的queryRunner
    <span class="token keyword">await</span> queryRunner<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 使用我们的新queryRunner建立真正的数据库连
    <span class="token keyword">await</span> queryRunner<span class="token punctuation">.</span><span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        开始事务

    <span class="token keyword">const</span> avatarEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AvatarEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     创建实体：要保存的数据
    avatarEntity<span class="token punctuation">.</span>url <span class="token operator">=</span> urlObj<span class="token punctuation">.</span>url<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> queryRunner<span class="token punctuation">.</span>manager                  使用事务保存到副表
        <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>AvatarEntity<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>avatarEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

      user<span class="token punctuation">.</span>avatar <span class="token operator">=</span> result<span class="token punctuation">;</span>                                     主表和副表建立连接

      <span class="token keyword">const</span> userResult <span class="token operator">=</span> <span class="token keyword">await</span> queryRunner<span class="token punctuation">.</span>manager              使用事务保存到副表
        <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">await</span> queryRunner<span class="token punctuation">.</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   提交事务
      <span class="token keyword">return</span> userResult<span class="token punctuation">;</span>                                       返回结果
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'创建失败，取消事务'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> queryRunner<span class="token punctuation">.</span><span class="token function">rollbackTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 出错回滚
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> queryRunner<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             释放
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="typeorm-一对一关系设计与增删改查"><a href="#typeorm-一对一关系设计与增删改查" class="headerlink" title="typeorm 一对一关系设计与增删改查"></a>typeorm 一对一关系设计与增删改查</h2><p>实体如何设计一对一关系？如何增删改查？</p>
<p><strong>一对一关系</strong></p>
<blockquote>
<ul>
<li>定义：一对一是一种 A 只包含一个 B ，而 B 只包含一个 A 的关系</li>
<li>其实就是要设计两个表：一张是主表，一张是副表，查找主表时，关联查找副表</li>
<li>有外键的表称之为副表，不带外键的表称之为主表</li>
<li>如：一个账户对应一个用户信息，主表是账户，副表是用户信息</li>
<li>如：一个用户对应一张用户头像图片，主表是用户信息，副表是头像地址</li>
</ul>
</blockquote>
<p><strong>一对一实体设计</strong></p>
<p>主表：</p>
<blockquote>
<ul>
<li>使用<code>@OneToOne()</code> 来建立关系</li>
<li>第一个参数：<code>() =&gt; AvatarEntity</code>， 和谁建立关系？ 和<code>AvatarEntity</code>建立关系</li>
<li>第二个参数：<code>(avatar) =&gt; avatar.user)</code>，和哪个字段联立关系？ <code>avatar</code>就是<code>AvatarEntity</code>的别名，可随便写，和<code>AvatarEntity</code>的<code>userinfo</code>字段建立关系</li>
<li>第三个参数：<code>RelationOptions</code>关系选项</li>
</ul>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
  OneToOne<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AvatarEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./avatar.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'users'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersEntity</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">OneToOne</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> AvatarEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>avatar<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> avatar<span class="token punctuation">.</span>userinfo<span class="token punctuation">)</span>
  avatar<span class="token punctuation">:</span> AvatarEntity<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>副表</p>
<blockquote>
<p>参数：同主表一样<br>主要：根据<code>@JoinColumn({ name: ‘user_id’ })</code>来分辨副表，<code>name</code>是设置数据库的外键名字，如果不设置是<code>userId</code></p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Entity<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
  Column<span class="token punctuation">,</span>
  OneToOne<span class="token punctuation">,</span>
  JoinColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'avatar'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AvatarEntity</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'varchar'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  url<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">OneToOne</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> UsersEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> user<span class="token punctuation">.</span>avatar<span class="token punctuation">)</span>
  @<span class="token function">JoinColumn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'userinfo_id'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  userinfo<span class="token punctuation">:</span> UsersEntity<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>一对一增删改查</strong></p>
<blockquote>
<ul>
<li><strong>注意</strong>：只要涉及两种表操作的，就需要开启事务：同时失败或同时成功，避免数据不统一</li>
<li><strong>在这里</strong>：创建，修改，删除都开启了事务</li>
<li><strong>注意</strong>：所有数据应该是由前端传递过来的，这里为了方便，直接硬编码了（写死）</li>
</ul>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// user.controller.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  Patch<span class="token punctuation">,</span>
  Query<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  Delete<span class="token punctuation">,</span>
  HttpCode<span class="token punctuation">,</span>
  HttpStatus<span class="token punctuation">,</span>
  ParseIntPipe<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Transaction<span class="token punctuation">,</span> TransactionManager<span class="token punctuation">,</span> EntityManager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>  开启事务第一步：引入
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.service-oto'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly userService<span class="token punctuation">:</span> UserService<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>data<span class="token punctuation">,</span> count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">HttpCode</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">)</span>
  @<span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 开启事务第二步：装饰接口
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
    @<span class="token function">TransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> maneger<span class="token punctuation">:</span> EntityManager<span class="token punctuation">,</span>  开启事务第三步：获取事务管理器
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> maneger<span class="token punctuation">)</span><span class="token punctuation">;</span>  开启事务第四步：传递给service，使用数据库时调用
  <span class="token punctuation">}</span>

  @<span class="token function">Patch</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
    @<span class="token function">TransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> maneger<span class="token punctuation">:</span> EntityManager<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> maneger<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
    @<span class="token function">TransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> maneger<span class="token punctuation">:</span> EntityManager<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> maneger<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// user.service.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository<span class="token punctuation">,</span> Connection<span class="token punctuation">,</span> UpdateResult<span class="token punctuation">,</span> EntityManager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AvatarEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/avatar.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ToolsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../utils/tools.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span><span class="token punctuation">,</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>AvatarEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly avatarRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>AvatarEntity<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> connection<span class="token punctuation">:</span> Connection<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  一对一增删改查
  查找全部
  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    使用封装好的方式
    <span class="token comment" spellcheck="true">// return await this.usersRepository.findAndCount({ relations: ['avatar'] });</span>

    使用QueryBuilder的方式
    <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository
      <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'UsersEntity'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">'UsersEntity.avatar'</span><span class="token punctuation">,</span> <span class="token string">'AvatarEntity.userinfo'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getManyAndCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  根据主表id查找一对一
  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      relations<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'avatar'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  根据主表id创建一对一
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> number<span class="token punctuation">,</span> manager<span class="token punctuation">:</span> EntityManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> urlObj <span class="token operator">=</span> <span class="token punctuation">{</span>
      url<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`http://www.dmyxs.com/images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      先查找用户
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  如果没找到，抛出错误，由过滤器捕获错误

    创建实体的两种方式：<span class="token keyword">new</span> 和 create，<span class="token keyword">new</span>的方式方便条件判断
    创建实体方式一：
    <span class="token keyword">const</span> avatarEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>avatarRepository<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">:</span> urlObj<span class="token punctuation">.</span>url <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  创建实体

    创建实体方式二：
    <span class="token comment" spellcheck="true">//const avatarEntity = new AvatarEntity();</span>
    <span class="token comment" spellcheck="true">//avatarEntity.url = urlObj.url;</span>

    <span class="token keyword">const</span> avatarUrl <span class="token operator">=</span> <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>avatarEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>          使用事务保存副表
    user<span class="token punctuation">.</span>avatar <span class="token operator">=</span> avatarUrl<span class="token punctuation">;</span>                                     主表和副表建立关系
    <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    使用事务保存主表
    <span class="token keyword">return</span> <span class="token string">'新增成功'</span><span class="token punctuation">;</span>                                            如果过程出错，不会保存
  <span class="token punctuation">}</span>

  根据主表id更改一对一
  要更改的副表id，会从前端传递过来
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> number<span class="token punctuation">,</span> manager<span class="token punctuation">:</span> EntityManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> urlObj <span class="token operator">=</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
      url<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`http://www.dmyxs.com/images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-update.jpg`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>       先查找用户
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      如果没找到id抛出错误，由过滤器捕获错误

    <span class="token keyword">const</span> avatarEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>avatarRepository<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">:</span> urlObj<span class="token punctuation">.</span>url <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    创建要修改的实体

    使用事务更新方法：<span class="token number">1</span>参：要修改的表，<span class="token number">2</span>参：要修改的id， <span class="token number">3</span>参：要更新的数据
    <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>AvatarEntity<span class="token punctuation">,</span> urlObj<span class="token punctuation">.</span>id<span class="token punctuation">,</span> avatarEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token keyword">return</span> <span class="token string">'更新成功'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  根据主表id删除一对一
  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> number<span class="token punctuation">,</span> manager<span class="token punctuation">:</span> EntityManager<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    只删副表的关联数据
    <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>AvatarEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span> user<span class="token punctuation">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    如果连主表用户一起删，加下面这行代码
    <span class="token comment" spellcheck="true">//await manager.delete(UsersEntity, id);</span>
    <span class="token keyword">return</span> <span class="token string">'删除成功'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="typeorm-一对多和多对一关系设计与增删改查"><a href="#typeorm-一对多和多对一关系设计与增删改查" class="headerlink" title="typeorm 一对多和多对一关系设计与增删改查"></a>typeorm 一对多和多对一关系设计与增删改查</h2><p>实体如何设计一对多与多对一关系，如何关联查询</p>
<p><strong>一对多关系，多对一关系</strong></p>
<blockquote>
<p>定义：一对多是一种一个 A 包含多个 B ，而多个B只属于一个 A 的关系<br>其实就是要设计两个表：一张是主表（一对多），一张是副表（多对一），查找主表时，关联查找副表<br>有外键的表称之为副表，不带外键的表称之为主表<br>如：一个用户拥有多个宠物，多个宠物只属于一个用户的（每个宠物只能有一个主人）<br>如：一个用户拥有多张照片，多张照片只属于一个用户的<br>如：一个角色拥有多个用户，多个用户只属于一个角色的（每个用户只能有一个角色）</p>
</blockquote>
<p><strong>一对多和多对一实体设计</strong></p>
<p>一对多</p>
<blockquote>
<p>使用<code>@OneToMany()</code>来建立一对多关系<br>第一个参数：<code>() =&gt; PhotoEntity</code>， 和谁建立关系？ 和<code>PhotoEntity</code>建立关系<br>第二个参数：<code>(user) =&gt; user.photo</code>，和哪个字段联立关系？ <code>user</code>就是<code>PhotoEntity</code>的别名，可随便写，和<code>PhotoEntity</code>的<code>userinfo</code>字段建立关系<br>第三个参数：<code>RelationOptions</code>关系选项</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
  OneToOne<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AvatarEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./avatar.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'users'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersEntity</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">OneToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> PhotoEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>avatar<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> avatar<span class="token punctuation">.</span>userinfo<span class="token punctuation">)</span>
  photos<span class="token punctuation">:</span> PhotoEntity<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>多对一</p>
<blockquote>
<p>使用<code>@ManyToOne()</code>来建立多对一关系，参数如同上</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Entity<span class="token punctuation">,</span> PrimaryGeneratedColumn<span class="token punctuation">,</span> Column<span class="token punctuation">,</span> ManyToOne <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'photo'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PhotoEntity</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'varchar'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  url<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">ManyToOne</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> UsersEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> user<span class="token punctuation">.</span>photos<span class="token punctuation">)</span>
  @<span class="token function">JoinColumn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'userinfo_id'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  userinfo<span class="token punctuation">:</span> UsersEntity<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>一对多和多对一增删改查</strong></p>
<blockquote>
<p>只要涉及两种表操作的，就需要开启事务：同时失败或同时成功，避免数据不统一<br>注意：所有数据应该是由前端传递过来的，这里为了方便，直接硬编码了（写死）<br>比较复杂的是更新操作</p>
</blockquote>
<p>user.controller.ts</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  Patch<span class="token punctuation">,</span>
  Query<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  Delete<span class="token punctuation">,</span>
  HttpCode<span class="token punctuation">,</span>
  HttpStatus<span class="token punctuation">,</span>
  ParseIntPipe<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Transaction<span class="token punctuation">,</span> TransactionManager<span class="token punctuation">,</span> EntityManager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>  开启事务第一步：引入
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.service-oto'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly userService<span class="token punctuation">:</span> UserService<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>data<span class="token punctuation">,</span> count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">HttpCode</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">)</span>
  @<span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 开启事务第二步：装饰接口
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
    @<span class="token function">TransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> maneger<span class="token punctuation">:</span> EntityManager<span class="token punctuation">,</span>  开启事务第三步：获取事务管理器
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> maneger<span class="token punctuation">)</span><span class="token punctuation">;</span>  开启事务第四步：传递给service，使用数据库时调用
  <span class="token punctuation">}</span>

  @<span class="token function">Patch</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
    @<span class="token function">TransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> maneger<span class="token punctuation">:</span> EntityManager<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> maneger<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
    @<span class="token function">TransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> maneger<span class="token punctuation">:</span> EntityManager<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> maneger<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>user.service.ts</p>
<p><strong>令人头大的地方</strong>：建立关系和查找使用实体，删除使用实体的id，感觉设计得不是很合理，违背人的常识</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository<span class="token punctuation">,</span> EntityManager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PhotoEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/photo.entity'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> ToolsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../utils/tools.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span><span class="token punctuation">,</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>PhotoEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly photoRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>PhotoEntity<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  一对多增删改查
  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// return await this.usersRepository.findAndCount({ relations: ['photos'] });</span>

    <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository
      <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'UsersEntity'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">'UsersEntity.photos'</span><span class="token punctuation">,</span> <span class="token string">'PhotoEntity.userinfo'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getManyAndCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  根据主表id查找一对多
  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    查询一个用户有多少张照片（一对多）
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      relations<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'photos'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>

    查询这张照片属于谁（多对一）
    <span class="token comment" spellcheck="true">// const result = await this.photoRepository.findOne(id, {</span>
    <span class="token comment" spellcheck="true">//   relations: ['userinfo'],</span>
    <span class="token comment" spellcheck="true">// });</span>
    <span class="token comment" spellcheck="true">// if (!result) ToolsService.fail('图片id不存在');</span>
    <span class="token comment" spellcheck="true">// return result;</span>
  <span class="token punctuation">}</span>

  根据主表id创建一对多
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> number<span class="token punctuation">,</span> manager<span class="token punctuation">:</span> EntityManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> urlList <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        url<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`http://www.dmyxs.com/images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        url<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`http://www.dmyxs.com/images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.jpg`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    遍历传递过来的数据
    <span class="token keyword">if</span> <span class="token punctuation">(</span>urlList<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> urlList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           创建实体的两种方式：<span class="token keyword">new</span> 和 create，<span class="token keyword">new</span>的方式方便条件判断
           <span class="token comment" spellcheck="true">// const photo = new PhotoEntity();</span>
           <span class="token comment" spellcheck="true">// photo.url = urlList[i].url;</span>
           <span class="token comment" spellcheck="true">// photo.user = user;</span>
           <span class="token comment" spellcheck="true">// await manager.save(PhotoEntity, photo);</span>

           <span class="token keyword">const</span> photoEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>photoRepository<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
             url<span class="token punctuation">:</span> urlList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span>
             userinfo<span class="token punctuation">:</span> user<span class="token punctuation">,</span>  注意：这里是使用实体建立关系，而不是实体id
           <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>photoEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">'新增成功'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  根据主表id更改一对多
  <span class="token function">示例：删除一张，修改一张</span><span class="token punctuation">(</span>修改的有id<span class="token punctuation">)</span>，新增一张
  先使用创建，创建两张photo
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> number<span class="token punctuation">,</span> manager<span class="token punctuation">:</span> EntityManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> urlList <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> <span class="token number">22</span><span class="token punctuation">,</span>
        url<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`http://www.dmyxs.com/images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-update.png`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        url<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`http://www.dmyxs.com/images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-create.jpeg`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    如果要修改主表，先修改主表用户信息，后修改副表图片信息
    修改主表
    <span class="token keyword">const</span> userEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token punctuation">,</span>
      username<span class="token punctuation">:</span> <span class="token string">'admin7'</span><span class="token punctuation">,</span>
      password<span class="token punctuation">:</span> <span class="token string">'123456'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    修改副表
    如果前端附带了图片list
    <span class="token keyword">if</span> <span class="token punctuation">(</span>urlList<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      查询数据库已经有的图片
      <span class="token keyword">const</span> databasePhotos <span class="token operator">=</span> <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>PhotoEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span> userinfo<span class="token punctuation">:</span> user <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      如果有数据，则进行循环判断，先删除多余的数据
      <span class="token keyword">if</span> <span class="token punctuation">(</span>databasePhotos<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> databasePhotos<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

          以用户传递的图片为基准，数据库的图片id是否在用户传递过来的表里，如果不在，就是要删除的数据
          <span class="token keyword">const</span> exist <span class="token operator">=</span> urlList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> item<span class="token punctuation">.</span>id <span class="token operator">===</span> databasePhotos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>PhotoEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> databasePhotos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      否则就是新增和更改的数据
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> urlList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> photoEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhotoEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        photoEntity<span class="token punctuation">.</span>url <span class="token operator">=</span> urlList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>url<span class="token punctuation">;</span>

        如果有id则是修改操作，因为前端传递的数据是从服务端获取的，会附带id，新增的没有
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>urlList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>

          修改则让id关联即可
          photoEntity<span class="token punctuation">.</span>id <span class="token operator">=</span> urlList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">;</span>
          <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>PhotoEntity<span class="token punctuation">,</span> photoEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

          否则是新增操作<span class="token punctuation">,</span>关联用户实体
          photoEntity<span class="token punctuation">.</span>userinfo <span class="token operator">=</span> user<span class="token punctuation">;</span>
          <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>PhotoEntity<span class="token punctuation">,</span> photoEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      如果前端把图片全部删除，删除所有关联的图片
      <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>PhotoEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span> userinfo<span class="token punctuation">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">'更新成功'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  根据主表id删除一对多
  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> number<span class="token punctuation">,</span> manager<span class="token punctuation">:</span> EntityManager<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    只删副表的关联数据
    <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>PhotoEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span> userinfo<span class="token punctuation">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    如果连主表用户一起删，加下面这行代码
    <span class="token comment" spellcheck="true">//await manager.delete(UsersEntity, id);</span>
    <span class="token keyword">return</span> <span class="token string">'删除成功'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="typeorm-多对多关系设计与增删改查"><a href="#typeorm-多对多关系设计与增删改查" class="headerlink" title="typeorm 多对多关系设计与增删改查"></a>typeorm 多对多关系设计与增删改查</h2><blockquote>
<p>实体如何设计多对多关系？如何增删改查？</p>
</blockquote>
<p><strong>多对多关系</strong></p>
<blockquote>
<p>定义：多对多是一种 A 包含多个 B，而 B 包含多个 A 的关系<br>如：一个粉丝可以关注多个主播，一个主播可以有多个粉丝<br>如：一篇文章属于多个分类，一个分类下有多篇文章<br>比如这篇文章，可以放在nest目录，也可以放在typeorm目录或者mysql目录</p>
</blockquote>
<p><strong>实现方式</strong></p>
<blockquote>
<p>第一种：建立两张表，使用装饰器<code>@ManyToMany</code>建立关系，<code>typeorm</code>会自动生成三张表<br>第二种：手动建立3张表</p>
</blockquote>
<p>这里使用第一种</p>
<h3 id="实体设计-1"><a href="#实体设计-1" class="headerlink" title="实体设计"></a><strong>实体设计</strong></h3><p>这里将设计一个用户（粉丝） 与 明星的 多对多关系</p>
<p>用户（粉丝）可以主动关注明星，让<code>users</code>变为主表，加入<code>@JoinTable()</code></p>
<blockquote>
<p>使用<code>@ManyToMany()</code> 来建立多对多关系<br>第一个参数：<code>() =&gt; StarEntity</code>， 和谁建立关系？ 和<code>StarEntity</code>建立关系<br>第二个参数：<code>(star) =&gt; star.photo</code>，和哪个字段联立关系？ <code>star</code>就是<code>StarEntity</code>的别名，可随便写，和<code>PhotoEntity</code>的<code>followers</code>字段建立关系</p>
</blockquote>
<p>用户（粉丝）表：follows关注/跟随</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
  ManyToMany<span class="token punctuation">,</span>
  JoinTable<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AvatarEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./avatar.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'users'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersEntity</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">ManyToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> StarEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>star<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> star<span class="token punctuation">.</span>followers<span class="token punctuation">)</span>
  @<span class="token function">JoinTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  follows<span class="token punctuation">:</span> StarEntity<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 注意这里是数组类型
<span class="token punctuation">}</span></code></pre>
<p>明星表：followers跟随者</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Entity<span class="token punctuation">,</span> PrimaryGeneratedColumn<span class="token punctuation">,</span> Column<span class="token punctuation">,</span> ManyToMany <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'star'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">StarEntity</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'varchar'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  name<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">ManyToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> UsersEntity<span class="token punctuation">,</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> user<span class="token punctuation">.</span>follows<span class="token punctuation">)</span>
  followers<span class="token punctuation">:</span> UsersEntity<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>注意：</strong></p>
<blockquote>
<p>程序运行后，将会默认在数据库中生成三张表，users，star，users_follows_star，users_follows_star是中间表，用于记录users和star之间的多对多关系，它是自动生成的。</p>
</blockquote>
<p>为了测试方便，你可以在users表和star表创建一些数据：这些属于单表操作<br><img src="//static.tianyichuxin.com/images/29344/32.png" alt=""></p>
<h3 id="多对多增删改查"><a href="#多对多增删改查" class="headerlink" title="多对多增删改查"></a><strong>多对多增删改查</strong></h3><blockquote>
<p>只要涉及两种表操作的，就需要开启事务：同时失败或同时成功，避免数据不统一<br>注意：所有数据应该是由前端传递过来的，这里为了方便，直接硬编码了（写死）</p>
</blockquote>
<p>user.controller.ts</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  Patch<span class="token punctuation">,</span>
  Query<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  Delete<span class="token punctuation">,</span>
  HttpCode<span class="token punctuation">,</span>
  HttpStatus<span class="token punctuation">,</span>
  ParseIntPipe<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Transaction<span class="token punctuation">,</span> TransactionManager<span class="token punctuation">,</span> EntityManager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>  开启事务第一步：引入
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user.service-oto'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly userService<span class="token punctuation">:</span> UserService<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>data<span class="token punctuation">,</span> count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">HttpCode</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">)</span>
  @<span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 开启事务第二步：装饰接口
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
    @<span class="token function">TransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> maneger<span class="token punctuation">:</span> EntityManager<span class="token punctuation">,</span>  开启事务第三步：获取事务管理器
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> maneger<span class="token punctuation">)</span><span class="token punctuation">;</span>  开启事务第四步：传递给service，使用数据库时调用
  <span class="token punctuation">}</span>

  @<span class="token function">Patch</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
    @<span class="token function">TransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> maneger<span class="token punctuation">:</span> EntityManager<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> maneger<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
  @<span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseIntPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
    @<span class="token function">TransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> maneger<span class="token punctuation">:</span> EntityManager<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> maneger<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>user.service.ts</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository<span class="token punctuation">,</span> EntityManager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StarEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entities/star.entity'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> ToolsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../utils/tools.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span><span class="token punctuation">,</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>StarEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly starRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>StarEntity<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  一对多增删改查
  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// return await this.usersRepository.findAndCount({ relations: ['follows'] });</span>

    <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository
      <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'UsersEntity'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">'UsersEntity.follows'</span><span class="token punctuation">,</span> <span class="token string">'StarEntity.followers'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getManyAndCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  根据主表id查找多对多
  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    查询一个用户关注了哪些明星
    <span class="token comment" spellcheck="true">// const result = await this.usersRepository.findOne(id, {</span>
    <span class="token comment" spellcheck="true">//   relations: ['follows'],</span>
    <span class="token comment" spellcheck="true">// });</span>
    <span class="token comment" spellcheck="true">// if (!result) ToolsService.fail('用户id不存在');</span>
    <span class="token comment" spellcheck="true">// return result;</span>

    查询一个明星有多少粉丝
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>starRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      relations<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'followers'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'明星id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  根据主表id创建多对多
  粉丝关注明星
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> number<span class="token punctuation">,</span> manager<span class="token punctuation">:</span> EntityManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      要关注的明星id数组
    <span class="token keyword">const</span> willFollow <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>willFollow<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> followList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> willFollow<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> star <span class="token operator">=</span> <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>StarEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          id<span class="token punctuation">:</span> willFollow<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>star<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'主播id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        followList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>star<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> userEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsersEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      重点：
      不指定id是创建新的用户，还需要填写username和password等必填的字段
      指定id就是更新某些字段：只关注明星，不创建新的用户，同样可用于修改
      userEntity<span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span> 
      userEntity<span class="token punctuation">.</span>follows <span class="token operator">=</span> followList<span class="token punctuation">;</span> 建立关联，数据表会自动更新
      <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">'新增成功'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  根据主表id更改多对多
  假设：某用户关注了id为<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>的明星<span class="token punctuation">,</span> 现在修改为只关注<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
  逻辑和创建一样
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> number<span class="token punctuation">,</span> manager<span class="token punctuation">:</span> EntityManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> willFollow <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>willFollow<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> followList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> willFollow<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> listOne <span class="token operator">=</span> <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>StarEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          id<span class="token punctuation">:</span> willFollow<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listOne<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'主播id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        followList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>listOne<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> userEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsersEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      userEntity<span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
      userEntity<span class="token punctuation">.</span>follows <span class="token operator">=</span> followList<span class="token punctuation">;</span>
      <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">'更新成功'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  根据主表id删除多对多
  多种删除
  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> number<span class="token punctuation">,</span> manager<span class="token punctuation">:</span> EntityManager<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      relations<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'follows'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户id不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    根据id删除一个：取消关注某个明星，明星id应由前端传递过来，这里写死
    需要获取当前用户的的follows，使用关系查询
    <span class="token keyword">const</span> willDeleteId <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>follows<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      过滤掉要删除的数据，再重新赋值
      <span class="token keyword">const</span> followList <span class="token operator">=</span> user<span class="token punctuation">.</span>follows<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>star<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> star<span class="token punctuation">.</span>id <span class="token operator">!=</span> willDeleteId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> userEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsersEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      userEntity<span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
      userEntity<span class="token punctuation">.</span>follows <span class="token operator">=</span> followList<span class="token punctuation">;</span>
      <span class="token keyword">await</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    全部删除关联数据，不删用户
    <span class="token comment" spellcheck="true">// const userEntity = new UsersEntity();</span>
    <span class="token comment" spellcheck="true">// userEntity.id = id;</span>
    <span class="token comment" spellcheck="true">// userEntity.follows = [];</span>
    <span class="token comment" spellcheck="true">// await manager.save(userEntity);</span>

    如果连用户一起删，会将关联数据一起删除
    <span class="token comment" spellcheck="true">// await manager.delete(UsersEntity, id);</span>
    <span class="token keyword">return</span> <span class="token string">'删除成功'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="nest连接Redis"><a href="#nest连接Redis" class="headerlink" title="nest连接Redis"></a>nest连接Redis</h2><blockquote>
<p>Redis 字符串数据类型的相关命令用于管理 redis 字符串值</p>
</blockquote>
<ul>
<li>查看所有的key: <code>keys *</code></li>
<li>普通设置： <code>set key value</code></li>
<li>设置并加过期时间：<code>set key value EX 30</code> 表示30秒后过期</li>
<li>获取数据： <code>get key</code></li>
<li>删除指定数据：<code>del key</code></li>
<li>删除全部数据: <code>flushall</code></li>
<li>查看类型：<code>type key</code></li>
<li>设置过期时间: <code>expire key 20</code> 表示指定的<code>key5</code>秒后过期</li>
</ul>
<blockquote>
<p>Redis列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）</p>
</blockquote>
<ul>
<li>列表右侧增加值：<code>rpush key value</code></li>
<li>列表左侧增加值：<code>lpush key value</code></li>
<li>右侧删除值：<code>rpop key</code></li>
<li>左侧删除值： <code>lpop key</code></li>
<li>获取数据： <code>lrange key</code></li>
<li>删除指定数据：<code>del key</code></li>
<li>删除全部数据: <code>flushall</code></li>
<li>查看类型： <code>type key</code></li>
</ul>
<blockquote>
<p>Redis 的 Set 是 String 类型的无序集合。集合成员是唯一的，这就意味着集合中不能出现重复的数据。它和列表的最主要区别就是没法增加重复值</p>
</blockquote>
<ul>
<li>给集合增数据：<code>sadd key value</code></li>
<li>删除集合中的一个值：<code>srem key value</code></li>
<li>获取数据：<code>smembers key</code></li>
<li>删除指定数据： <code>del key</code></li>
<li>删除全部数据: <code>flushall</code></li>
</ul>
<blockquote>
<p>Redis hash 是一个string类型的field和value的映射表，hash特别适合用于存储对象。</p>
</blockquote>
<ul>
<li>设置值hmset ：<code>hmset zhangsan name "张三" age 20 sex “男”</code></li>
<li>设置值hset ： <code>hset zhangsan name "张三"</code></li>
<li>获取数据：<code>hgetall key</code></li>
<li>删除指定数据：<code>del key</code></li>
<li>删除全部数据: <code>flushall</code></li>
</ul>
<blockquote>
<p>Redis 发布订阅(pub/sub)是一种消息通信模式：发送者(pub)发送消息，订阅者(sub)接收消息</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 发布</span>
client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'publish'</span><span class="token punctuation">,</span> <span class="token string">'message from publish.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 订阅</span>
client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'publish'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'client.on message, channel:'</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token string">' message:'</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>Nestjs中使用redis</strong></p>
<blockquote>
<p>Nestjs Redis 官方文档：<a href="https://github.com/kyknow/nestjs-redis" target="_blank" rel="noopener">https://github.com/kyknow/nestjs-redis</a></p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> nestjs-redis --save</code></pre>
<p>如果是nest8需要注意该问题：<a href="https://github.com/skunight/nestjs-redis/issues/82" target="_blank" rel="noopener">https://github.com/skunight/nestjs-redis/issues/82</a></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// app.modules.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RedisModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'nestjs-redis'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RedisTestModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../examples/redis-test/redis-test.module'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment" spellcheck="true">// 加载配置文件目录</span>
    ConfigModule<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'**/!(*.d).{ts,js}'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// redis连接</span>
    RedisModule<span class="token punctuation">.</span><span class="token function">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      useFactory<span class="token punctuation">:</span> <span class="token punctuation">(</span>configService<span class="token punctuation">:</span> ConfigService<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> configService<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'redis'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      inject<span class="token punctuation">:</span> <span class="token punctuation">[</span>ConfigService<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    RedisTestModule<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token keyword">implements</span> <span class="token class-name">NestModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/config/redis.ts 配置</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  host<span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
  port<span class="token punctuation">:</span> <span class="token number">6379</span><span class="token punctuation">,</span>
  db<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  password<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  keyPrefix<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  onClientReady<span class="token punctuation">:</span> <span class="token punctuation">(</span>client<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-----redis error-----'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p><strong>创建一个cache.service.ts 服务 封装操作redis的方法</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/common/cache.service.ts </span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RedisService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'nestjs-redis'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CacheService</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> client<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> redisService<span class="token punctuation">:</span> RedisService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisService<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">//设置值的方法</span>
  <span class="token keyword">async</span> <span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> string<span class="token punctuation">,</span> value<span class="token punctuation">:</span> any<span class="token punctuation">,</span> seconds<span class="token operator">?</span><span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>seconds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">'EX'</span><span class="token punctuation">,</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">//获取值的方法</span>
  <span class="token keyword">async</span> <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 根据key删除redis缓存数据</span>
  <span class="token keyword">async</span> <span class="token function">del</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 清空redis的缓存</span>
  <span class="token keyword">async</span> <span class="token function">flushall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">flushall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p>使用redis服务</p>
</blockquote>
<p><strong>redis-test.controller</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Body<span class="token punctuation">,</span> Controller<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Query <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CacheService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'src/common/cache/redis.service'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'redis-test'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">RedisTestController</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 注入redis服务</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly cacheService<span class="token punctuation">:</span> CacheService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token keyword">get</span><span class="token punctuation">(</span>@<span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheService<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token keyword">set</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> <span class="token operator">...</span>params <span class="token punctuation">}</span> <span class="token operator">=</span> body <span class="token keyword">as</span> any<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheService<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">del</span><span class="token punctuation">(</span>@<span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheService<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'delAll'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">delAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheService<span class="token punctuation">.</span><span class="token function">flushall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>redis-test.module.ts</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RedisTestService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./redis-test.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RedisTestController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./redis-test.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CacheService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'src/common/cache/redis.service'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>RedisTestController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>RedisTestService<span class="token punctuation">,</span> CacheService<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 注入redis服务</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">RedisTestModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p><strong>redis-test.service.ts</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">RedisTestService</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<h2 id="集成redis实现单点登录"><a href="#集成redis实现单点登录" class="headerlink" title="集成redis实现单点登录"></a>集成redis实现单点登录</h2><p><strong>在要使用的controller或service中使用redis</strong></p>
<ul>
<li>这里以实现<code>token</code>存储在<code>redis</code>为例子，实现<strong>单点登录</strong></li>
<li>需要在<code>passport</code>的<code>login</code>中，存储<code>token</code>，如果不会<code>passport</code>验证</li>
</ul>
<p><strong>单点登录原理</strong></p>
<blockquote>
<ul>
<li>一个账户在第一个地方登录，登录时，JWT生成token，保存token到redis，同时返回token给前端保存到本地</li>
<li>同一账户在第二个地方登录，登录时，JWT生成新的token，保存新的token到redis。（token已经改变）<br>此时，第一个地方登录的账户在请求时，使用的本地token就会和redis里面的新token不一致（注意：都是有效的token）</li>
</ul>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> compareSync<span class="token punctuation">,</span> hashSync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'bcryptjs'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../user/entities/user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ToolsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../utils/tools.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreateUserDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../user/dto/create-user.dto'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CacheService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../common/db/redis-ceche.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>UsersEntity<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>UsersEntity<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> readonly jwtService<span class="token punctuation">:</span> JwtService<span class="token punctuation">,</span>
    <span class="token keyword">private</span> readonly redisService<span class="token punctuation">:</span> CacheService<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> CreateUserDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token keyword">const</span> transformPass <span class="token operator">=</span> <span class="token function">hashSync</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span>password <span class="token operator">=</span> transformPass<span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户名已存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validateUser</span><span class="token punctuation">(</span>userinfo<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> userinfo<span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token punctuation">:</span> <span class="token punctuation">{</span> username <span class="token punctuation">}</span><span class="token punctuation">,</span>
      select<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户名或密码不正确'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//使用bcryptjs验证密码</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'用户名或密码不正确'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> username <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> username <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> access_token <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtService<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisService<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`user-token-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> access_token<span class="token punctuation">,</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  在这里使用redis
    <span class="token keyword">return</span> access_token<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><img src="//static.tianyichuxin.com/images/29344/33.png" alt=""></p>
<p><strong>验证token</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Strategy<span class="token punctuation">,</span> ExtractJwt<span class="token punctuation">,</span> StrategyOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'passport-jwt'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> jwtConstants <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CacheService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../common/db/redis-ceche.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Request <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ToolsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../utils/tools.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JwtStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> redisService<span class="token punctuation">:</span> CacheService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      jwtFromRequest<span class="token punctuation">:</span> ExtractJwt<span class="token punctuation">.</span><span class="token function">fromHeader</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//使用ExtractJwt.fromHeader从header获取token</span>
      ignoreExpiration<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//如果为true，则不验证令牌的过期时间。</span>
      secretOrKey<span class="token punctuation">:</span> jwtConstants<span class="token punctuation">.</span>secret<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//使用密钥解析，可以使用process.env.xxx</span>
      passReqToCallback<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token keyword">as</span> StrategyOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">//token验证, payload是super中已经解析好的token信息</span>
  <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> payload<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'payload'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> payload<span class="token punctuation">;</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> ExtractJwt<span class="token punctuation">.</span><span class="token function">fromHeader</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cacheToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisService<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`user-token-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  获取redis的key

    <span class="token comment" spellcheck="true">//单点登录验证</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!==</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>cacheToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ToolsService<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'您账户已经在另一处登录，请重新登录'</span><span class="token punctuation">,</span> <span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> username<span class="token punctuation">:</span> payload<span class="token punctuation">.</span>username <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h1 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h1><h3 id="Q：nestJS注入其他依赖时为什么还需要导入其module"><a href="#Q：nestJS注入其他依赖时为什么还需要导入其module" class="headerlink" title="Q：nestJS注入其他依赖时为什么还需要导入其module"></a>Q：nestJS注入其他依赖时为什么还需要导入其module</h3><blockquote>
<p>A模块的Service需要调用B模块的service中一个方法，则需要在A的Service导入B的service<br>场景如下：</p>
</blockquote>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// A.Service</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../B/B.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> readonly _BService<span class="token punctuation">:</span> BService<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>我的理解</p>
<ul>
<li>在此处@Injectable装饰器已经将B的Service类实例化了，</li>
<li>已经可以使用B的类方法了。</li>
<li>但为什么还需要在A的module.ts中导入B模块呢？像是这样:</li>
</ul>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// A.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../B/B.module'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>BModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AService<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token punctuation">:</span> <span class="token punctuation">[</span>AService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p><strong>A</strong></p>
<p>为啥”为什么还需要在A的module.ts中导入B模块呢”？</p>
<p>因为 <code>BService</code>的作用域只在 <code>BModule</code>里，所以你要在 <code>AController</code>里直接用，就会报错拿不到实例。</p>
<p>再来说，”有什么办法可以让 <code>BService</code>随处直接用么？”，参考如下手段：</p>
<p>B 的module 声明时，加上<code>@Global</code>，如下：</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Module<span class="token punctuation">,</span> Global <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./B.service'</span><span class="token punctuation">;</span>

@<span class="token function">Global</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>BService<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token punctuation">:</span> <span class="token punctuation">[</span>BService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p>这样，你就不用在 <code>AModule</code>的声明里引入 <code>BModule</code>了。</p>
<p>关于『你的理解』部分，貌似你把<code>@Inject</code> 和 <code>@Injectable</code> 搞混了，建议再读一读这个部分的文档，多做些练习/尝试，自己感受下每个api的特点。</p>
<p>最后，官网文档里其实有介绍 ，看<code>依赖注入</code>:<a href="https://docs.nestjs.com/modules#dependency-injection" target="_blank" rel="noopener">https://docs.nestjs.com/modules#dependency-injection</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">弈心</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://blog.tianyichuxin.com/2024/08/29344.html">https://blog.tianyichuxin.com/2024/08/29344.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">弈心</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/node/">
                                    <span class="chip bg-color">node</span>
                                </a>
                            
                                <a href="/tags/nest-js/">
                                    <span class="chip bg-color">nest.js</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'Pz2erXCl206N7RaqUeABaxY5-gzGzoHsz',
        appKey: 'jK6ogq40WtwTaW0p3l097QhN',
        notify: 'false' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '说点什么再走吧'
    });
</script>

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/08/19114.html">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="forever的安装与简单使用">
                        
                        <span class="card-title">forever的安装与简单使用</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            forever的安装与简单使用
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-08-27
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/node/" class="post-category">
                                    node
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/foreve/">
                        <span class="chip bg-color">foreve</span>
                    </a>
                    
                    <a href="/tags/nodejs/">
                        <span class="chip bg-color">nodejs</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/07/49497.html">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/16.jpg" class="responsive-img" alt="使用View Transitions实现Element Plus的炫酷主题切换">
                        
                        <span class="card-title">使用View Transitions实现Element Plus的炫酷主题切换</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            使用View Transitions实现Element Plus的炫酷主题切换
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-07-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/web/" class="post-category">
                                    web
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CSS/">
                        <span class="chip bg-color">CSS</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 天弈初心<br />'
            + '文章作者: 弈心<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
<div class="_fogwnirvpfw" id="_fogwnirvpfw"></div>
<script type="text/javascript">
    (window.slotbydup = window.slotbydup || []).push({
        id: "u6938726",
        container: "_fogwnirvpfw",
        async: true
    });
</script>
<div class="_s210mav3xgf" id="_s210mav3xgf"></div>
<script type="text/javascript">
    (window.slotbydup = window.slotbydup || []).push({
        id: "u6938735",
        container: "_s210mav3xgf",
        async: true
    });
</script>

<!-- 多条广告如下脚本只需引入一次 -->
<script type="text/javascript" src="//cpro.baidustatic.com/cpro/ui/cm.js" async="async" defer="defer" >
</script>
    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<!-- <script src="https://fastly.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script> -->
<script src="https://static.tianyichuxin.com/assets/npm/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2018</span>
            <a href="/about" target="_blank">弈心</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">364.4k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2018";
                    var startMonth = "1";
                    var startDate = "1";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
            <span id="icp"><img src="/medias/icp.png" style="vertical-align: text-bottom;" />
                <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=42018502006491" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;margin-right: 10px;">鄂公网安备 42018502006491号</a>
                <a href="https://beian.miit.gov.cn" target="_blank">鄂ICP备19020385号</a>
            </span>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/tianyichuxin" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:535399046@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=535399046" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 535399046" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="" class="tooltipped" target="_blank" data-tooltip="关注我的微信公众号: tianyichuxin2025" data-position="top" data-delay="50">
        <i class="fab fa-weixin"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>

    <link rel="stylesheet" type="text/css" href="http://static.tianyichuxin.com/assets/live2D/css/waifu.css" />
    <link rel="stylesheet" type="text/css" href="http://static.tianyichuxin.com/assets/live2D/css/flat-ui.min.css" />
    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>');
            }
        </script>
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    
	<div class="waifu">
		<!-- 提示框 -->
		<!-- <div class="waifu-tips"></div> -->

		<!-- 看板娘画布 -->
		<!-- <canvas id="live2d" class="live2d" width="280" height="250"></canvas> -->

		<!-- 工具栏 -->
		<!-- <div class="waifu-tool">
			<span class="fui-home"></span>
			<span class="fui-chat"></span>
			<span class="fui-eye"></span>
			<span class="fui-user"></span>
			<span class="fui-photo"></span>
			<span class="fui-info-circle"></span>
			<span class="fui-cross"></span>
		</div> -->
	</div>
</body>
</html>
<!-- 右下角人物和鼠标点击 -->
<!-- <script src="http://static.tianyichuxin.com/assets/live2D/js/waifu--tips.js"></script> -->
<!-- <script src="http://static.tianyichuxin.com/assets/live2D/js/live2d.js"></script> -->
<!-- 小姐姐 -->
<!-- <script src="http://static.tianyichuxin.com/assets/live2D/js/L2Dwidget.min.js"></script> -->
<!-- <script src="https://eqcn.ajz.miesnfu.com/wp-content/plugins/wp-3d-pony/live2dw/lib/L2Dwidget.min.js"></script> -->
<!-- 鼠标点击 -->
<script src="http://static.tianyichuxin.com/assets/live2D/js/mouse.js"></script>
<script type="text/javascript">
    // /* 可直接修改部分参数 */
    // live2d_settings['modelId'] = 5; // 默认模型 ID
    // live2d_settings['modelTexturesId'] = 1; // 默认材质 ID
    // /* 在 initModel 前添加 */
    // initModel("http://static.tianyichuxin.com/assets/live2D/js/waifu-tips.json")
</script>